<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="app-version" content="dev • 2025-10-07 15:21:38">
    <title>Календарь Настроения</title>
    
    
    <meta name="theme-color" content="#4F46E5">
    <meta name="description" content="Отслеживайте свое настроение каждый день">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Календарь Настроения">
    
    
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi0JrQsNC70LXQvdC00LDRgNGMINCd0LDRgdGC0YDQvtC10L3QuNGPIiwic2hvcnRfbmFtZSI6ItCa0LDQu9C10L3QtNCw0YDRjCIsImRlc2NyaXB0aW9uIjoi0J7RgtGB0LvQtdC20LjQstCw0LnRgtC1INGB0LLQvtC1INC90LDRgdGC0YDQvtC10L3QuNC1INC60LDQttC00YvQuSDQtNC10L3RjCIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjNEY0NkU1IiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0Nzdmcgdmlld0JveD0nMCAwIDEwMCAxMDAnIGZpbGw9JyUyMzRGNDZFNScgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyUzRSUzQ3JlY3Qgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIHJ4PScxMCcvJTNFJTNDdGV4dCB4PSc1MCcgeT0nNTAnIGZvbnQtc2l6ZT0nNDAnIGZpbGw9J3doaXRlJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBkeT0nLjNlbSclM0Xwn5OBJTNFL3RleHQlM0UlM0Mvc3ZnJTNFIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    
    
    <link rel="stylesheet" href="styles/tokens.css?v=__BUILD_ID__">
    <link rel="stylesheet" href="styles/components.css?v=__BUILD_ID__">
    
    <style>
        
      * { margin: 0; padding: 0; box-sizing: border-box; }


        html,
        body {
            color: var(--text-primary);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 8px;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

         .app-header {
          background: linear-gradient(135deg, var(--brand), var(--brand-2));
          padding: 16px 20px;
          color: var(--text-primary);
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 16px;
          border-radius: 16px;
          box-shadow: 0 10px 26px rgba(79, 70, 229, 0.2);
        }

        .header-left {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        .header-right {
          display: flex;
          align-items: center;
          gap: 12px;
          padding-right: 8px;
        }

        .app-header,
        .header-right,
        .weekday-row span,
        .calendar,
        .calendar .day {
          color: var(--text-primary);
        }

        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
        }

        .month-nav__title-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            text-align: center;
        }

        .month-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .theme-toggle {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: 4px;
          border-radius: 999px;
          background: var(--palette-surface-variant);
          border: 1px solid rgba(0,0,0,.08);
          margin-right: 8px;
        }

        .theme-toggle__knob {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 8px 12px;
          border-radius: 999px;
          border: 1px solid rgba(0,0,0,.12);
          background: var(--palette-surface);
          color: var(--text-primary);
          font-weight: 600;
          cursor: pointer;
          transition: transform .12s ease, box-shadow .12s ease;
        }

        .theme-toggle__knob:focus-visible {
          outline: none;
          box-shadow: 0 0 0 3px color-mix(in srgb, var(--brand) 25%, transparent);
        }

        [data-theme="dark"] .theme-toggle {
          border-color: rgba(255,255,255,.06);
        }

        [data-theme="dark"] .theme-toggle__knob {
          background: var(--palette-surface-variant);
          color: var(--text-primary);
          border-color: rgba(255,255,255,.08);
        }

        [data-theme="dark"] .theme-toggle__label {
          color: var(--text-primary);
        }


        .theme-toggle__knob:active {
          transform: scale(.98);
        }

        .theme-toggle__icon {
          font-size: 16px;
          line-height: 1;
        }

         .theme-toggle__label {
          display: inline;
          font-size: 14px;
          color: var(--text-primary);
        }

        .calendar {
            padding: 20px;
        }

        .today-score {
          --today-color: var(--bucket-zero);
          display: inline-flex;
          align-items: center;
          gap: .5rem;
          padding: 6px 12px;
          border-radius: 999px;
          border: 2px solid var(--today-color);
          background: var(--today-color);
          color: var(--calendar-text-contrasted);
          font-weight: 700;
        }
        .today-score.hidden{ display:none; }

        .week { gap: 6px; }

        .calendar .day {
          box-shadow:
            inset 0 1px 0 rgba(255,255,255,0.05),
            0 0 0 1px rgba(0,0,0,0.40);
        }

       .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .weekday {
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 12px 4px;
        }

       .calendar .day {
            animation: dayFadeIn 0.3s ease;
        }

        .stats {
          padding: 20px;
          border-top: 1px solid var(--border);
          background: var(--surface-2);
        }


        .stats h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
            margin-bottom: 12px;
            padding: 8px 0;
        }
        
            .stat-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-value {
            font-weight: 700;
            font-size: 16px;
            color: var(--text-primary);
        }

        .total-records {
            font-size: 13px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .mood-popup {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .mood-popup-content {
            background: var(--surface-2);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 380px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            transform: scale(0.9);
            animation: popupAppear 0.3s ease forwards;
        }

        @keyframes popupAppear {
            to {
                transform: scale(1);
            }
        }

        .mood-popup h3 {
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 16px;
            color: var(--text);
        }

        .mood-popup p {
            font-size: 15px;
            color: var(--text-muted);
            text-align: center;
            margin-bottom: 28px;
        }

        .mood-buttons {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .mood-btn {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            border: 2px solid;
            border-radius: 16px;
            background: var(--surface-2);
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            width: 100%;
        }

        .mood-btn:hover, .mood-btn:active {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .mood-emoji {
            font-size: 28px;
        }

        .skip-btn {
            width: 100%;
            margin-top: 20px;
            color: #64748b;
            font-size: 15px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 12px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .skip-btn:hover, .skip-btn:active {
            color: #1e293b;
            background: #f1f5f9;
        }

        .install-prompt {
            padding: 16px 20px;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 1px solid #93c5fd;
            margin: 16px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .hidden {
            display: none !important;
        }

        /* Нижняя навигация */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 400px;
            background: var(--bg-secondary);
            border-top: 2px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* Чуть более крупная кнопка */
        .btn--xl{
          padding: 14px 20px;
          font-size: 16px;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 12px;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .nav-item.active {
            color: var(--mood-good);
            background: var(--bg-primary);
        }

        .nav-item:hover {
            background: var(--bg-primary);
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        /* Отступ снизу для навигации */
        .app-container {
            max-width: 400px;
            margin: 0 auto;
            background: var(--bg-secondary);
            border-radius: 16px 16px 0 0;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            min-height: calc(100vh - 16px);
            margin-bottom: 0;
            padding-bottom: calc(var(--nav-height) + 24px);    /* запас под нижнюю навигацию */
            min-height: 100vh; 
            transition: background-color 0.3s ease;
            position: relative; /* добавляем для лучшего позиционирования */
        }
        .bottom-nav{
          box-shadow: 0 -6px 18px rgba(0,0,0,.06);
        }
        /* Страница статистики */

        .stats-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .correlation-section, .overview-section {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }

        .correlation-section h3, .overview-section h3 {
            margin-bottom: 12px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .hourly-chart {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            margin-top: 12px;
        }

        .hour-block {
            text-align: center;
            padding: 8px 4px;
            border-radius: 8px;
            font-size: 11px;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }


        .calendar-page {
            display: block;
        }

        .calendar-page.hidden {
            display: none;
        }

        /* === ЧАТ СТРАНИЦА === */
        .chat-page {
            display: none;
            flex-direction: column;
            height: calc(100vh - 240px); /* увеличиваем отступ для header и bottom-nav */
            max-height: calc(100vh - 240px);
        }

        .chat-page.active {
            display: flex;
        }

        .chat-header {
            background: var(--bg-primary);
            padding: 20px;
            border-bottom: 2px solid var(--border-color);
            text-align: center;
        }

        .chat-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .chat-header p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }


        .chat-disclaimer {
            padding: 8px 20px;
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
        }

        /* Анимации */
      .calendar .day {
            animation: dayFadeIn 0.3s ease;
        }

        @keyframes dayFadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
    
    <div class="app-container">
        
        <div id="installPrompt" class="install-prompt hidden">
            <p><strong>📱 Добавьте приложение на главный экран!</strong></p>
            <p style="font-size: 14px; margin-top: 8px; color: #64748b;">
                Нажмите меню браузера → "Добавить на главный экран"
            </p>
            <button id="enableNotifications" class="btn btn--ghost">🔔 Включить уведомления</button>
        </div>

        <header class="app-header">
          <div class="header-left"></div>

          <div class="header-right">
            <div id="todayScoreBadge" class="today-score hidden" aria-live="polite"></div>

            <div class="theme-toggle" role="group" aria-label="Переключить тему">
              <button id="themeToggle" class="theme-toggle__knob" type="button" aria-pressed="false" title="Сменить тему">
                <span class="theme-toggle__icon theme-toggle__icon--moon" aria-hidden="true">🌙</span>
                <span class="theme-toggle__label">Тема</span>
                <span class="theme-toggle__icon theme-toggle__icon--sun" aria-hidden="true">☀️</span>
              </button>
            </div>
          </div>
        </header>
        
        <div class="calendar-page" id="calendarPage">
          <div class="month-nav">
                <button class="btn btn--ghost btn--icon" onclick="navigateMonth(-1)">←</button>
                <div class="month-nav__title-group">
                    <div class="month-title" id="monthTitle"></div>
                </div>
                <button class="btn btn--ghost btn--icon" onclick="navigateMonth(1)">→</button>
          </div>

            <div class="calendar">
                 <div class="weekdays">
                    <div class="weekday">Вс</div>
                    <div class="weekday">Пн</div>
                    <div class="weekday">Вт</div>
                    <div class="weekday">Ср</div>
                    <div class="weekday">Чт</div>
                    <div class="weekday">Пт</div>
                    <div class="weekday">Сб</div>
                </div>
                <div id="calendarDays"></div>
             </div>

         <div class="calendar-cta">
            <!-- Ряд из 5 смайлов для быстрого выбора настроения -->
            <button id="recordMoodBtn" class="btn btn--primary btn--xl" onclick="openMoodSlider()">
                Записать настроение
            </button>
            <!-- Кнопка статистики остаётся внизу -->
            <button class="btn btn--primary btn--xl" onclick="openStats()">📊 Статистика</button>
          </div>
        </div>

<!-- Stats: одна корректная модалка -->
        <div id="statsSheet" class="sheet" hidden>
          <div class="sheet__backdrop" onclick="closeStats()"></div>
        
          <div class="sheet__panel" id="statsPanel" role="dialog" aria-modal="true" aria-labelledby="statsTitle">
            <div class="sheet__header">
              <h3 id="statsTitle">📈 Статистика</h3>
              <button class="sheet__close btn btn--ghost" aria-label="Закрыть" onclick="closeStats()">✕</button>
            </div>
        
            <div id="statsBody" style="display:grid; gap:12px;">
              <div class="stats-filters">
                <button class="filter-btn active" onclick="setStatsFilter('3days')">3 дня</button>
                <button class="filter-btn" onclick="setStatsFilter('week')">Неделя</button>
                <button class="filter-btn" onclick="setStatsFilter('month')">Месяц</button>
                <button class="filter-btn" onclick="setStatsFilter('all')">Все время</button>
              </div>
        
              <div class="correlation-section">
                <h3>📊 Настроение сегодня по часам</h3>
                <div id="hourlyChart" class="hourly-chart"></div>
                <p style="font-size:12px; color:var(--text-secondary); text-align:center; margin-top:6px;">
                  Нажмите на час, чтобы увидеть записи
                </p>
              </div>
        
              <div class="overview-section">
                <h3>📈 Общая статистика (<span id="currentPeriod">3 дня</span>)</h3>
                <div class="stat-row"><span class="stat-label">Хорошие записи:</span><span class="stat-value stat-value--good" id="statsGoodPercent">0%</span></div>
                <div class="stat-row"><span class="stat-label">Нейтральные записи:</span><span class="stat-value stat-value--neutral" id="statsNeutralPercent">0%</span></div>
                <div class="stat-row"><span class="stat-label">Грустные записи:</span><span class="stat-value stat-value--sad" id="statsSadPercent">0%</span></div>
                <div class="total-records" id="statsTotalRecords">Всего записей: 0</div>
                <div class="stat-row"><span class="stat-label">Записей в день:</span><span class="stat-value" id="avgPerDay">0</span></div>
                <div class="stat-row"><span class="stat-label">Активных дней:</span><span class="stat-value" id="activeDays">0</span></div>
              </div>
            </div>
        
            <button class="btn btn--ghost" style="margin-top:8px; width:100%;" onclick="closeStats()">Закрыть</button>
          </div>
        </div>
        
        <div class="chat-page" id="chatPage">
          <div class="chat-header">
            <h2>ИИ Чат</h2>
            <p>Спросите совет или поделитесь, как вы сейчас.</p>
          </div>
        
          <div id="chatMessages" class="chat-messages"></div>
        
          <div class="chat-input-container">
            <textarea id="chatInput" class="chat-input" placeholder="Напишите сообщение..." rows="1"></textarea>
            <button id="sendButton" class="send-button" onclick="sendMessage()" disabled>➤</button>
          </div>
          <div class="chat-disclaimer">Это не медицинская помощь. При рисках — звоните в экстренные службы.</div>
        </div>
                <!-- ===== Страница ПОМОЩЬ ===== -->
        <div class="help-page" id="helpPage" style="display:none;">
          <div class="chat-header">
            <h2>Помощь</h2>
            <p>Выберите раздел:</p>
          </div>
        
          <div class="section-grid">
            <button class="card section-card" onclick="switchPage('therapy')">
              <div class="section-emoji">🧘‍♀️</div>
              <div class="section-title">Терапия</div>
              <div class="section-sub">Дыхательные и успокаивающие практики</div>
            </button>
        
            <button class="card section-card" onclick="switchPage('tests')">
              <div class="section-emoji">🧩</div>
              <div class="section-title">Тесты</div>
              <div class="section-sub">Оценка настроения, выгорания, личности</div>
            </button>
          </div>
        </div>
        
        <!-- ===== Страница ТЕРАПИЯ ===== -->
        <div class="therapy-page" id="therapyPage" style="display:none;">
          <div class="chat-header">
            <h2>Терапевтические практики</h2>
            <p>Простые техники на каждый день</p>
          </div>
        
          <div class="content-list">
            <div class="card">
              <h3 style="margin-bottom:8px;">Дыхание 4–7–8</h3>
              <p>Вдох 4 сек → задержка 7 сек → выдох 8 сек. Повторить 4–6 кругов.</p>
                    <button class="btn btn--primary" onclick="PracticeEngine.openById('478')">Запустить</button>
            </div>
        
            <div class="card">
              <h3 style="margin-bottom:8px;">Заземление 5-4-3-2-1</h3>
              <p>Назовите: 5 что видите, 4 что ощущаете, 3 звука, 2 запаха, 1 вкус.</p>
                     <button class="btn btn--primary" onclick="PracticeEngine.openById('54321')">Запустить</button>
            </div>
          </div>
            
        </div>
        
        <!-- ===== Страница ТЕСТЫ ===== -->
        <div class="tests-page" id="testsPage" style="display:none;">
          <div class="chat-header">
            <h2>Психологические тесты</h2>
            <p>Быстрые скрининги и опросники</p>
          </div>
        
          <div class="content-list">
            <div class="card">
              <h3 style="margin-bottom:8px;">PHQ-2 (скрининг депрессии)</h3>
              <p>2 вопроса, ~30 секунд. Не заменяет диагноз.</p>
              <button class="btn btn--primary" style="margin-top:12px;" onclick="openTest('phq2')">Пройти</button>
            </div>
        
            <div class="card">
              <h3 style="margin-bottom:8px;">GAD-2 (скрининг тревоги)</h3>
              <p>2 вопроса, ~30 секунд. Не заменяет диагноз.</p>
              <button class="btn btn--primary" style="margin-top:12px;" onclick="openTest('gad2')">Пройти</button>
            </div>
          </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            
            <button class="nav-item active" id="navCalendar" onclick="switchPage('calendar')">
                <div class="nav-icon">📅</div>
                <div>Календарь</div>
            </button>
            
            <button class="nav-item" id="navChat" onclick="switchPage('chat')">
                <div class="nav-icon">🤖</div>
                <div>ИИ Чат</div>
            </button>

            <button class="nav-item" id="navHelp" onclick="switchPage('help')">
              <div class="nav-icon">🆘</div>
              <div>Помощь</div>
            </button>
            
        </div>
    </div>
    

<!-- ===== Therapy Modal ===== -->
        <div id="therapyPopup" class="mood-popup hidden">
          <div class="mood-popup-content" style="max-width:420px">
            <h3 id="therapyTitle">Терапия</h3>
            <p id="therapySubtitle">Описание практики</p>
        
            <div class="thermo">
              <div class="ring" id="thermoRing">
                <div class="ring-inner">
                  <div id="thermoPhase" class="phase">Готовы?</div>
                  <div id="thermoTime" class="time">00</div>
                </div>
              </div>
            </div>
        
            <div id="therapyHint" class="therapy-hint"></div>
        
            <div class="therapy-actions">
              <button class="btn btn--primary" id="therapyStartBtn">▶ Запустить</button>
              <button class="btn" id="therapyStopBtn">⏹ Остановить</button>
            </div>
        
            <button class="skip-btn" onclick="closeTherapy()">Закрыть</button>
          </div>
        </div>

        <!-- ===== Test Modal ===== -->
        <div id="testPopup" class="mood-popup hidden">
          <div class="mood-popup-content" style="max-width:520px">
            <h3 id="testTitle">Тест</h3>
            <p id="testDesc">Короткий скрининг</p>
        
            <div id="testFormHost" style="display:grid; gap:12px; margin:12px 0;"></div>
        
            <div class="therapy-actions" style="margin-top:4px;">
              <button class="btn btn--primary" id="testSubmitBtn">Готово</button>
              <button class="btn" id="testCancelBtn">Отмена</button>
            </div>
        
            <button class="skip-btn" onclick="closeTest()">Закрыть</button>
          </div>
        </div>

       <div id="moodSliderPopup" class="mood-popup hidden">
          <div class="mood-popup-content">
            <h3>Как вы себя чувствуете?</h3>

            <div class="mood-range-row">
              <!-- СЛЕВА — грустный -->
              <span class="mood-emoji" aria-hidden="true" title="Плохо">😢</span>

              <input
                id="moodSlider"
                type="range"
                min="-5" max="5" step="1" value="0"
                class="mood-range"
                aria-label="Ползунок настроения от −5 до +5">

              <!-- СПРАВА — счастливый -->
              <span class="mood-emoji" aria-hidden="true" title="Хорошо">😄</span>
            </div>

            <div class="mood-actions">
              <button class="btn btn--primary" onclick="confirmMoodScore()">Подтвердить</button>
              <button class="link-btn" onclick="closeMoodSlider()">Закрыть</button>
            </div>
          </div>
        </div>


       <script>
           
    window.PRACTICES = [
      {
        id: "478",
        title: "Дыхание 4–7–8",
        subtitle: "Вдох 4 сек → задержка 7 → выдох 8. Повторим 4 круга.",
        type: "timer",
        cycles: 4,
        phases: [
          { name: "Вдох",     seconds: 4, hint: "Медленный вдох носом" },
          { name: "Задержка", seconds: 7, hint: "Не дышим, спокойно"   },
          { name: "Выдох",    seconds: 8, hint: "Длинный выдох ртом"   }
        ]
      },
      {
        id: "54321",
        title: "Заземление 5-4-3-2-1",
        subtitle: "Назовите: 5 вижу, 4 ощущаю, 3 слышу, 2 запаха, 1 вкус.",
        type: "steps",
        steps: [
          "Назовите 5 вещей, которые вы видите.",
          "Назовите 4 вещи, которые ощущаете телом.",
          "Назовите 3 звука, которые слышите.",
          "Назовите 2 запаха.",
          "Назовите 1 вкус (или сделайте глоток воды)."
        ]
      }
    ];
    </script>

        <script>
    (function () {
      // Публичное API
      window.PracticeEngine = {
        openById(id) {
          const cfg = (window.PRACTICES || []).find(p => p.id === id);
          if (!cfg) return console.warn("[practice] not found", id);
          openModal(cfg);
        }
      };
    
      let timer = null;
      let state = null;
    
      function openModal(cfg) {
        state = {
          cfg,
          running: false,
          paused: false,   // ← флаг паузы
          cycle: 0,
          phaseIndex: 0,   // ← индекс текущей фазы (вдох/задержка/выдох)
          left: 0,         // ← оставшиеся секунды в фазе
          step: 0
        };
    
        // Заголовки
        setText('therapyTitle', cfg.title);
        setText('therapySubtitle', cfg.subtitle);
    
        // Видимость таймера: только для type: "timer"
        setTimeVisible(cfg.type === "timer");
        setTime("");               // ничего не показываем по умолчанию
        setPhase("Готовы?");
        setHint("");
        setRing(0);
    
        // Кнопки
        byId('therapyStartBtn').onclick = start;
        byId('therapyStopBtn').onclick  = stop;
        byId('therapyStartBtn').textContent = "Запустить"; 
    
        // Показать модалку
        byId('therapyPopup').classList.remove('hidden');
        document.body.classList.add('modal-open');
      }
    
    function start() {
      // НЕ сбрасываем state, только снимаем паузу
      state.running = true;
      state.paused  = false;
    
      const { cfg } = state;
    
      if (cfg.type === "timer") {
        setTimeVisible(true);
        // если есть, продолжаем с текущей фазы и остатка
        if (state.left > 0) {
          continueTimerPhase();
        } else {
          // запуск с самого начала
          state.cycle = 0;
          state.phaseIndex = 0;
          runTimerCycle();
        }
      } 
          else if (cfg.type === "steps") {
            setTimeVisible(false);
            // если уже были на шаге — просто продолжим его
            showStep();
      }
    }

        function stop() {
      if (timer) { clearInterval(timer); timer = null; }
      if (!state) return;
    
      state.running = false;
      state.paused  = true;
    
      setPhase("Пауза");
      setHint("");
      // кольцо/время оставляем как есть — видно, где остановились
    
      const startBtn = byId('therapyStartBtn');
    
      if (state.cfg.type === "steps") {
        setTimeVisible(false);
        startBtn.textContent = "Продолжить";
        startBtn.onclick = () => { state.running = true; state.paused = false; showStep(); };
      } else {
        // timer
        setTimeVisible(true);
        startBtn.textContent = "Продолжить";
        startBtn.onclick = start; // возобновит с текущих phaseIndex/left
      }
    }

      // ===== timer-практики (фазы × циклы)
    // ЗАМЕНА runTimerCycle целиком
    function runTimerCycle() {
      const { cfg } = state;
      if (!state.running) return;
    
      // закончили все циклы
      if (state.cycle >= (cfg.cycles || 1)) {
        setPhase("Готово!");
        setTime("");
        setHint("Отлично ✨");
        setRing(360);
        return;
      }
    
      // если фазы закончились — следующий цикл
      if (state.phaseIndex >= cfg.phases.length) {
        state.cycle++;
        state.phaseIndex = 0;
      }
    
      continueTimerPhase(); // перейти/продолжить текущую фазу
    }
    
    // НОВАЯ функция — вставь сразу после runTimerCycle
    function continueTimerPhase() {
      const { cfg } = state;
      if (!state.running) return;
    
      const phase = cfg.phases[state.phaseIndex];
      if (!phase) { runTimerCycle(); return; }
    
      // если запускаем впервые/после перехода — заполняем left
      if (!state.left || state.left <= 0) {
        state.left = phase.seconds;
      }
    
      setPhase(`${phase.name} (цикл ${state.cycle + 1}/${cfg.cycles || 1})`);
      setHint(phase.hint || "");
      setRing(360 * (1 - state.left / phase.seconds));
      setTime(state.left);
    
      if (timer) clearInterval(timer);
      timer = setInterval(() => {
        if (!state.running) { clearInterval(timer); timer = null; return; }
    
        state.left--;
        setTime(Math.max(state.left, 0));
    
        const done = (phase.seconds - state.left) / phase.seconds;
        setRing(Math.min(360 * done, 360));
    
        if (state.left <= 0) {
          clearInterval(timer); timer = null;
          setRing(360);
          // переходим к следующей фазе
          state.phaseIndex++;
          state.left = 0;
          setTimeout(runTimerCycle, 180);
        }
      }, 1000);
    }

    
      // ===== step-практики (пошаговые подсказки, без таймера)
      function showStep() {
        const { cfg } = state;
        if (!state.running) return;
    
        if (state.step >= cfg.steps.length) {
          setPhase("Готово!");
          setTime("");             // НЕ показываем цифры
          setHint("Вы молодец ✨");
          setRing(360);
          return;
        }
    
        setPhase(`Шаг ${state.step + 1}/${cfg.steps.length}`);
        setHint(cfg.steps[state.step]);
        setRing(0);
    
        // Кнопка «Далее/Завершить»
        const startBtn = byId('therapyStartBtn');
        startBtn.textContent = (state.step < cfg.steps.length - 1) ? "Далее" : "Завершить";
        startBtn.onclick = () => { state.step++; showStep(); };
      }
    
      // ===== helpers (UI)
      function setPhase(t){ setText('thermoPhase', t); }
      function setTime(v){  setText('thermoTime', v === "" ? "" : String(v).padStart(2,"0")); }
      function setHint(t){  setText('therapyHint', t || ""); }
      function setRing(deg){
        const ring = byId('thermoRing'); if (!ring) return;
        const brand = getComputedStyle(document.documentElement).getPropertyValue("--brand").trim();
        ring.style.background = `conic-gradient(${brand} ${deg}deg, rgba(0,0,0,0.08) 0)`;
      }
      function setTimeVisible(show){
        const el = byId('thermoTime');
        if (el) el.style.display = show ? '' : 'none';
      }
      function setText(id, txt){ const el = byId(id); if (el) el.textContent = txt; }
      function byId(id){ return document.getElementById(id); }
    
      // Закрытие модалки
      window.closeTherapy = function(){
        stop();
        byId('therapyPopup')?.classList.add('hidden');
        document.body.classList.remove('modal-open');
      };
    })();
    </script>

    
    <script>
    window.TESTS = [
      {
        id: "phq2",
        title: "PHQ-2 (скрининг депрессии)",
        description: "2 вопроса, ~30 сек. Не заменяет диагноз.",
        scale: [ "Никогда", "Несколько дней", "Более половины дней", "Почти каждый день" ],
        questions: [
          "За последние 2 недели — мало интереса или радости от того, что вы делаете?",
          "За последние 2 недели — подавленное, угнетённое настроение?"
        ],
        scoring: { 0:0, 1:1, 2:2, 3:3 },
        resultText(score){ return score >= 3 ? "Положительный скрининг (обсудите с врачом)." : "Отрицательный скрининг."; }
      },
      {
        id: "gad2",
        title: "GAD-2 (скрининг тревоги)",
        description: "2 вопроса, ~30 сек. Не заменяет диагноз.",
        scale: [ "Никогда", "Несколько дней", "Более половины дней", "Почти каждый день" ],
        questions: [
          "За последние 2 недели — ощущение нервозности, тревоги или напряжённости?",
          "За последние 2 недели — трудности в остановке или контроле переживаний?"
        ],
        scoring: { 0:0, 1:1, 2:2, 3:3 },
        resultText(score){ return score >= 3 ? "Положительный скрининг (обсудите со специалистом)." : "Отрицательный скрининг."; }
      }
    ];
    </script>

    <script>
    (function(){
      window.TestEngine = {
        openById(id){
          const cfg = (window.TESTS || []).find(t => t.id === id);
          if (!cfg) { console.warn('[test] not found', id); return; }
          render(cfg);
        }
      };
    
      function render(cfg){
        setText('testTitle', cfg.title || 'Тест');
        setText('testDesc',  cfg.description || '');
        const host = byId('testFormHost'); host.innerHTML = '';
        cfg.questions.forEach((q, qi) => {
          const block = document.createElement('div');
          block.className = 'card test-card';
          block.innerHTML = `
            <div class="test-question">${q}</div>
            <div class="test-options">
              ${cfg.scale.map((opt, oi) => `
                <label style="display:flex; gap:8px; align-items:center;">
                  <input type="radio" name="q${qi}" value="${oi}">
                  <span>${opt}</span>
                </label>`).join('')}
            </div>`;
          host.appendChild(block);
        });
        byId('testSubmitBtn').onclick = () => submit(cfg);
        byId('testCancelBtn').onclick = closeTest;
        byId('testPopup').classList.remove('hidden');
        document.body.classList.add('modal-open');
      }
    
      function submit(cfg){
        let sum = 0, answered = 0;
        cfg.questions.forEach((_, qi) => {
          const v = document.querySelector(`input[name="q${qi}"]:checked`)?.value;
          if (v != null) { answered++; sum += (cfg.scoring?.[v] ?? 0); }
        });
        if (answered < cfg.questions.length) { alert('Ответьте на все вопросы.'); return; }
        const result = (typeof cfg.resultText === 'function') ? cfg.resultText(sum) : `Ваш результат: ${sum}`;
        alert(`${cfg.title}\nСумма баллов: ${sum}\n${result}`);
        closeTest();
      }
    
      function setText(id, txt){ const el = byId(id); if (el) el.textContent = txt; }
      function byId(id){ return document.getElementById(id); }
      window.closeTest = function(){
        byId('testPopup')?.classList.add('hidden');
        document.body.classList.remove('modal-open');
      };
    })();
    </script>

    <script>
        // Application state
        let currentDate = new Date();
        let selectedDate = new Date();
        let moodData = {};
        let dailyMoods = {};
        let currentPage = 'calendar';
        let currentStatsFilter = '3days';
        let dailyScores = {};
        let dailyTotals = {};
        const DAILY_MIN = -50;
        const DAILY_MAX = 50;

        // Mood types
        const moodTypes = {
            // Старые ключи (для совместимости). good → positive, neutral → neutral, sad → печаль
            good:    { name: 'Хорошее' },
            neutral: { name: 'Нейтральное' },
            sad:     { name: 'Печальное' },
            // Новая шкала из 5 настроений
            happy:   { name: 'Очень хорошее' },
            pleased: { name: 'Хорошее' },
            sorrow:  { name: 'Очень грустное' }
        };

        const monthNames = [
            'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
            'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
        ];

        // Initialize app
         // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
         await runMigrationsIfNeeded();   // ← добавили␊
          setupThemeToggle();
          loadData();
          updateCalendar();
          renderTodayScore();
          checkNotificationPermission();
          scheduleNotifications();
          switchPage('calendar');
          document.getElementById('addMoodBtn')?.addEventListener('click', openMoodSlider);

          setupChatInput();
          maybeProactiveChat();
          enableStatsSwipe();
        });

         // Theme management
        function setTheme(theme) {
          const t = theme === 'dark' ? 'dark' : 'light';
          document.documentElement.setAttribute('data-theme', t);
          localStorage.setItem('theme', t);
          const btn = document.getElementById('themeToggle');
          if (btn) {
            btn.setAttribute('aria-pressed', String(t === 'dark'));
          }
        }

        function toggleTheme() {
          const current = document.documentElement.getAttribute('data-theme') || 'light';
          setTheme(current === 'light' ? 'dark' : 'light');
        }

        function setupThemeToggle(){
          const btn = document.getElementById('themeToggle');
          if (!btn) return;
          btn.addEventListener('click', toggleTheme);
          const current = document.documentElement.getAttribute('data-theme') || 'light';
          btn.setAttribute('aria-pressed', String(current === 'dark'));
        }

        (function bootTheme(){
          const legacy = localStorage.getItem('moodCalendarTheme');
          if (legacy === 'light' || legacy === 'dark') {
            localStorage.setItem('theme', legacy);
            localStorage.removeItem('moodCalendarTheme');
          }

          const saved = localStorage.getItem('theme');
          setTheme(saved === 'dark' ? 'dark' : 'light');
        })();

        function getCSSVariable(variableName) {
            return getComputedStyle(document.documentElement).getPropertyValue(variableName).trim();
        }

        function renderTodayScore() {
          const el = document.getElementById('todayScoreBadge');
          if (!el) return;

          const today = new Date(); today.setHours(0,0,0,0);
          const key = getDateKey(today);
          const avg = dailyScores?.[key];

          let varName = '--score-zero';
          if (typeof avg === 'number') {
            if (avg >= 2.5)      varName = '--score-pos3';
            else if (avg >= 1.5) varName = '--score-pos2';
            else if (avg >= 0.5) varName = '--score-pos1';
            else if (avg > -0.5) varName = '--score-zero';
            else if (avg > -1.5) varName = '--score-neg1';
            else if (avg > -2.5) varName = '--score-neg2';
            else                 varName = '--score-neg3';
          }

          el.style.setProperty('--today-color', `var(${varName})`);

          const show = typeof avg === 'number'
            ? ((avg>0?'+':'') + (Math.round(avg*10)/10))
            : '+0';

          el.textContent = `Сегодня: ${show}`;
          el.classList.remove('hidden');
        }
        function getCSSVariable(variableName) {
            return getComputedStyle(document.documentElement).getPropertyValue(variableName).trim();
        }

        function renderTodayScore() {
          const el = document.getElementById('todayScoreBadge');
          if (!el) return;

          const today = new Date(); today.setHours(0,0,0,0);
          const key = getDateKey(today);
          const avg = dailyScores?.[key];

          let varName = '--score-zero';
          if (typeof avg === 'number') {
            if (avg >= 2.5)      varName = '--score-pos3';
            else if (avg >= 1.5) varName = '--score-pos2';
            else if (avg >= 0.5) varName = '--score-pos1';
            else if (avg > -0.5) varName = '--score-zero';
            else if (avg > -1.5) varName = '--score-neg1';
            else if (avg > -2.5) varName = '--score-neg2';
            else                 varName = '--score-neg3';
          }

          el.style.setProperty('--today-color', `var(${varName})`);

          const show = typeof avg === 'number'
            ? ((avg>0?'+':'') + (Math.round(avg*10)/10))
            : '+0';

          el.textContent = `Сегодня: ${show}`;
          el.classList.remove('hidden');
        }

        function switchPage(page) {
          currentPage = page;

          // страницы
          const calendarPage = document.getElementById('calendarPage');
          const chatPage     = document.getElementById('chatPage');
          const helpPage     = document.getElementById('helpPage');
          const therapyPage  = document.getElementById('therapyPage');
          const testsPage    = document.getElementById('testsPage');
        
          // навигация
          const navCalendar  = document.getElementById('navCalendar');
          const navChat      = document.getElementById('navChat');
          const navHelp      = document.getElementById('navHelp');
        
          // CTA
          const cta = document.querySelector('.calendar-cta');
        
          // 1) Скрыть все страницы (и снять спец-класс у чата)
          [calendarPage, chatPage, helpPage, therapyPage, testsPage].forEach(el => {
            if (el) el.style.display = 'none';
          });
          chatPage?.classList.remove('active');
        
          // 2) Сбросить активность у всех табов
          [navCalendar, navChat, navHelp].forEach(el => el?.classList.remove('active'));
        
          // 3) Показать выбранную страницу + настроить CTA и активный таб
          if (page === 'calendar') {
            calendarPage && (calendarPage.style.display = 'block');
            cta && (cta.style.display = 'flex');
            navCalendar?.classList.add('active');
          } else if (page === 'chat') {
            chatPage && (chatPage.style.display = 'flex');
            chatPage?.classList.add('active');                 // вернуть класс для твоих CSS
            cta && (cta.style.display = 'none');
            navChat?.classList.add('active');
            setTimeout(() => document.getElementById('chatInput')?.focus(), 100);
          } else if (page === 'help') {
            helpPage && (helpPage.style.display = 'block');
            cta && (cta.style.display = 'none');
            navHelp?.classList.add('active');
          } else if (page === 'therapy') {
            therapyPage && (therapyPage.style.display = 'block');
            cta && (cta.style.display = 'none');
            navHelp?.classList.add('active');
          } else if (page === 'tests') {
            testsPage && (testsPage.style.display = 'block');
            cta && (cta.style.display = 'none');
            navHelp?.classList.add('active');
          }
        
          // 4) Флаг на body — если используешь в стилях
          document.body.classList.toggle('on-calendar', page === 'calendar');
        }



        function autoResize(ta, max = 160) {
          ta.style.height = 'auto';
          ta.style.height = Math.min(ta.scrollHeight, max) + 'px';
        }

        // Chat functionality
        function setupChatInput() {
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            if (!chatInput || !sendButton) return;
            autoResize(chatInput);
            chatInput.addEventListener('input', function () {
                autoResize(this);                      
                sendButton.disabled = !this.value.trim();
            });
            chatInput.addEventListener('focus', function () {
                autoResize(this);
            });
            chatInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                  e.preventDefault();
                  sendMessage();
                }
            });
        }
        
        const isLocal = ['localhost', '127.0.0.1'].includes(location.hostname) || location.hostname === '';
        const isVercel = location.hostname.endsWith('.vercel.app');
        
        const API_BASE = (isLocal || isVercel)
          ? '' // относительный путь => /api/chat
          : 'https://mood-calendar-omega.vercel.app'; // когда открываем с GitHub Pages
        
        async function askAI(userText) {
          const summary = getMoodSummary(14);
          const payload = {
            messages: [
              { role: 'system', content:
                'Ты доброжелательный поддерживающий собеседник. Говори кратко, эмпатично, без диагнозов. ' +
                'Предлагай простые техники (дыхание 4-7-8, прогулка, запись мыслей, переоценка). ' +
                'Если есть риск себе/другим — мягко дай контакты экстренной помощи и предложи обратиться к специалисту.'
              },
              { role: 'assistant', content:
                `Краткая сводка последних ${summary.daysConsidered} дней: хорошие=${summary.counts.good}, нейтральные=${summary.counts.neutral}, грустные=${summary.counts.sad}.`
              },
              { role: 'user', content: userText }
            ]
          };
        
          const res = await fetch(`${API_BASE}/api/chat`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
        
          if (!res.ok) throw new Error(await res.text());
          const data = await res.json();
          return (data.reply || '').trim();
        }

        function sendMessage() {
          const chatInput = document.getElementById('chatInput');
          const sendBtn   = document.getElementById('sendButton');
          const message   = chatInput.value.trim();
        
          // 1) не отправляем пустое
          if (!message) return;
        
          // 2) показываем сообщение пользователя
          addMessage('user', message);
        
          // 3) чистим поле и временно блокируем кнопку
          chatInput.value = '';
          chatInput.style.height = 'auto';
          sendBtn.disabled = true;
        
          // 4) индикатор набора
          showTypingIndicator();
        
          // 5) запрос к ИИ
          askAI(message)
            .then(reply => {
              addMessage('ai', reply || 'Извини, не удалось получить ответ.');
            })
            .catch(err => {
              console.error(err);
              addMessage('ai', 'Похоже, сервис занят. Попробуйте ещё раз чуть позже 🙏');
            })
            .finally(() => {
              // 6) всегда скрываем индикатор, разблокируем кнопку и возвращаем фокус
              hideTypingIndicator();
              sendBtn.disabled = false;
              chatInput.focus();
            });
        }
        
        function startPractice(code){
          if (code === '478') {
            alert('Дыхание 4–7–8: вдох 4 сек → задержка 7 → выдох 8. Повторите 4–6 раз.');
          } else if (code === '54321') {
            alert('Заземление 5-4-3-2-1: 5 вижу, 4 ощущаю, 3 слышу, 2 нюхаю, 1 пробую.');
          }
        }
        
        function openTest(name){
          if (name === 'phq2') {
            // тут потом вставим форму/подсчёт баллов
            alert('PHQ-2: дальше добавим форму с 2 вопросами и логикой подсчёта.');
          } else if (name === 'gad2') {
            alert('GAD-2: дальше добавим форму с 2 вопросами и логикой подсчёта.');
          }
        }


        function addMessage(sender, text) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = text;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.textContent = 'ИИ печатает...';
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Stats functionality
        function setStatsFilter(filter) {
            currentStatsFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                const btnOnClick = btn.getAttribute('onclick');
                if (btnOnClick && btnOnClick.includes(`'${filter}'`)) {
                    btn.classList.add('active');
                }
            });
            
            updateStatsPage();
        }

        function updateStatsPage() {
            updateHourlyChart();
            updateOverviewStats();
        }
        
        function openStats(){
          const sheet = document.getElementById('statsSheet');
          if (!sheet) return;
          sheet.hidden = false;
          document.body.classList.add('modal-open');  // по желанию — блокируем скролл фона
          updateStatsPage();                           // твоя существующая функция
        }
        function closeStats(){
          const sheet = document.getElementById('statsSheet');
          if (!sheet) return;
          sheet.hidden = true;
          document.body.classList.remove('modal-open');
        }
          // Закрытие по клику на фон и по Esc

          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeStats();
          });
        
          // Свайп-вниз для закрытия листа
// Свайп-вниз или влево для закрытия модалки
        function enableStatsSwipe() {
          const panel = document.querySelector('#statsSheet .sheet__panel'); // ← так надёжнее
          if (!panel) return;
        
          let sx = 0, sy = 0, dx = 0, dy = 0;
        
          panel.addEventListener('touchstart', (e) => {
            const t = e.touches[0];
            sx = t.clientX; sy = t.clientY; dx = dy = 0;
          }, { passive: true });
        
          panel.addEventListener('touchmove', (e) => {
            const t = e.touches[0];
            dx = t.clientX - sx; dy = t.clientY - sy;
          }, { passive: true });
        
          panel.addEventListener('touchend', () => {
            if (Math.abs(dy) > 80 || Math.abs(dx) > 120) closeStats();
          });
        }



        function updateHourlyChart() {
            const today = new Date();
            const todayKey = getDateKey(today);
            const todayEntries = moodData[todayKey] || [];
            
            const hourlyChart = document.getElementById('hourlyChart');
            if (!hourlyChart) return;
            
            hourlyChart.innerHTML = '';
            
            for (let hour = 6; hour <= 23; hour++) {
                const hourBlock = document.createElement('div');
                hourBlock.className = 'hour-block';
                
                const hourEntries = todayEntries.filter(entry => entry.hour === hour);
                
                if (hourEntries.length > 0) {
                    const hourMoodCounts = hourEntries.reduce((acc, entry) => {
                        acc[entry.mood] = (acc[entry.mood] || 0) + 1;
                        return acc;
                    }, {});
                    
                    const dominantMood = Object.keys(hourMoodCounts).reduce((a, b) => 
                        hourMoodCounts[a] > hourMoodCounts[b] ? a : b
                    );
                    
                    const moodVar = `--mood-${dominantMood}`;
                    hourBlock.style.backgroundColor = `var(${moodVar})`;
                    hourBlock.classList.add('has-data');
                    hourBlock.title = `${hour}:00 - ${hourEntries.length} записей`;
                } else {
                    hourBlock.style.backgroundColor = 'transparent';
                    hourBlock.title = `${hour}:00 - нет записей`;
                }
                
                hourBlock.textContent = hour;
                hourBlock.onclick = () => showHourDetails(hour, hourEntries);
                
                hourlyChart.appendChild(hourBlock);
            }
        }

        function showHourDetails(hour, entries) {
            if (entries.length === 0) {
                alert(`${hour}:00 - записей нет`);
                return;
            }
            
            const details = entries.map(entry => {
                const time = `${entry.hour.toString().padStart(2, '0')}:${entry.minute.toString().padStart(2, '0')}`;
                const moodName = moodTypes[entry.mood].name;
                return `${time} - ${moodName}`;
            }).join('\n');
            
            alert(`${hour}:00\n${entries.length} записей:\n\n${details}`);
        }

        function updateOverviewStats() {
            const periodData = getDataForPeriod(currentStatsFilter);
            
            const currentPeriodElement = document.getElementById('currentPeriod');
            const statsGoodElement = document.getElementById('statsGoodPercent');
            const statsNeutralElement = document.getElementById('statsNeutralPercent');
            const statsSadElement = document.getElementById('statsSadPercent');
            const statsTotalElement = document.getElementById('statsTotalRecords');
            const avgPerDayElement = document.getElementById('avgPerDay');
            const activeDaysElement = document.getElementById('activeDays');
            
            if (!currentPeriodElement) return;
            
            currentPeriodElement.textContent = getPeriodName(currentStatsFilter);
            
            if (periodData.totalEntries === 0) {
                statsGoodElement.textContent = '0%';
                statsNeutralElement.textContent = '0%';
                statsSadElement.textContent = '0%';
                statsTotalElement.textContent = 'Всего записей: 0';
                avgPerDayElement.textContent = '0';
                activeDaysElement.textContent = '0';
                return;
            }
            
            // Суммируем новые шкалы в общие категории: good (happy, pleased, good), neutral, sad (sad, sorrow).
            const moodCounts = periodData.moodCounts || {};
            const goodCount    = (moodCounts.good || 0) + (moodCounts.happy || 0) + (moodCounts.pleased || 0);
            const neutralCount = (moodCounts.neutral || 0);
            const sadCount     = (moodCounts.sad || 0) + (moodCounts.sorrow || 0);

            const goodPercent    = Math.round(goodCount    / periodData.totalEntries * 100);
            const neutralPercent = Math.round(neutralCount / periodData.totalEntries * 100);
            const sadPercent     = Math.round(sadCount     / periodData.totalEntries * 100);

            statsGoodElement.textContent    = `${goodPercent}%`;

            statsNeutralElement.textContent = `${neutralPercent}%`;

            statsSadElement.textContent     = `${sadPercent}%`;
            
            statsTotalElement.textContent = `Всего записей: ${periodData.totalEntries}`;
            avgPerDayElement.textContent = (periodData.totalEntries / Math.max(periodData.days, 1)).toFixed(1);
            activeDaysElement.textContent = periodData.activeDays;
        }

        function getDataForPeriod(period) {
            const now = new Date();
            let startDate = new Date();
            
            switch (period) {
                case '3days':
                    startDate.setDate(now.getDate() - 3);
                    break;
                case 'week':
                    startDate.setDate(now.getDate() - 7);
                    break;
                case 'month':
                    startDate.setMonth(now.getMonth() - 1);
                    break;
                case 'all':
                    startDate = new Date('2020-01-01');
                    break;
            }
            
            let totalEntries = 0;
            let moodCounts = { good: 0, neutral: 0, sad: 0 };
            let activeDays = 0;
            
            Object.keys(moodData).forEach(dateKey => {
                const date = new Date(dateKey);
                if (date >= startDate && date <= now) {
                    const dayEntries = moodData[dateKey];
                    if (dayEntries && dayEntries.length > 0) {
                        activeDays++;
                        dayEntries.forEach(entry => {
                            totalEntries++;
                            moodCounts[entry.mood] = (moodCounts[entry.mood] || 0) + 1;
                        });
                    }
                }
            });
            
            const days = Math.max(Math.ceil((now - startDate) / (1000 * 60 * 60 * 24)), 1);
            
            return {
                totalEntries,
                moodCounts,
                activeDays,
                days
            };
        }

        function getPeriodName(period) {
            switch (period) {
                case '3days': return '3 дня';
                case 'week': return 'неделя';
                case 'month': return 'месяц';
                case 'all': return 'все время';
                default: return period;
            }
        }

        // Notification functions
        function checkNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                document.getElementById('installPrompt').classList.remove('hidden');
            }
        }

        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    document.getElementById('installPrompt').classList.add('hidden');
                    new Notification('Календарь Настроения', {
                        body: 'Уведомления включены! Мы будем напоминать записывать настроение.',
                        tag: 'mood-setup'
                    });
                    scheduleNotifications();
                }
            }
        }

        function scheduleNotifications() {
            if ('Notification' in window && Notification.permission === 'granted') {
                setInterval(showNotification, 60 * 1000);
            }
        }

        function showNotification() {
            if ('Notification' in window && Notification.permission === 'granted') {
                const now = new Date();
                const hour = now.getHours();
                const minute = now.getMinutes();
                
                const notificationTimes = [9, 15, 21];
                
                if (notificationTimes.includes(hour) && minute === 0) {
                    const timeOfDay = hour === 9 ? 'Утро' : hour === 15 ? 'День' : 'Вечер';
                    const notification = new Notification(`${timeOfDay}: Время записать настроение! 😊`, {
                        body: 'Как вы себя чувствуете сейчас?',
                        tag: 'mood-reminder'
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        openMoodSlider();
                        notification.close();
                    };
                }
            }
        }
      
        const SCHEMA_KEY = 'moodSchemaVersion';
        const CURRENT_SCHEMA_VERSION = 3;
        
        // Универсальные JSON-хелперы
        function getJson(key, fallback = null) {
          try {
            const raw = localStorage.getItem(key);
            return raw ? JSON.parse(raw) : fallback;
          } catch (e) {
            console.warn('[storage] broken JSON in', key, e);
            return fallback;
          }
        }
        function setJson(key, value) {
          localStorage.setItem(key, JSON.stringify(value));
        }
        
      
        const MIGRATIONS = [
          {
            version: 1,
            name: 'Normalize moodData to array-of-entries',
            run() {
              const raw = getJson('moodData', {});
              const normalized = {};
        
              Object.keys(raw || {}).forEach(dateKey => {
                const day = raw[dateKey];
        
                if (Array.isArray(day)) {
                  normalized[dateKey] = day; 
                  return;
                }
        
             
                const arr = [];
                if (day && typeof day === 'object') {
                  Object.keys(day).forEach(h => {
                    const hour = parseInt(h, 10);
                    arr.push({
                      hour,
                      minute: 0,
                      mood: day[h],
                      timestamp: new Date(`${dateKey}T${String(hour).padStart(2,'0')}:00:00`).getTime()
                    });
                  });
                }
                normalized[dateKey] = arr.sort((a,b) => a.timestamp - b.timestamp);
              });
        
              setJson('moodData', normalized);
            }
          },
          {
            version: 2,
            name: 'Recompute dailyMoods from moodData',
            run() {
              const md = getJson('moodData', {});
              const dm = {};
        
              Object.keys(md || {}).forEach(k => {
                const entries = md[k] || [];
                if (!entries.length) return;
                const counts = entries.reduce((acc, e) => {
                  acc[e.mood] = (acc[e.mood] || 0) + 1;
                  return acc;
                }, {});
                const dominant = Object.keys(counts).reduce((a,b) => counts[a] >= counts[b] ? a : b);
                dm[k] = dominant;
              });
        
              setJson('dailyMoods', dm);
            }
          },
          {
            version: 3,
            name: 'Ensure chat history key and cap length',
            run() {
              // переносим возможные старые ключи и ограничиваем длину истории
              const legacy = getJson('chat') ?? getJson('chatMessages', []);
              const arr = Array.isArray(legacy) ? legacy : [];
              setJson('chatMessages', arr.slice(-100));
              localStorage.removeItem('chat'); // чистим старое имя ключа, если было
            }
          }
        ];
        
        async function runMigrationsIfNeeded() {
          let current = parseInt(localStorage.getItem(SCHEMA_KEY) || '0', 10);
        
          for (const m of MIGRATIONS) {
            if (m.version > current) {
              try {
                console.info(`[migrate] -> v${m.version}: ${m.name}`);
                await Promise.resolve(m.run());
                localStorage.setItem(SCHEMA_KEY, String(m.version));
                current = m.version;
              } catch (e) {
                console.error('[migrate] failed', m.version, m.name, e);
                break; // остановим цепочку, чтобы не усугублять
              }
            }
          }
        }
       
       function loadData() {
          try {
            moodData   = getJson('moodData', {}) || {};
            dailyMoods = getJson('dailyMoods', {}) || {};
            dailyScores = getJson('dailyScores', {}) || {};
            dailyTotals = getJson('dailyTotals', {}) || {};

            if (!dailyTotals || typeof dailyTotals !== 'object') {
              dailyTotals = {};
            }

            const clampTotal = (value) => Math.max(DAILY_MIN, Math.min(DAILY_MAX, value));
            const ensureScore = (entry) => {
              if (typeof entry?.score === 'number') return entry.score;
              switch (entry?.mood) {
                case 'happy': return 3;
                case 'pleased': return 2;
                case 'neutral': return 0;
                case 'sad': return -2;
                case 'sorrow': return -3;
                default: return 0;
              }
            };

            Object.keys(moodData || {}).forEach((key) => {
              const entries = Array.isArray(moodData[key]) ? moodData[key] : [];
              if (!entries.length) return;

              const computedSum = entries.reduce((sum, entry) => sum + ensureScore(entry), 0);
              if (typeof dailyTotals[key] !== 'number') {
                dailyTotals[key] = clampTotal(computedSum);
              } else {
                dailyTotals[key] = clampTotal(dailyTotals[key]);
              }

              dailyScores[key] = entries.length ? computedSum / entries.length : 0;
            });
          }
          catch (e) {
            console.log('Error loading data:', e);
            moodData = {};
            dailyMoods = {};
            dailyTotals = {};
          }
        }

        function saveData() {
            try {
                localStorage.setItem('moodData', JSON.stringify(moodData));
                localStorage.setItem('dailyMoods', JSON.stringify(dailyMoods));
                localStorage.setItem('dailyScores', JSON.stringify(dailyScores));
                localStorage.setItem('dailyTotals', JSON.stringify(dailyTotals));
            } catch (e) {
                console.log('Error saving data:', e);
            }
        }

        function getDateKey(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // AI analysis functions
        function getSadStreak(daysWindow = 10) {
            const today = new Date();
            let streak = 0;
            for (let i = 0; i < daysWindow; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const key = getDateKey(d);
                const mood = dailyMoods[key];
                if (mood === 'sad' || mood === 'sorrow') streak++;
                else break;
            }
            return streak;
        }
        
        function getMoodSummary(days = 14) {
            const today = new Date();
            const counts = { good: 0, neutral: 0, sad: 0 };
            let total = 0;
            
            for (let i = 0; i < days; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const key = getDateKey(d);
                const mood = dailyMoods[key];
                if (mood) {
                    counts[mood]++;
                    total++;
                }
            }
            return { daysConsidered: days, counts, total };
        }

        const SAD_STREAK_THRESHOLD = 3;
        const PROACTIVE_COOLDOWN_DAYS = 3;
        
        function maybeProactiveChat() {
            try {
                const streak = getSadStreak(10);
                const lastAt = localStorage.getItem('aiLastProactiveAt');
                const todayKey = getDateKey(new Date());
        
                if (streak >= SAD_STREAK_THRESHOLD) {
                    if (lastAt) {
                        const last = new Date(lastAt);
                        const diffDays = Math.floor((Date.now() - last.getTime()) / (1000 * 3600 * 24));
                        if (diffDays < PROACTIVE_COOLDOWN_DAYS) return;
                    }
                    localStorage.setItem('aiLastProactiveAt', todayKey);
                    
                    // Switch to chat page and add proactive message
                    switchPage('chat');
                    setTimeout(() => {
                        const intro = `Я заметил, что последние ${streak} ${streak === 1 ? 'день' : 'дня'} вам грустно. Хотите немного поддержки или пару простых практик?`;
                        addMessage('ai', intro);
                    }, 500);
                }
            } catch (e) {
                console.log('Error in proactive chat:', e);
            }
        }
       
        // Calendar functions
       function navigateMonth(direction) {
            selectedDate.setMonth(selectedDate.getMonth() + direction);
            updateCalendar();
        }

        function bucketVarForTotal(total) {
          if (total >= 50) return '--bucket-pos50';
          if (total >= 40) return '--bucket-pos40';
          if (total >= 30) return '--bucket-pos30';
          if (total >= 20) return '--bucket-pos20';
          if (total >= 10) return '--bucket-pos10';
          if (total >= 1)  return '--bucket-zero';
          if (total === 0) return '--bucket-zero';
          if (total <= -50) return '--bucket-neg50';
          if (total <= -40) return '--bucket-neg40';
          if (total <= -30) return '--bucket-neg30';
          if (total <= -20) return '--bucket-neg20';
          if (total <= -10) return '--bucket-neg10';
          return '--bucket-zero';
        }

        function updateCalendar() {
          document.getElementById('monthTitle').textContent =
            `${monthNames[selectedDate.getMonth()]} ${selectedDate.getFullYear()}`;
        
          const year = selectedDate.getFullYear();
          const month = selectedDate.getMonth();
          const firstDay = new Date(year, month, 1);
          const startDate = new Date(firstDay);
          startDate.setDate(startDate.getDate() - firstDay.getDay());
        
          const calendarDays = document.getElementById('calendarDays');
          calendarDays.innerHTML = '';
        
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const todayKey = getDateKey(today);
        
          for (let week = 0; week < 6; week++) {
            const weekDiv = document.createElement('div');
            weekDiv.className = 'week';
        
            for (let day = 0; day < 7; day++) {
              const current = new Date(startDate);
              current.setDate(startDate.getDate() + (week * 7 + day));
              const dateKey = getDateKey(current);
              const isCurrentMonth = current.getMonth() === month;
              const isToday = dateKey === todayKey;
        
              const dayDiv = document.createElement('div');
              dayDiv.className = 'day';
              if (!isCurrentMonth) dayDiv.classList.add('other-month');
              if (isToday) dayDiv.classList.add('today');
        
              // задаём фон на основе среднего балла
              // задаём фон на основе накопленной суммы
              const total = dailyTotals[dateKey];

              if (typeof total === 'number') {
                dayDiv.classList.add('has-mood');

                const varName = bucketVarForTotal(total);
                const bg = `var(${varName})`;

                dayDiv.style.backgroundColor = bg;
                dayDiv.style.backgroundImage = 'none';

                // не задаём инлайновый цвет — даём теме рулить контрастом
                dayDiv.style.removeProperty('color');

                dayDiv.style.boxShadow =
                  'inset 0 1px 0 rgba(255,255,255,0.05), 0 0 0 1px rgba(0,0,0,0.40)';
                dayDiv.style.borderColor = 'transparent';
              } else if (isToday) {
                const bg = 'var(--bucket-zero)';
                dayDiv.style.backgroundColor = bg;
                dayDiv.style.backgroundImage = 'none';
                // не задаём инлайновый цвет — даём теме рулить контрастом
                dayDiv.style.removeProperty('color');
                dayDiv.style.boxShadow =
                  'inset 0 1px 0 rgba(255,255,255,0.05), 0 0 0 1px rgba(0,0,0,0.40)';
              }

              dayDiv.textContent = current.getDate();
              weekDiv.appendChild(dayDiv);
            }
            calendarDays.appendChild(weekDiv);
          }

          renderTodayScore();
        }

        function renderTodayScore() {
          const el = document.getElementById('todayScoreBadge');
          if (!el) return;

          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const key = getDateKey(today);
          const total = dailyTotals?.[key] ?? 0;

          const varName = bucketVarForTotal(total);
          el.style.setProperty('--today-color', `var(${varName})`);

          const sign = total > 0 ? '+' : '';
          el.textContent = `Сегодня: ${sign}${total} / 50`;
          el.classList.remove('hidden');
        }

        function pingTodayBadge() {
          const el = document.getElementById('todayScoreBadge');
          if (!el) return;
          el.animate([
            { transform: 'scale(1)' },
            { transform: 'scale(1.06)' },
            { transform: 'scale(1)' }
          ], { duration: 220, easing: 'ease-out' });
        }

        function showInfo(text) {
          alert(text);
        }

        function updateSliderGlow() {
          const el = document.getElementById('moodSlider');
          if (!el) return;
          const val = parseInt(el.value, 10) || 0;      // -5..+5
          const ratio = Math.min(Math.abs(val) / 5, 1); // 0..1
          const sizePx = 3 + Math.round(7 * ratio);     // 3..10

          // теперь: слева (val < 0) — СИНИЙ, справа (val > 0) — ЗЕЛЁНЫЙ
          let color = 'rgba(0,0,0,0)';
          if (val < 0) color = getComputedStyle(document.documentElement).getPropertyValue('--thumb-neg').trim() || 'rgba(29,78,216,.45)';
          if (val > 0) color = getComputedStyle(document.documentElement).getPropertyValue('--thumb-pos').trim() || 'rgba(22,163,74,.45)';

          el.style.setProperty('--thumb-glow', color);
          el.style.setProperty('--glow-size', sizePx + 'px');
        }

        function pingSliderThumbOnce() {
          const slider = document.getElementById('moodSlider');
          if (!slider) return;

          slider.animate([
            { transform: 'scale(1)' },
            { transform: 'scale(1.05)' },
            { transform: 'scale(1)' }
          ], { duration: 180, easing: 'ease-out' });
        }

        // открыть модальное окно со слайдером
        function openMoodSlider() {
          const slider = document.getElementById('moodSlider');
          if (slider) {
            slider.value = 0;
            slider.removeEventListener('input', updateSliderGlow);
            slider.addEventListener('input', updateSliderGlow);
            updateSliderGlow();
          }
          document.getElementById('moodSliderPopup').classList.remove('hidden');
          document.body.classList.add('modal-open');
        }

        // закрыть модальное окно со слайдером
        function closeMoodSlider() {
          document.getElementById('moodSliderPopup').classList.add('hidden');
          document.body.classList.remove('modal-open');
        }

        // считать значение слайдера и записать настроение
        function confirmMoodScore() {
          const slider = document.getElementById('moodSlider');
          const raw = slider ? parseInt(slider.value, 10) : 0;
          const delta = raw;               // ПЛЮС справа, МИНУС слева
          recordScore(delta);
          pingSliderThumbOnce && pingSliderThumbOnce();
          closeMoodSlider();
        }
        
        /**
         * Сохраняем запись со score, пересчитываем средний балл за день,
         */
       function recordScore(delta) {
          const now = new Date();
          const dateKey = getDateKey(now);
          const hour = now.getHours();
          const minute = now.getMinutes();
          const timestamp = now.getTime();

          const mood = delta >= 4 ? 'happy'
                     : delta >= 2 ? 'pleased'
                     : delta <= -4 ? 'sorrow'
                     : delta <= -2 ? 'sad'
                     : 'neutral';
          if (!moodData[dateKey]) moodData[dateKey] = [];
          moodData[dateKey].push({ hour, minute, mood, score: delta, timestamp });

          const current = typeof dailyTotals[dateKey] === 'number' ? dailyTotals[dateKey] : 0;
          const next = current + delta;

          if (next > DAILY_MAX) {
            showInfo('Максимум за день: +50. Больше очков не начисляется.');
            dailyTotals[dateKey] = DAILY_MAX;
          } else if (next < DAILY_MIN) {
            showInfo('Минимум за день: −50. Меньше очков не начисляется.');
            dailyTotals[dateKey] = DAILY_MIN;
          } else {
            dailyTotals[dateKey] = next;
          }

          dailyMoods[dateKey] =
              dailyTotals[dateKey] >= 10 ? 'happy' :
              dailyTotals[dateKey] >= 1  ? 'pleased' :
              dailyTotals[dateKey] <= -10 ? 'sorrow' :
              dailyTotals[dateKey] <= -1 ? 'sad' :
              'neutral';

          const entries = moodData[dateKey] || [];
          const totalForAverage = entries.reduce((sum, entry) => {
            if (typeof entry.score === 'number') return sum + entry.score;
            return sum;
          }, 0);
          dailyScores[dateKey] = entries.length ? totalForAverage / entries.length : 0;

          saveData();
          updateCalendar();
          renderTodayScore();
          pingTodayBadge();
          maybeProactiveChat();
        }
        


        // Add event listener for notifications button
        document.getElementById('enableNotifications').addEventListener('click', requestNotificationPermission);
    </script>
    <!-- Load core module which defines the global App object with store, bus and navigation helpers -->
    <script src="./app-core.js"></script>
</body>
</html>





















