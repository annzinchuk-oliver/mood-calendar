<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="app-version" content="dev ‚Ä¢ 2025-10-07 15:21:38">
    <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è</title>
    
    
    <meta name="theme-color" content="#4F46E5">
    <meta name="description" content="–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å–≤–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è">
    
    
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi0JrQsNC70LXQvdC00LDRgNGMINCd0LDRgdGC0YDQvtC10L3QuNGPIiwic2hvcnRfbmFtZSI6ItCa0LDQu9C10L3QtNCw0YDRjCIsImRlc2NyaXB0aW9uIjoi0J7RgtGB0LvQtdC20LjQstCw0LnRgtC1INGB0LLQvtC1INC90LDRgdGC0YDQvtC10L3QuNC1INC60LDQttC00YvQuSDQtNC10L3RjCIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjNEY0NkU1IiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0Nzdmcgdmlld0JveD0nMCAwIDEwMCAxMDAnIGZpbGw9JyUyMzRGNDZFNScgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyUzRSUzQ3JlY3Qgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIHJ4PScxMCcvJTNFJTNDdGV4dCB4PSc1MCcgeT0nNTAnIGZvbnQtc2l6ZT0nNDAnIGZpbGw9J3doaXRlJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBkeT0nLjNlbSclM0Xwn5OBJTNFL3RleHQlM0UlM0Mvc3ZnJTNFIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    
    
    <link rel="stylesheet" href="styles/tokens.css?v=__BUILD_ID__">
    <link rel="stylesheet" href="styles/components.css?v=__BUILD_ID__">
    
    <style>
        
      * { margin: 0; padding: 0; box-sizing: border-box; }


        html,
        body {
            color: var(--text-primary);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 8px;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

         .app-header {
          background: linear-gradient(135deg, var(--brand), var(--brand-2));
          padding: 16px 20px;
          color: var(--text-primary);
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 16px;
          border-radius: 16px;
          box-shadow: 0 10px 26px rgba(79, 70, 229, 0.2);
        }

        .header-left {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        .header-right {
          display: flex;
          align-items: center;
          gap: 12px;
          padding-right: 8px;
        }

        .app-header,
        .header-right,
        .weekday-row span,
        .calendar,
        .calendar .day {
          color: var(--text-primary);
        }

        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
        }

        .month-nav__title-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            text-align: center;
        }

        .month-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .theme-toggle {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: 4px;
          border-radius: 999px;
          background: var(--palette-surface-variant);
          border: 1px solid rgba(0,0,0,.08);
          margin-right: 8px;
        }

        .theme-toggle__knob {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 8px 12px;
          border-radius: 999px;
          border: 1px solid rgba(0,0,0,.12);
          background: var(--palette-surface);
          color: var(--text-primary);
          font-weight: 600;
          cursor: pointer;
          transition: transform .12s ease, box-shadow .12s ease;
        }

        .theme-toggle__knob:focus-visible {
          outline: none;
          box-shadow: 0 0 0 3px color-mix(in srgb, var(--brand) 25%, transparent);
        }

        [data-theme="dark"] .theme-toggle {
          border-color: rgba(255,255,255,.06);
        }

        [data-theme="dark"] .theme-toggle__knob {
          background: var(--palette-surface-variant);
          color: var(--text-primary);
          border-color: rgba(255,255,255,.08);
        }

        [data-theme="dark"] .theme-toggle__label {
          color: var(--text-primary);
        }


        .theme-toggle__knob:active {
          transform: scale(.98);
        }

        .theme-toggle__icon {
          font-size: 16px;
          line-height: 1;
        }

         .theme-toggle__label {
          display: inline;
          font-size: 14px;
          color: var(--text-primary);
        }

        .calendar {
            padding: 20px;
        }

        .today-score {
          --today-color: var(--bucket-zero);
          display: inline-flex;
          align-items: center;
          gap: .5rem;
          padding: 6px 12px;
          border-radius: 999px;
          border: 2px solid var(--today-color);
          background: var(--today-color);
          color: var(--calendar-text-contrasted);
          font-weight: 700;
        }
        .today-score.hidden{ display:none; }

        .week { gap: 6px; }

        .calendar .day {
          box-shadow:
            inset 0 1px 0 rgba(255,255,255,0.05),
            0 0 0 1px rgba(0,0,0,0.40);
        }

       .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .weekday {
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 12px 4px;
        }

       .calendar .day {
            animation: dayFadeIn 0.3s ease;
        }

        .stats {
          padding: 20px;
          border-top: 1px solid var(--border);
          background: var(--surface-2);
        }


        .stats h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
            margin-bottom: 12px;
            padding: 8px 0;
        }
        
            .stat-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-value {
            font-weight: 700;
            font-size: 16px;
            color: var(--text-primary);
        }

        .total-records {
            font-size: 13px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .mood-popup {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .mood-popup-content {
            background: var(--surface-2);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 380px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            transform: scale(0.9);
            animation: popupAppear 0.3s ease forwards;
        }

        @keyframes popupAppear {
            to {
                transform: scale(1);
            }
        }

        .mood-popup h3 {
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 16px;
            color: var(--text);
        }

        .mood-popup p {
            font-size: 15px;
            color: var(--text-muted);
            text-align: center;
            margin-bottom: 28px;
        }

        .mood-buttons {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .mood-btn {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            border: 2px solid;
            border-radius: 16px;
            background: var(--surface-2);
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            width: 100%;
        }

        .mood-btn:hover, .mood-btn:active {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .mood-emoji {
            font-size: 28px;
        }

        .skip-btn {
            width: 100%;
            margin-top: 20px;
            color: #64748b;
            font-size: 15px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 12px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .skip-btn:hover, .skip-btn:active {
            color: #1e293b;
            background: #f1f5f9;
        }

        .install-prompt {
            padding: 16px 20px;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 1px solid #93c5fd;
            margin: 16px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .hidden {
            display: none !important;
        }

        /* –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 400px;
            background: var(--bg-secondary);
            border-top: 2px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* –ß—É—Ç—å –±–æ–ª–µ–µ –∫—Ä—É–ø–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
        .btn--xl{
          padding: 14px 20px;
          font-size: 16px;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 12px;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .nav-item.active {
            color: var(--mood-good);
            background: var(--bg-primary);
        }

        .nav-item:hover {
            background: var(--bg-primary);
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        .app-container {
            max-width: 400px;
            margin: 0 auto;
            background: var(--bg-secondary);
            border-radius: 16px 16px 0 0;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            min-height: calc(100vh - 16px);
            margin-bottom: 0;
            padding-bottom: calc(var(--nav-height) + 24px);    /* –∑–∞–ø–∞—Å –ø–æ–¥ –Ω–∏–∂–Ω—é—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é */
            min-height: 100vh; 
            transition: background-color 0.3s ease;
            position: relative; /* –¥–æ–±–∞–≤–ª—è–µ–º –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
        }
        .bottom-nav{
          box-shadow: 0 -6px 18px rgba(0,0,0,.06);
        }
        /* –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */

        .stats-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .correlation-section, .overview-section {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }

        .correlation-section h3, .overview-section h3 {
            margin-bottom: 12px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .hourly-chart {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            margin-top: 12px;
        }

        .hour-block {
            text-align: center;
            padding: 8px 4px;
            border-radius: 8px;
            font-size: 11px;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }


        .calendar-page {
            display: block;
        }

        .calendar-page.hidden {
            display: none;
        }

        /* === –ß–ê–¢ –°–¢–†–ê–ù–ò–¶–ê === */
        .chat-page {
            display: none;
            flex-direction: column;
            height: calc(100vh - 240px); /* —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ—Ç—Å—Ç—É–ø –¥–ª—è header –∏ bottom-nav */
            max-height: calc(100vh - 240px);
        }

        .chat-page.active {
            display: flex;
        }

        .chat-header {
            background: var(--bg-primary);
            padding: 20px;
            border-bottom: 2px solid var(--border-color);
            text-align: center;
        }

        .chat-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .chat-header p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }


        .chat-disclaimer {
            padding: 8px 20px;
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
      .calendar .day {
            animation: dayFadeIn 0.3s ease;
        }

        @keyframes dayFadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
    
    <div class="app-container">
        
        <div id="installPrompt" class="install-prompt hidden">
            <p><strong>üì± –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω!</strong></p>
            <p style="font-size: 14px; margin-top: 8px; color: #64748b;">
                –ù–∞–∂–º–∏—Ç–µ –º–µ–Ω—é –±—Ä–∞—É–∑–µ—Ä–∞ ‚Üí "–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω"
            </p>
            <button id="enableNotifications" class="btn btn--ghost">üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
        </div>

        <header class="app-header">
          <div class="header-left"></div>

          <div class="header-right">
            <div id="todayScoreBadge" class="today-score hidden" aria-live="polite"></div>

            <div class="theme-toggle" role="group" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
              <button id="themeToggle" class="theme-toggle__knob" type="button" aria-pressed="false" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
                <span class="theme-toggle__icon theme-toggle__icon--moon" aria-hidden="true">üåô</span>
                <span class="theme-toggle__label">–¢–µ–º–∞</span>
                <span class="theme-toggle__icon theme-toggle__icon--sun" aria-hidden="true">‚òÄÔ∏è</span>
              </button>
            </div>
          </div>
        </header>
        
        <div class="calendar-page" id="calendarPage">
          <div class="month-nav">
                <button class="btn btn--ghost btn--icon" onclick="navigateMonth(-1)">‚Üê</button>
                <div class="month-nav__title-group">
                    <div class="month-title" id="monthTitle"></div>
                </div>
                <button class="btn btn--ghost btn--icon" onclick="navigateMonth(1)">‚Üí</button>
          </div>

            <div class="calendar">
                 <div class="weekdays">
                    <div class="weekday">–í—Å</div>
                    <div class="weekday">–ü–Ω</div>
                    <div class="weekday">–í—Ç</div>
                    <div class="weekday">–°—Ä</div>
                    <div class="weekday">–ß—Ç</div>
                    <div class="weekday">–ü—Ç</div>
                    <div class="weekday">–°–±</div>
                </div>
                <div id="calendarDays"></div>
             </div>

         <div class="calendar-cta">
            <!-- –†—è–¥ –∏–∑ 5 —Å–º–∞–π–ª–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è -->
            <button id="recordMoodBtn" class="btn btn--primary btn--xl" onclick="openMoodSlider()">
                –ó–∞–ø–∏—Å–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
            </button>
            <!-- –ö–Ω–æ–ø–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—Å—Ç–∞—ë—Ç—Å—è –≤–Ω–∏–∑—É -->
            <button class="btn btn--primary btn--xl" onclick="openStats()">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
          </div>
        </div>

<!-- Stats: –æ–¥–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –º–æ–¥–∞–ª–∫–∞ -->
        <div id="statsSheet" class="sheet" hidden>
          <div class="sheet__backdrop" onclick="closeStats()"></div>
        
          <div class="sheet__panel" id="statsPanel" role="dialog" aria-modal="true" aria-labelledby="statsTitle">
            <div class="sheet__header">
              <h3 id="statsTitle">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
              <button class="sheet__close btn btn--ghost" aria-label="–ó–∞–∫—Ä—ã—Ç—å" onclick="closeStats()">‚úï</button>
            </div>
        
            <div id="statsBody" style="display:grid; gap:12px;">
              <div class="stats-filters">
                <button class="filter-btn active" onclick="setStatsFilter('3days')">3 –¥–Ω—è</button>
                <button class="filter-btn" onclick="setStatsFilter('week')">–ù–µ–¥–µ–ª—è</button>
                <button class="filter-btn" onclick="setStatsFilter('month')">–ú–µ—Å—è—Ü</button>
                <button class="filter-btn" onclick="setStatsFilter('all')">–í—Å–µ –≤—Ä–µ–º—è</button>
              </div>
        
              <div class="correlation-section">
                <h3>üìä –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è –ø–æ —á–∞—Å–∞–º</h3>
                <div id="hourlyChart" class="hourly-chart"></div>
                <p style="font-size:12px; color:var(--text-secondary); text-align:center; margin-top:6px;">
                  –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —á–∞—Å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∑–∞–ø–∏—Å–∏
                </p>
              </div>
        
              <div class="overview-section">
                <h3>üìà –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (<span id="currentPeriod">3 –¥–Ω—è</span>)</h3>
                <div class="stat-row"><span class="stat-label">–•–æ—Ä–æ—à–∏–µ –∑–∞–ø–∏—Å–∏:</span><span class="stat-value stat-value--good" id="statsGoodPercent">0%</span></div>
                <div class="stat-row"><span class="stat-label">–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏:</span><span class="stat-value stat-value--neutral" id="statsNeutralPercent">0%</span></div>
                <div class="stat-row"><span class="stat-label">–ì—Ä—É—Å—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏:</span><span class="stat-value stat-value--sad" id="statsSadPercent">0%</span></div>
                <div class="total-records" id="statsTotalRecords">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: 0</div>
                <div class="stat-row"><span class="stat-label">–ó–∞–ø–∏—Å–µ–π –≤ –¥–µ–Ω—å:</span><span class="stat-value" id="avgPerDay">0</span></div>
                <div class="stat-row"><span class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –¥–Ω–µ–π:</span><span class="stat-value" id="activeDays">0</span></div>
              </div>
            </div>
        
            <button class="btn btn--ghost" style="margin-top:8px; width:100%;" onclick="closeStats()">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
        
        <div class="chat-page" id="chatPage">
          <div class="chat-header">
            <h2>–ò–ò –ß–∞—Ç</h2>
            <p>–°–ø—Ä–æ—Å–∏—Ç–µ —Å–æ–≤–µ—Ç –∏–ª–∏ –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å, –∫–∞–∫ –≤—ã —Å–µ–π—á–∞—Å.</p>
          </div>
        
          <div id="chatMessages" class="chat-messages"></div>
        
          <div class="chat-input-container">
            <textarea id="chatInput" class="chat-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
            <button id="sendButton" class="send-button" onclick="sendMessage()" disabled>‚û§</button>
          </div>
          <div class="chat-disclaimer">–≠—Ç–æ –Ω–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –ø–æ–º–æ—â—å. –ü—Ä–∏ —Ä–∏—Å–∫–∞—Ö ‚Äî –∑–≤–æ–Ω–∏—Ç–µ –≤ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–ª—É–∂–±—ã.</div>
        </div>
                <!-- ===== –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ü–û–ú–û–©–¨ ===== -->
        <div class="help-page" id="helpPage" style="display:none;">
          <div class="chat-header">
            <h2>–ü–æ–º–æ—â—å</h2>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:</p>
          </div>
        
          <div class="section-grid">
            <button class="card section-card" onclick="switchPage('therapy')">
              <div class="section-emoji">üßò‚Äç‚ôÄÔ∏è</div>
              <div class="section-title">–¢–µ—Ä–∞–ø–∏—è</div>
              <div class="section-sub">–î—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ –∏ —É—Å–ø–æ–∫–∞–∏–≤–∞—é—â–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏</div>
            </button>
        
            <button class="card section-card" onclick="switchPage('tests')">
              <div class="section-emoji">üß©</div>
              <div class="section-title">–¢–µ—Å—Ç—ã</div>
              <div class="section-sub">–û—Ü–µ–Ω–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è, –≤—ã–≥–æ—Ä–∞–Ω–∏—è, –ª–∏—á–Ω–æ—Å—Ç–∏</div>
            </button>
          </div>
        </div>
        
        <!-- ===== –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¢–ï–†–ê–ü–ò–Ø ===== -->
        <div class="therapy-page" id="therapyPage" style="display:none;">
          <div class="chat-header">
            <h2>–¢–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏</h2>
            <p>–ü—Ä–æ—Å—Ç—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å</p>
          </div>
        
          <div class="content-list">
            <div class="card">
              <h3 style="margin-bottom:8px;">–î—ã—Ö–∞–Ω–∏–µ 4‚Äì7‚Äì8</h3>
              <p>–í–¥–æ—Ö 4 —Å–µ–∫ ‚Üí –∑–∞–¥–µ—Ä–∂–∫–∞ 7 —Å–µ–∫ ‚Üí –≤—ã–¥–æ—Ö 8 —Å–µ–∫. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å 4‚Äì6 –∫—Ä—É–≥–æ–≤.</p>
                    <button class="btn btn--primary" onclick="PracticeEngine.openById('478')">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
            </div>
        
            <div class="card">
              <h3 style="margin-bottom:8px;">–ó–∞–∑–µ–º–ª–µ–Ω–∏–µ 5-4-3-2-1</h3>
              <p>–ù–∞–∑–æ–≤–∏—Ç–µ: 5 —á—Ç–æ –≤–∏–¥–∏—Ç–µ, 4 —á—Ç–æ –æ—â—É—â–∞–µ—Ç–µ, 3 –∑–≤—É–∫–∞, 2 –∑–∞–ø–∞—Ö–∞, 1 –≤–∫—É—Å.</p>
                     <button class="btn btn--primary" onclick="PracticeEngine.openById('54321')">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
            </div>
          </div>
            
        </div>
        
        <!-- ===== –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¢–ï–°–¢–´ ===== -->
        <div class="tests-page" id="testsPage" style="display:none;">
          <div class="chat-header">
            <h2>–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã</h2>
            <p>–ë—ã—Å—Ç—Ä—ã–µ —Å–∫—Ä–∏–Ω–∏–Ω–≥–∏ –∏ –æ–ø—Ä–æ—Å–Ω–∏–∫–∏</p>
          </div>
        
          <div class="content-list">
            <div class="card">
              <h3 style="margin-bottom:8px;">PHQ-2 (—Å–∫—Ä–∏–Ω–∏–Ω–≥ –¥–µ–ø—Ä–µ—Å—Å–∏–∏)</h3>
              <p>2 –≤–æ–ø—Ä–æ—Å–∞, ~30 —Å–µ–∫—É–Ω–¥. –ù–µ –∑–∞–º–µ–Ω—è–µ—Ç –¥–∏–∞–≥–Ω–æ–∑.</p>
              <button class="btn btn--primary" style="margin-top:12px;" onclick="openTest('phq2')">–ü—Ä–æ–π—Ç–∏</button>
            </div>
        
            <div class="card">
              <h3 style="margin-bottom:8px;">GAD-2 (—Å–∫—Ä–∏–Ω–∏–Ω–≥ —Ç—Ä–µ–≤–æ–≥–∏)</h3>
              <p>2 –≤–æ–ø—Ä–æ—Å–∞, ~30 —Å–µ–∫—É–Ω–¥. –ù–µ –∑–∞–º–µ–Ω—è–µ—Ç –¥–∏–∞–≥–Ω–æ–∑.</p>
              <button class="btn btn--primary" style="margin-top:12px;" onclick="openTest('gad2')">–ü—Ä–æ–π—Ç–∏</button>
            </div>
          </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            
            <button class="nav-item active" id="navCalendar" onclick="switchPage('calendar')">
                <div class="nav-icon">üìÖ</div>
                <div>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
            </button>
            
            <button class="nav-item" id="navChat" onclick="switchPage('chat')">
                <div class="nav-icon">ü§ñ</div>
                <div>–ò–ò –ß–∞—Ç</div>
            </button>

            <button class="nav-item" id="navHelp" onclick="switchPage('help')">
              <div class="nav-icon">üÜò</div>
              <div>–ü–æ–º–æ—â—å</div>
            </button>
            
        </div>
    </div>
    

<!-- ===== Therapy Modal ===== -->
        <div id="therapyPopup" class="mood-popup hidden">
          <div class="mood-popup-content" style="max-width:420px">
            <h3 id="therapyTitle">–¢–µ—Ä–∞–ø–∏—è</h3>
            <p id="therapySubtitle">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏</p>
        
            <div class="thermo">
              <div class="ring" id="thermoRing">
                <div class="ring-inner">
                  <div id="thermoPhase" class="phase">–ì–æ—Ç–æ–≤—ã?</div>
                  <div id="thermoTime" class="time">00</div>
                </div>
              </div>
            </div>
        
            <div id="therapyHint" class="therapy-hint"></div>
        
            <div class="therapy-actions">
              <button class="btn btn--primary" id="therapyStartBtn">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
              <button class="btn" id="therapyStopBtn">‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            </div>
        
            <button class="skip-btn" onclick="closeTherapy()">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>

        <!-- ===== Test Modal ===== -->
        <div id="testPopup" class="mood-popup hidden">
          <div class="mood-popup-content" style="max-width:520px">
            <h3 id="testTitle">–¢–µ—Å—Ç</h3>
            <p id="testDesc">–ö–æ—Ä–æ—Ç–∫–∏–π —Å–∫—Ä–∏–Ω–∏–Ω–≥</p>
        
            <div id="testFormHost" style="display:grid; gap:12px; margin:12px 0;"></div>
        
            <div class="therapy-actions" style="margin-top:4px;">
              <button class="btn btn--primary" id="testSubmitBtn">–ì–æ—Ç–æ–≤–æ</button>
              <button class="btn" id="testCancelBtn">–û—Ç–º–µ–Ω–∞</button>
            </div>
        
            <button class="skip-btn" onclick="closeTest()">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>

       <div id="moodSliderPopup" class="mood-popup hidden">
          <div class="mood-popup-content">
            <h3>–ö–∞–∫ –≤—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—Ç–µ?</h3>

            <div class="mood-range-row">
              <!-- –°–õ–ï–í–ê ‚Äî –≥—Ä—É—Å—Ç–Ω—ã–π -->
              <span class="mood-emoji" aria-hidden="true" title="–ü–ª–æ—Ö–æ">üò¢</span>

              <input
                id="moodSlider"
                type="range"
                min="-5" max="5" step="1" value="0"
                class="mood-range"
                aria-label="–ü–æ–ª–∑—É–Ω–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –æ—Ç ‚àí5 –¥–æ +5">

              <!-- –°–ü–†–ê–í–ê ‚Äî —Å—á–∞—Å—Ç–ª–∏–≤—ã–π -->
              <span class="mood-emoji" aria-hidden="true" title="–•–æ—Ä–æ—à–æ">üòÑ</span>
            </div>

            <div class="mood-actions">
              <button class="btn btn--primary" onclick="confirmMoodScore()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
              <button class="link-btn" onclick="closeMoodSlider()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
          </div>
        </div>


       <script>
           
    window.PRACTICES = [
      {
        id: "478",
        title: "–î—ã—Ö–∞–Ω–∏–µ 4‚Äì7‚Äì8",
        subtitle: "–í–¥–æ—Ö 4 —Å–µ–∫ ‚Üí –∑–∞–¥–µ—Ä–∂–∫–∞ 7 ‚Üí –≤—ã–¥–æ—Ö 8. –ü–æ–≤—Ç–æ—Ä–∏–º 4 –∫—Ä—É–≥–∞.",
        type: "timer",
        cycles: 4,
        phases: [
          { name: "–í–¥–æ—Ö",     seconds: 4, hint: "–ú–µ–¥–ª–µ–Ω–Ω—ã–π –≤–¥–æ—Ö –Ω–æ—Å–æ–º" },
          { name: "–ó–∞–¥–µ—Ä–∂–∫–∞", seconds: 7, hint: "–ù–µ –¥—ã—à–∏–º, —Å–ø–æ–∫–æ–π–Ω–æ"   },
          { name: "–í—ã–¥–æ—Ö",    seconds: 8, hint: "–î–ª–∏–Ω–Ω—ã–π –≤—ã–¥–æ—Ö —Ä—Ç–æ–º"   }
        ]
      },
      {
        id: "54321",
        title: "–ó–∞–∑–µ–º–ª–µ–Ω–∏–µ 5-4-3-2-1",
        subtitle: "–ù–∞–∑–æ–≤–∏—Ç–µ: 5 –≤–∏–∂—É, 4 –æ—â—É—â–∞—é, 3 —Å–ª—ã—à—É, 2 –∑–∞–ø–∞—Ö–∞, 1 –≤–∫—É—Å.",
        type: "steps",
        steps: [
          "–ù–∞–∑–æ–≤–∏—Ç–µ 5 –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –≤–∏–¥–∏—Ç–µ.",
          "–ù–∞–∑–æ–≤–∏—Ç–µ 4 –≤–µ—â–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ—â—É—â–∞–µ—Ç–µ —Ç–µ–ª–æ–º.",
          "–ù–∞–∑–æ–≤–∏—Ç–µ 3 –∑–≤—É–∫–∞, –∫–æ—Ç–æ—Ä—ã–µ —Å–ª—ã—à–∏—Ç–µ.",
          "–ù–∞–∑–æ–≤–∏—Ç–µ 2 –∑–∞–ø–∞—Ö–∞.",
          "–ù–∞–∑–æ–≤–∏—Ç–µ 1 –≤–∫—É—Å (–∏–ª–∏ —Å–¥–µ–ª–∞–π—Ç–µ –≥–ª–æ—Ç–æ–∫ –≤–æ–¥—ã)."
        ]
      }
    ];
    </script>

        <script>
    (function () {
      // –ü—É–±–ª–∏—á–Ω–æ–µ API
      window.PracticeEngine = {
        openById(id) {
          const cfg = (window.PRACTICES || []).find(p => p.id === id);
          if (!cfg) return console.warn("[practice] not found", id);
          openModal(cfg);
        }
      };
    
      let timer = null;
      let state = null;
    
      function openModal(cfg) {
        state = {
          cfg,
          running: false,
          paused: false,   // ‚Üê —Ñ–ª–∞–≥ –ø–∞—É–∑—ã
          cycle: 0,
          phaseIndex: 0,   // ‚Üê –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–π —Ñ–∞–∑—ã (–≤–¥–æ—Ö/–∑–∞–¥–µ—Ä–∂–∫–∞/–≤—ã–¥–æ—Ö)
          left: 0,         // ‚Üê –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Å–µ–∫—É–Ω–¥—ã –≤ —Ñ–∞–∑–µ
          step: 0
        };
    
        // –ó–∞–≥–æ–ª–æ–≤–∫–∏
        setText('therapyTitle', cfg.title);
        setText('therapySubtitle', cfg.subtitle);
    
        // –í–∏–¥–∏–º–æ—Å—Ç—å —Ç–∞–π–º–µ—Ä–∞: —Ç–æ–ª—å–∫–æ –¥–ª—è type: "timer"
        setTimeVisible(cfg.type === "timer");
        setTime("");               // –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        setPhase("–ì–æ—Ç–æ–≤—ã?");
        setHint("");
        setRing(0);
    
        // –ö–Ω–æ–ø–∫–∏
        byId('therapyStartBtn').onclick = start;
        byId('therapyStopBtn').onclick  = stop;
        byId('therapyStartBtn').textContent = "–ó–∞–ø—É—Å—Ç–∏—Ç—å"; 
    
        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É
        byId('therapyPopup').classList.remove('hidden');
        document.body.classList.add('modal-open');
      }
    
    function start() {
      // –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º state, —Ç–æ–ª—å–∫–æ —Å–Ω–∏–º–∞–µ–º –ø–∞—É–∑—É
      state.running = true;
      state.paused  = false;
    
      const { cfg } = state;
    
      if (cfg.type === "timer") {
        setTimeVisible(true);
        // –µ—Å–ª–∏ –µ—Å—Ç—å, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å —Ç–µ–∫—É—â–µ–π —Ñ–∞–∑—ã –∏ –æ—Å—Ç–∞—Ç–∫–∞
        if (state.left > 0) {
          continueTimerPhase();
        } else {
          // –∑–∞–ø—É—Å–∫ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞
          state.cycle = 0;
          state.phaseIndex = 0;
          runTimerCycle();
        }
      } 
          else if (cfg.type === "steps") {
            setTimeVisible(false);
            // –µ—Å–ª–∏ —É–∂–µ –±—ã–ª–∏ –Ω–∞ —à–∞–≥–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∏–º –µ–≥–æ
            showStep();
      }
    }

        function stop() {
      if (timer) { clearInterval(timer); timer = null; }
      if (!state) return;
    
      state.running = false;
      state.paused  = true;
    
      setPhase("–ü–∞—É–∑–∞");
      setHint("");
      // –∫–æ–ª—å—Ü–æ/–≤—Ä–µ–º—è –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å ‚Äî –≤–∏–¥–Ω–æ, –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å
    
      const startBtn = byId('therapyStartBtn');
    
      if (state.cfg.type === "steps") {
        setTimeVisible(false);
        startBtn.textContent = "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å";
        startBtn.onclick = () => { state.running = true; state.paused = false; showStep(); };
      } else {
        // timer
        setTimeVisible(true);
        startBtn.textContent = "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å";
        startBtn.onclick = start; // –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç —Å —Ç–µ–∫—É—â–∏—Ö phaseIndex/left
      }
    }

      // ===== timer-–ø—Ä–∞–∫—Ç–∏–∫–∏ (—Ñ–∞–∑—ã √ó —Ü–∏–∫–ª—ã)
    // –ó–ê–ú–ï–ù–ê runTimerCycle —Ü–µ–ª–∏–∫–æ–º
    function runTimerCycle() {
      const { cfg } = state;
      if (!state.running) return;
    
      // –∑–∞–∫–æ–Ω—á–∏–ª–∏ –≤—Å–µ —Ü–∏–∫–ª—ã
      if (state.cycle >= (cfg.cycles || 1)) {
        setPhase("–ì–æ—Ç–æ–≤–æ!");
        setTime("");
        setHint("–û—Ç–ª–∏—á–Ω–æ ‚ú®");
        setRing(360);
        return;
      }
    
      // –µ—Å–ª–∏ —Ñ–∞–∑—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å ‚Äî —Å–ª–µ–¥—É—é—â–∏–π —Ü–∏–∫–ª
      if (state.phaseIndex >= cfg.phases.length) {
        state.cycle++;
        state.phaseIndex = 0;
      }
    
      continueTimerPhase(); // –ø–µ—Ä–µ–π—Ç–∏/–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ñ–∞–∑—É
    }
    
    // –ù–û–í–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è ‚Äî –≤—Å—Ç–∞–≤—å —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ runTimerCycle
    function continueTimerPhase() {
      const { cfg } = state;
      if (!state.running) return;
    
      const phase = cfg.phases[state.phaseIndex];
      if (!phase) { runTimerCycle(); return; }
    
      // –µ—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –≤–ø–µ—Ä–≤—ã–µ/–ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ ‚Äî –∑–∞–ø–æ–ª–Ω—è–µ–º left
      if (!state.left || state.left <= 0) {
        state.left = phase.seconds;
      }
    
      setPhase(`${phase.name} (—Ü–∏–∫–ª ${state.cycle + 1}/${cfg.cycles || 1})`);
      setHint(phase.hint || "");
      setRing(360 * (1 - state.left / phase.seconds));
      setTime(state.left);
    
      if (timer) clearInterval(timer);
      timer = setInterval(() => {
        if (!state.running) { clearInterval(timer); timer = null; return; }
    
        state.left--;
        setTime(Math.max(state.left, 0));
    
        const done = (phase.seconds - state.left) / phase.seconds;
        setRing(Math.min(360 * done, 360));
    
        if (state.left <= 0) {
          clearInterval(timer); timer = null;
          setRing(360);
          // –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π —Ñ–∞–∑–µ
          state.phaseIndex++;
          state.left = 0;
          setTimeout(runTimerCycle, 180);
        }
      }, 1000);
    }

    
      // ===== step-–ø—Ä–∞–∫—Ç–∏–∫–∏ (–ø–æ—à–∞–≥–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏, –±–µ–∑ —Ç–∞–π–º–µ—Ä–∞)
      function showStep() {
        const { cfg } = state;
        if (!state.running) return;
    
        if (state.step >= cfg.steps.length) {
          setPhase("–ì–æ—Ç–æ–≤–æ!");
          setTime("");             // –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–∏—Ñ—Ä—ã
          setHint("–í—ã –º–æ–ª–æ–¥–µ—Ü ‚ú®");
          setRing(360);
          return;
        }
    
        setPhase(`–®–∞–≥ ${state.step + 1}/${cfg.steps.length}`);
        setHint(cfg.steps[state.step]);
        setRing(0);
    
        // –ö–Ω–æ–ø–∫–∞ ¬´–î–∞–ª–µ–µ/–ó–∞–≤–µ—Ä—à–∏—Ç—å¬ª
        const startBtn = byId('therapyStartBtn');
        startBtn.textContent = (state.step < cfg.steps.length - 1) ? "–î–∞–ª–µ–µ" : "–ó–∞–≤–µ—Ä—à–∏—Ç—å";
        startBtn.onclick = () => { state.step++; showStep(); };
      }
    
      // ===== helpers (UI)
      function setPhase(t){ setText('thermoPhase', t); }
      function setTime(v){  setText('thermoTime', v === "" ? "" : String(v).padStart(2,"0")); }
      function setHint(t){  setText('therapyHint', t || ""); }
      function setRing(deg){
        const ring = byId('thermoRing'); if (!ring) return;
        const brand = getComputedStyle(document.documentElement).getPropertyValue("--brand").trim();
        ring.style.background = `conic-gradient(${brand} ${deg}deg, rgba(0,0,0,0.08) 0)`;
      }
      function setTimeVisible(show){
        const el = byId('thermoTime');
        if (el) el.style.display = show ? '' : 'none';
      }
      function setText(id, txt){ const el = byId(id); if (el) el.textContent = txt; }
      function byId(id){ return document.getElementById(id); }
    
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
      window.closeTherapy = function(){
        stop();
        byId('therapyPopup')?.classList.add('hidden');
        document.body.classList.remove('modal-open');
      };
    })();
    </script>

    
    <script>
    window.TESTS = [
      {
        id: "phq2",
        title: "PHQ-2 (—Å–∫—Ä–∏–Ω–∏–Ω–≥ –¥–µ–ø—Ä–µ—Å—Å–∏–∏)",
        description: "2 –≤–æ–ø—Ä–æ—Å–∞, ~30 —Å–µ–∫. –ù–µ –∑–∞–º–µ–Ω—è–µ—Ç –¥–∏–∞–≥–Ω–æ–∑.",
        scale: [ "–ù–∏–∫–æ–≥–¥–∞", "–ù–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π", "–ë–æ–ª–µ–µ –ø–æ–ª–æ–≤–∏–Ω—ã –¥–Ω–µ–π", "–ü–æ—á—Ç–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å" ],
        questions: [
          "–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏ ‚Äî –º–∞–ª–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞ –∏–ª–∏ —Ä–∞–¥–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, —á—Ç–æ –≤—ã –¥–µ–ª–∞–µ—Ç–µ?",
          "–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏ ‚Äî –ø–æ–¥–∞–≤–ª–µ–Ω–Ω–æ–µ, —É–≥–Ω–µ—Ç—ë–Ω–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ?"
        ],
        scoring: { 0:0, 1:1, 2:2, 3:3 },
        resultText(score){ return score >= 3 ? "–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–Ω–∏–Ω–≥ (–æ–±—Å—É–¥–∏—Ç–µ —Å –≤—Ä–∞—á–æ–º)." : "–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–Ω–∏–Ω–≥."; }
      },
      {
        id: "gad2",
        title: "GAD-2 (—Å–∫—Ä–∏–Ω–∏–Ω–≥ —Ç—Ä–µ–≤–æ–≥–∏)",
        description: "2 –≤–æ–ø—Ä–æ—Å–∞, ~30 —Å–µ–∫. –ù–µ –∑–∞–º–µ–Ω—è–µ—Ç –¥–∏–∞–≥–Ω–æ–∑.",
        scale: [ "–ù–∏–∫–æ–≥–¥–∞", "–ù–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π", "–ë–æ–ª–µ–µ –ø–æ–ª–æ–≤–∏–Ω—ã –¥–Ω–µ–π", "–ü–æ—á—Ç–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å" ],
        questions: [
          "–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏ ‚Äî –æ—â—É—â–µ–Ω–∏–µ –Ω–µ—Ä–≤–æ–∑–Ω–æ—Å—Ç–∏, —Ç—Ä–µ–≤–æ–≥–∏ –∏–ª–∏ –Ω–∞–ø—Ä—è–∂—ë–Ω–Ω–æ—Å—Ç–∏?",
          "–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏ ‚Äî —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ –≤ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∏–ª–∏ –∫–æ–Ω—Ç—Ä–æ–ª–µ –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏–π?"
        ],
        scoring: { 0:0, 1:1, 2:2, 3:3 },
        resultText(score){ return score >= 3 ? "–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–Ω–∏–Ω–≥ (–æ–±—Å—É–¥–∏—Ç–µ —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º)." : "–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–Ω–∏–Ω–≥."; }
      }
    ];
    </script>

    <script>
    (function(){
      window.TestEngine = {
        openById(id){
          const cfg = (window.TESTS || []).find(t => t.id === id);
          if (!cfg) { console.warn('[test] not found', id); return; }
          render(cfg);
        }
      };
    
      function render(cfg){
        setText('testTitle', cfg.title || '–¢–µ—Å—Ç');
        setText('testDesc',  cfg.description || '');
        const host = byId('testFormHost'); host.innerHTML = '';
        cfg.questions.forEach((q, qi) => {
          const block = document.createElement('div');
          block.className = 'card test-card';
          block.innerHTML = `
            <div class="test-question">${q}</div>
            <div class="test-options">
              ${cfg.scale.map((opt, oi) => `
                <label style="display:flex; gap:8px; align-items:center;">
                  <input type="radio" name="q${qi}" value="${oi}">
                  <span>${opt}</span>
                </label>`).join('')}
            </div>`;
          host.appendChild(block);
        });
        byId('testSubmitBtn').onclick = () => submit(cfg);
        byId('testCancelBtn').onclick = closeTest;
        byId('testPopup').classList.remove('hidden');
        document.body.classList.add('modal-open');
      }
    
      function submit(cfg){
        let sum = 0, answered = 0;
        cfg.questions.forEach((_, qi) => {
          const v = document.querySelector(`input[name="q${qi}"]:checked`)?.value;
          if (v != null) { answered++; sum += (cfg.scoring?.[v] ?? 0); }
        });
        if (answered < cfg.questions.length) { alert('–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã.'); return; }
        const result = (typeof cfg.resultText === 'function') ? cfg.resultText(sum) : `–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${sum}`;
        alert(`${cfg.title}\n–°—É–º–º–∞ –±–∞–ª–ª–æ–≤: ${sum}\n${result}`);
        closeTest();
      }
    
      function setText(id, txt){ const el = byId(id); if (el) el.textContent = txt; }
      function byId(id){ return document.getElementById(id); }
      window.closeTest = function(){
        byId('testPopup')?.classList.add('hidden');
        document.body.classList.remove('modal-open');
      };
    })();
    </script>

    <script>
        // Application state
        let currentDate = new Date();
        let selectedDate = new Date();
        let moodData = {};
        let dailyMoods = {};
        let currentPage = 'calendar';
        let currentStatsFilter = '3days';
        let dailyScores = {};
        let dailyTotals = {};
        const DAILY_MIN = -50;
        const DAILY_MAX = 50;

        // Mood types
        const moodTypes = {
            // –°—Ç–∞—Ä—ã–µ –∫–ª—é—á–∏ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏). good ‚Üí positive, neutral ‚Üí neutral, sad ‚Üí –ø–µ—á–∞–ª—å
            good:    { name: '–•–æ—Ä–æ—à–µ–µ' },
            neutral: { name: '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ' },
            sad:     { name: '–ü–µ—á–∞–ª—å–Ω–æ–µ' },
            // –ù–æ–≤–∞—è —à–∫–∞–ª–∞ –∏–∑ 5 –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π
            happy:   { name: '–û—á–µ–Ω—å —Ö–æ—Ä–æ—à–µ–µ' },
            pleased: { name: '–•–æ—Ä–æ—à–µ–µ' },
            sorrow:  { name: '–û—á–µ–Ω—å –≥—Ä—É—Å—Ç–Ω–æ–µ' }
        };

        const monthNames = [
            '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
            '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
        ];

        // Initialize app
         // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
         await runMigrationsIfNeeded();   // ‚Üê –¥–æ–±–∞–≤–∏–ª–∏‚êä
          setupThemeToggle();
          loadData();
          updateCalendar();
          renderTodayScore();
          checkNotificationPermission();
          scheduleNotifications();
          switchPage('calendar');
          document.getElementById('addMoodBtn')?.addEventListener('click', openMoodSlider);

          setupChatInput();
          maybeProactiveChat();
          enableStatsSwipe();
        });

         // Theme management
        function setTheme(theme) {
          const t = theme === 'dark' ? 'dark' : 'light';
          document.documentElement.setAttribute('data-theme', t);
          localStorage.setItem('theme', t);
          const btn = document.getElementById('themeToggle');
          if (btn) {
            btn.setAttribute('aria-pressed', String(t === 'dark'));
          }
        }

        function toggleTheme() {
          const current = document.documentElement.getAttribute('data-theme') || 'light';
          setTheme(current === 'light' ? 'dark' : 'light');
        }

        function setupThemeToggle(){
          const btn = document.getElementById('themeToggle');
          if (!btn) return;
          btn.addEventListener('click', toggleTheme);
          const current = document.documentElement.getAttribute('data-theme') || 'light';
          btn.setAttribute('aria-pressed', String(current === 'dark'));
        }

        (function bootTheme(){
          const legacy = localStorage.getItem('moodCalendarTheme');
          if (legacy === 'light' || legacy === 'dark') {
            localStorage.setItem('theme', legacy);
            localStorage.removeItem('moodCalendarTheme');
          }

          const saved = localStorage.getItem('theme');
          setTheme(saved === 'dark' ? 'dark' : 'light');
        })();

        function getCSSVariable(variableName) {
            return getComputedStyle(document.documentElement).getPropertyValue(variableName).trim();
        }

        function renderTodayScore() {
          const el = document.getElementById('todayScoreBadge');
          if (!el) return;

          const today = new Date(); today.setHours(0,0,0,0);
          const key = getDateKey(today);
          const avg = dailyScores?.[key];

          let varName = '--score-zero';
          if (typeof avg === 'number') {
            if (avg >= 2.5)      varName = '--score-pos3';
            else if (avg >= 1.5) varName = '--score-pos2';
            else if (avg >= 0.5) varName = '--score-pos1';
            else if (avg > -0.5) varName = '--score-zero';
            else if (avg > -1.5) varName = '--score-neg1';
            else if (avg > -2.5) varName = '--score-neg2';
            else                 varName = '--score-neg3';
          }

          el.style.setProperty('--today-color', `var(${varName})`);

          const show = typeof avg === 'number'
            ? ((avg>0?'+':'') + (Math.round(avg*10)/10))
            : '+0';

          el.textContent = `–°–µ–≥–æ–¥–Ω—è: ${show}`;
          el.classList.remove('hidden');
        }
        function getCSSVariable(variableName) {
            return getComputedStyle(document.documentElement).getPropertyValue(variableName).trim();
        }

        function renderTodayScore() {
          const el = document.getElementById('todayScoreBadge');
          if (!el) return;

          const today = new Date(); today.setHours(0,0,0,0);
          const key = getDateKey(today);
          const avg = dailyScores?.[key];

          let varName = '--score-zero';
          if (typeof avg === 'number') {
            if (avg >= 2.5)      varName = '--score-pos3';
            else if (avg >= 1.5) varName = '--score-pos2';
            else if (avg >= 0.5) varName = '--score-pos1';
            else if (avg > -0.5) varName = '--score-zero';
            else if (avg > -1.5) varName = '--score-neg1';
            else if (avg > -2.5) varName = '--score-neg2';
            else                 varName = '--score-neg3';
          }

          el.style.setProperty('--today-color', `var(${varName})`);

          const show = typeof avg === 'number'
            ? ((avg>0?'+':'') + (Math.round(avg*10)/10))
            : '+0';

          el.textContent = `–°–µ–≥–æ–¥–Ω—è: ${show}`;
          el.classList.remove('hidden');
        }

        function switchPage(page) {
          currentPage = page;

          // —Å—Ç—Ä–∞–Ω–∏—Ü—ã
          const calendarPage = document.getElementById('calendarPage');
          const chatPage     = document.getElementById('chatPage');
          const helpPage     = document.getElementById('helpPage');
          const therapyPage  = document.getElementById('therapyPage');
          const testsPage    = document.getElementById('testsPage');
        
          // –Ω–∞–≤–∏–≥–∞—Ü–∏—è
          const navCalendar  = document.getElementById('navCalendar');
          const navChat      = document.getElementById('navChat');
          const navHelp      = document.getElementById('navHelp');
        
          // CTA
          const cta = document.querySelector('.calendar-cta');
        
          // 1) –°–∫—Ä—ã—Ç—å –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–∏ —Å–Ω—è—Ç—å —Å–ø–µ—Ü-–∫–ª–∞—Å—Å —É —á–∞—Ç–∞)
          [calendarPage, chatPage, helpPage, therapyPage, testsPage].forEach(el => {
            if (el) el.style.display = 'none';
          });
          chatPage?.classList.remove('active');
        
          // 2) –°–±—Ä–æ—Å–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É –≤—Å–µ—Ö —Ç–∞–±–æ–≤
          [navCalendar, navChat, navHelp].forEach(el => el?.classList.remove('active'));
        
          // 3) –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É + –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å CTA –∏ –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–±
          if (page === 'calendar') {
            calendarPage && (calendarPage.style.display = 'block');
            cta && (cta.style.display = 'flex');
            navCalendar?.classList.add('active');
          } else if (page === 'chat') {
            chatPage && (chatPage.style.display = 'flex');
            chatPage?.classList.add('active');                 // –≤–µ—Ä–Ω—É—Ç—å –∫–ª–∞—Å—Å –¥–ª—è —Ç–≤–æ–∏—Ö CSS
            cta && (cta.style.display = 'none');
            navChat?.classList.add('active');
            setTimeout(() => document.getElementById('chatInput')?.focus(), 100);
          } else if (page === 'help') {
            helpPage && (helpPage.style.display = 'block');
            cta && (cta.style.display = 'none');
            navHelp?.classList.add('active');
          } else if (page === 'therapy') {
            therapyPage && (therapyPage.style.display = 'block');
            cta && (cta.style.display = 'none');
            navHelp?.classList.add('active');
          } else if (page === 'tests') {
            testsPage && (testsPage.style.display = 'block');
            cta && (cta.style.display = 'none');
            navHelp?.classList.add('active');
          }
        
          // 4) –§–ª–∞–≥ –Ω–∞ body ‚Äî –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –≤ —Å—Ç–∏–ª—è—Ö
          document.body.classList.toggle('on-calendar', page === 'calendar');
        }



        function autoResize(ta, max = 160) {
          ta.style.height = 'auto';
          ta.style.height = Math.min(ta.scrollHeight, max) + 'px';
        }

        // Chat functionality
        function setupChatInput() {
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            if (!chatInput || !sendButton) return;
            autoResize(chatInput);
            chatInput.addEventListener('input', function () {
                autoResize(this);                      
                sendButton.disabled = !this.value.trim();
            });
            chatInput.addEventListener('focus', function () {
                autoResize(this);
            });
            chatInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                  e.preventDefault();
                  sendMessage();
                }
            });
        }
        
        const isLocal = ['localhost', '127.0.0.1'].includes(location.hostname) || location.hostname === '';
        const isVercel = location.hostname.endsWith('.vercel.app');
        
        const API_BASE = (isLocal || isVercel)
          ? '' // –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å => /api/chat
          : 'https://mood-calendar-omega.vercel.app'; // –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å GitHub Pages
        
        async function askAI(userText) {
          const summary = getMoodSummary(14);
          const payload = {
            messages: [
              { role: 'system', content:
                '–¢—ã –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫. –ì–æ–≤–æ—Ä–∏ –∫—Ä–∞—Ç–∫–æ, —ç–º–ø–∞—Ç–∏—á–Ω–æ, –±–µ–∑ –¥–∏–∞–≥–Ω–æ–∑–æ–≤. ' +
                '–ü—Ä–µ–¥–ª–∞–≥–∞–π –ø—Ä–æ—Å—Ç—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ (–¥—ã—Ö–∞–Ω–∏–µ 4-7-8, –ø—Ä–æ–≥—É–ª–∫–∞, –∑–∞–ø–∏—Å—å –º—ã—Å–ª–µ–π, –ø–µ—Ä–µ–æ—Ü–µ–Ω–∫–∞). ' +
                '–ï—Å–ª–∏ –µ—Å—Ç—å —Ä–∏—Å–∫ —Å–µ–±–µ/–¥—Ä—É–≥–∏–º ‚Äî –º—è–≥–∫–æ –¥–∞–π –∫–æ–Ω—Ç–∞–∫—Ç—ã —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π –ø–æ–º–æ—â–∏ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.'
              },
              { role: 'assistant', content:
                `–ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö ${summary.daysConsidered} –¥–Ω–µ–π: —Ö–æ—Ä–æ—à–∏–µ=${summary.counts.good}, –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ=${summary.counts.neutral}, –≥—Ä—É—Å—Ç–Ω—ã–µ=${summary.counts.sad}.`
              },
              { role: 'user', content: userText }
            ]
          };
        
          const res = await fetch(`${API_BASE}/api/chat`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
        
          if (!res.ok) throw new Error(await res.text());
          const data = await res.json();
          return (data.reply || '').trim();
        }

        function sendMessage() {
          const chatInput = document.getElementById('chatInput');
          const sendBtn   = document.getElementById('sendButton');
          const message   = chatInput.value.trim();
        
          // 1) –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–µ
          if (!message) return;
        
          // 2) –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          addMessage('user', message);
        
          // 3) —á–∏—Å—Ç–∏–º –ø–æ–ª–µ –∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
          chatInput.value = '';
          chatInput.style.height = 'auto';
          sendBtn.disabled = true;
        
          // 4) –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
          showTypingIndicator();
        
          // 5) –∑–∞–ø—Ä–æ—Å –∫ –ò–ò
          askAI(message)
            .then(reply => {
              addMessage('ai', reply || '–ò–∑–≤–∏–Ω–∏, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç.');
            })
            .catch(err => {
              console.error(err);
              addMessage('ai', '–ü–æ—Ö–æ–∂–µ, —Å–µ—Ä–≤–∏—Å –∑–∞–Ω—è—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ —á—É—Ç—å –ø–æ–∑–∂–µ üôè');
            })
            .finally(() => {
              // 6) –≤—Å–µ–≥–¥–∞ —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä, —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å
              hideTypingIndicator();
              sendBtn.disabled = false;
              chatInput.focus();
            });
        }
        
        function startPractice(code){
          if (code === '478') {
            alert('–î—ã—Ö–∞–Ω–∏–µ 4‚Äì7‚Äì8: –≤–¥–æ—Ö 4 —Å–µ–∫ ‚Üí –∑–∞–¥–µ—Ä–∂–∫–∞ 7 ‚Üí –≤—ã–¥–æ—Ö 8. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ 4‚Äì6 —Ä–∞–∑.');
          } else if (code === '54321') {
            alert('–ó–∞–∑–µ–º–ª–µ–Ω–∏–µ 5-4-3-2-1: 5 –≤–∏–∂—É, 4 –æ—â—É—â–∞—é, 3 —Å–ª—ã—à—É, 2 –Ω—é—Ö–∞—é, 1 –ø—Ä–æ–±—É—é.');
          }
        }
        
        function openTest(name){
          if (name === 'phq2') {
            // —Ç—É—Ç –ø–æ—Ç–æ–º –≤—Å—Ç–∞–≤–∏–º —Ñ–æ—Ä–º—É/–ø–æ–¥—Å—á—ë—Ç –±–∞–ª–ª–æ–≤
            alert('PHQ-2: –¥–∞–ª—å—à–µ –¥–æ–±–∞–≤–∏–º —Ñ–æ—Ä–º—É —Å 2 –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –ª–æ–≥–∏–∫–æ–π –ø–æ–¥—Å—á—ë—Ç–∞.');
          } else if (name === 'gad2') {
            alert('GAD-2: –¥–∞–ª—å—à–µ –¥–æ–±–∞–≤–∏–º —Ñ–æ—Ä–º—É —Å 2 –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –ª–æ–≥–∏–∫–æ–π –ø–æ–¥—Å—á—ë—Ç–∞.');
          }
        }


        function addMessage(sender, text) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = text;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.textContent = '–ò–ò –ø–µ—á–∞—Ç–∞–µ—Ç...';
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Stats functionality
        function setStatsFilter(filter) {
            currentStatsFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                const btnOnClick = btn.getAttribute('onclick');
                if (btnOnClick && btnOnClick.includes(`'${filter}'`)) {
                    btn.classList.add('active');
                }
            });
            
            updateStatsPage();
        }

        function updateStatsPage() {
            updateHourlyChart();
            updateOverviewStats();
        }
        
        function openStats(){
          const sheet = document.getElementById('statsSheet');
          if (!sheet) return;
          sheet.hidden = false;
          document.body.classList.add('modal-open');  // –ø–æ –∂–µ–ª–∞–Ω–∏—é ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª —Ñ–æ–Ω–∞
          updateStatsPage();                           // —Ç–≤–æ—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è
        }
        function closeStats(){
          const sheet = document.getElementById('statsSheet');
          if (!sheet) return;
          sheet.hidden = true;
          document.body.classList.remove('modal-open');
        }
          // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω –∏ –ø–æ Esc

          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeStats();
          });
        
          // –°–≤–∞–π–ø-–≤–Ω–∏–∑ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ª–∏—Å—Ç–∞
// –°–≤–∞–π–ø-–≤–Ω–∏–∑ –∏–ª–∏ –≤–ª–µ–≤–æ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏
        function enableStatsSwipe() {
          const panel = document.querySelector('#statsSheet .sheet__panel'); // ‚Üê —Ç–∞–∫ –Ω–∞–¥—ë–∂–Ω–µ–µ
          if (!panel) return;
        
          let sx = 0, sy = 0, dx = 0, dy = 0;
        
          panel.addEventListener('touchstart', (e) => {
            const t = e.touches[0];
            sx = t.clientX; sy = t.clientY; dx = dy = 0;
          }, { passive: true });
        
          panel.addEventListener('touchmove', (e) => {
            const t = e.touches[0];
            dx = t.clientX - sx; dy = t.clientY - sy;
          }, { passive: true });
        
          panel.addEventListener('touchend', () => {
            if (Math.abs(dy) > 80 || Math.abs(dx) > 120) closeStats();
          });
        }



        function updateHourlyChart() {
            const today = new Date();
            const todayKey = getDateKey(today);
            const todayEntries = moodData[todayKey] || [];
            
            const hourlyChart = document.getElementById('hourlyChart');
            if (!hourlyChart) return;
            
            hourlyChart.innerHTML = '';
            
            for (let hour = 6; hour <= 23; hour++) {
                const hourBlock = document.createElement('div');
                hourBlock.className = 'hour-block';
                
                const hourEntries = todayEntries.filter(entry => entry.hour === hour);
                
                if (hourEntries.length > 0) {
                    const hourMoodCounts = hourEntries.reduce((acc, entry) => {
                        acc[entry.mood] = (acc[entry.mood] || 0) + 1;
                        return acc;
                    }, {});
                    
                    const dominantMood = Object.keys(hourMoodCounts).reduce((a, b) => 
                        hourMoodCounts[a] > hourMoodCounts[b] ? a : b
                    );
                    
                    const moodVar = `--mood-${dominantMood}`;
                    hourBlock.style.backgroundColor = `var(${moodVar})`;
                    hourBlock.classList.add('has-data');
                    hourBlock.title = `${hour}:00 - ${hourEntries.length} –∑–∞–ø–∏—Å–µ–π`;
                } else {
                    hourBlock.style.backgroundColor = 'transparent';
                    hourBlock.title = `${hour}:00 - –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π`;
                }
                
                hourBlock.textContent = hour;
                hourBlock.onclick = () => showHourDetails(hour, hourEntries);
                
                hourlyChart.appendChild(hourBlock);
            }
        }

        function showHourDetails(hour, entries) {
            if (entries.length === 0) {
                alert(`${hour}:00 - –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç`);
                return;
            }
            
            const details = entries.map(entry => {
                const time = `${entry.hour.toString().padStart(2, '0')}:${entry.minute.toString().padStart(2, '0')}`;
                const moodName = moodTypes[entry.mood].name;
                return `${time} - ${moodName}`;
            }).join('\n');
            
            alert(`${hour}:00\n${entries.length} –∑–∞–ø–∏—Å–µ–π:\n\n${details}`);
        }

        function updateOverviewStats() {
            const periodData = getDataForPeriod(currentStatsFilter);
            
            const currentPeriodElement = document.getElementById('currentPeriod');
            const statsGoodElement = document.getElementById('statsGoodPercent');
            const statsNeutralElement = document.getElementById('statsNeutralPercent');
            const statsSadElement = document.getElementById('statsSadPercent');
            const statsTotalElement = document.getElementById('statsTotalRecords');
            const avgPerDayElement = document.getElementById('avgPerDay');
            const activeDaysElement = document.getElementById('activeDays');
            
            if (!currentPeriodElement) return;
            
            currentPeriodElement.textContent = getPeriodName(currentStatsFilter);
            
            if (periodData.totalEntries === 0) {
                statsGoodElement.textContent = '0%';
                statsNeutralElement.textContent = '0%';
                statsSadElement.textContent = '0%';
                statsTotalElement.textContent = '–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: 0';
                avgPerDayElement.textContent = '0';
                activeDaysElement.textContent = '0';
                return;
            }
            
            // –°—É–º–º–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —à–∫–∞–ª—ã –≤ –æ–±—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: good (happy, pleased, good), neutral, sad (sad, sorrow).
            const moodCounts = periodData.moodCounts || {};
            const goodCount    = (moodCounts.good || 0) + (moodCounts.happy || 0) + (moodCounts.pleased || 0);
            const neutralCount = (moodCounts.neutral || 0);
            const sadCount     = (moodCounts.sad || 0) + (moodCounts.sorrow || 0);

            const goodPercent    = Math.round(goodCount    / periodData.totalEntries * 100);
            const neutralPercent = Math.round(neutralCount / periodData.totalEntries * 100);
            const sadPercent     = Math.round(sadCount     / periodData.totalEntries * 100);

            statsGoodElement.textContent    = `${goodPercent}%`;

            statsNeutralElement.textContent = `${neutralPercent}%`;

            statsSadElement.textContent     = `${sadPercent}%`;
            
            statsTotalElement.textContent = `–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${periodData.totalEntries}`;
            avgPerDayElement.textContent = (periodData.totalEntries / Math.max(periodData.days, 1)).toFixed(1);
            activeDaysElement.textContent = periodData.activeDays;
        }

        function getDataForPeriod(period) {
            const now = new Date();
            let startDate = new Date();
            
            switch (period) {
                case '3days':
                    startDate.setDate(now.getDate() - 3);
                    break;
                case 'week':
                    startDate.setDate(now.getDate() - 7);
                    break;
                case 'month':
                    startDate.setMonth(now.getMonth() - 1);
                    break;
                case 'all':
                    startDate = new Date('2020-01-01');
                    break;
            }
            
            let totalEntries = 0;
            let moodCounts = { good: 0, neutral: 0, sad: 0 };
            let activeDays = 0;
            
            Object.keys(moodData).forEach(dateKey => {
                const date = new Date(dateKey);
                if (date >= startDate && date <= now) {
                    const dayEntries = moodData[dateKey];
                    if (dayEntries && dayEntries.length > 0) {
                        activeDays++;
                        dayEntries.forEach(entry => {
                            totalEntries++;
                            moodCounts[entry.mood] = (moodCounts[entry.mood] || 0) + 1;
                        });
                    }
                }
            });
            
            const days = Math.max(Math.ceil((now - startDate) / (1000 * 60 * 60 * 24)), 1);
            
            return {
                totalEntries,
                moodCounts,
                activeDays,
                days
            };
        }

        function getPeriodName(period) {
            switch (period) {
                case '3days': return '3 –¥–Ω—è';
                case 'week': return '–Ω–µ–¥–µ–ª—è';
                case 'month': return '–º–µ—Å—è—Ü';
                case 'all': return '–≤—Å–µ –≤—Ä–µ–º—è';
                default: return period;
            }
        }

        // Notification functions
        function checkNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                document.getElementById('installPrompt').classList.remove('hidden');
            }
        }

        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    document.getElementById('installPrompt').classList.add('hidden');
                    new Notification('–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è', {
                        body: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã! –ú—ã –±—É–¥–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ.',
                        tag: 'mood-setup'
                    });
                    scheduleNotifications();
                }
            }
        }

        function scheduleNotifications() {
            if ('Notification' in window && Notification.permission === 'granted') {
                setInterval(showNotification, 60 * 1000);
            }
        }

        function showNotification() {
            if ('Notification' in window && Notification.permission === 'granted') {
                const now = new Date();
                const hour = now.getHours();
                const minute = now.getMinutes();
                
                const notificationTimes = [9, 15, 21];
                
                if (notificationTimes.includes(hour) && minute === 0) {
                    const timeOfDay = hour === 9 ? '–£—Ç—Ä–æ' : hour === 15 ? '–î–µ–Ω—å' : '–í–µ—á–µ—Ä';
                    const notification = new Notification(`${timeOfDay}: –í—Ä–µ–º—è –∑–∞–ø–∏—Å–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ! üòä`, {
                        body: '–ö–∞–∫ –≤—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—Ç–µ —Å–µ–π—á–∞—Å?',
                        tag: 'mood-reminder'
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        openMoodSlider();
                        notification.close();
                    };
                }
            }
        }
      
        const SCHEMA_KEY = 'moodSchemaVersion';
        const CURRENT_SCHEMA_VERSION = 3;
        
        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ JSON-—Ö–µ–ª–ø–µ—Ä—ã
        function getJson(key, fallback = null) {
          try {
            const raw = localStorage.getItem(key);
            return raw ? JSON.parse(raw) : fallback;
          } catch (e) {
            console.warn('[storage] broken JSON in', key, e);
            return fallback;
          }
        }
        function setJson(key, value) {
          localStorage.setItem(key, JSON.stringify(value));
        }
        
      
        const MIGRATIONS = [
          {
            version: 1,
            name: 'Normalize moodData to array-of-entries',
            run() {
              const raw = getJson('moodData', {});
              const normalized = {};
        
              Object.keys(raw || {}).forEach(dateKey => {
                const day = raw[dateKey];
        
                if (Array.isArray(day)) {
                  normalized[dateKey] = day; 
                  return;
                }
        
             
                const arr = [];
                if (day && typeof day === 'object') {
                  Object.keys(day).forEach(h => {
                    const hour = parseInt(h, 10);
                    arr.push({
                      hour,
                      minute: 0,
                      mood: day[h],
                      timestamp: new Date(`${dateKey}T${String(hour).padStart(2,'0')}:00:00`).getTime()
                    });
                  });
                }
                normalized[dateKey] = arr.sort((a,b) => a.timestamp - b.timestamp);
              });
        
              setJson('moodData', normalized);
            }
          },
          {
            version: 2,
            name: 'Recompute dailyMoods from moodData',
            run() {
              const md = getJson('moodData', {});
              const dm = {};
        
              Object.keys(md || {}).forEach(k => {
                const entries = md[k] || [];
                if (!entries.length) return;
                const counts = entries.reduce((acc, e) => {
                  acc[e.mood] = (acc[e.mood] || 0) + 1;
                  return acc;
                }, {});
                const dominant = Object.keys(counts).reduce((a,b) => counts[a] >= counts[b] ? a : b);
                dm[k] = dominant;
              });
        
              setJson('dailyMoods', dm);
            }
          },
          {
            version: 3,
            name: 'Ensure chat history key and cap length',
            run() {
              // –ø–µ—Ä–µ–Ω–æ—Å–∏–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ç–∞—Ä—ã–µ –∫–ª—é—á–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –∏—Å—Ç–æ—Ä–∏–∏
              const legacy = getJson('chat') ?? getJson('chatMessages', []);
              const arr = Array.isArray(legacy) ? legacy : [];
              setJson('chatMessages', arr.slice(-100));
              localStorage.removeItem('chat'); // —á–∏—Å—Ç–∏–º —Å—Ç–∞—Ä–æ–µ –∏–º—è –∫–ª—é—á–∞, –µ—Å–ª–∏ –±—ã–ª–æ
            }
          }
        ];
        
        async function runMigrationsIfNeeded() {
          let current = parseInt(localStorage.getItem(SCHEMA_KEY) || '0', 10);
        
          for (const m of MIGRATIONS) {
            if (m.version > current) {
              try {
                console.info(`[migrate] -> v${m.version}: ${m.name}`);
                await Promise.resolve(m.run());
                localStorage.setItem(SCHEMA_KEY, String(m.version));
                current = m.version;
              } catch (e) {
                console.error('[migrate] failed', m.version, m.name, e);
                break; // –æ—Å—Ç–∞–Ω–æ–≤–∏–º —Ü–µ–ø–æ—á–∫—É, —á—Ç–æ–±—ã –Ω–µ —É—Å—É–≥—É–±–ª—è—Ç—å
              }
            }
          }
        }
       
       function loadData() {
          try {
            moodData   = getJson('moodData', {}) || {};
            dailyMoods = getJson('dailyMoods', {}) || {};
            dailyScores = getJson('dailyScores', {}) || {};
            dailyTotals = getJson('dailyTotals', {}) || {};

            if (!dailyTotals || typeof dailyTotals !== 'object') {
              dailyTotals = {};
            }

            const clampTotal = (value) => Math.max(DAILY_MIN, Math.min(DAILY_MAX, value));
            const ensureScore = (entry) => {
              if (typeof entry?.score === 'number') return entry.score;
              switch (entry?.mood) {
                case 'happy': return 3;
                case 'pleased': return 2;
                case 'neutral': return 0;
                case 'sad': return -2;
                case 'sorrow': return -3;
                default: return 0;
              }
            };

            Object.keys(moodData || {}).forEach((key) => {
              const entries = Array.isArray(moodData[key]) ? moodData[key] : [];
              if (!entries.length) return;

              const computedSum = entries.reduce((sum, entry) => sum + ensureScore(entry), 0);
              if (typeof dailyTotals[key] !== 'number') {
                dailyTotals[key] = clampTotal(computedSum);
              } else {
                dailyTotals[key] = clampTotal(dailyTotals[key]);
              }

              dailyScores[key] = entries.length ? computedSum / entries.length : 0;
            });
          }
          catch (e) {
            console.log('Error loading data:', e);
            moodData = {};
            dailyMoods = {};
            dailyTotals = {};
          }
        }

        function saveData() {
            try {
                localStorage.setItem('moodData', JSON.stringify(moodData));
                localStorage.setItem('dailyMoods', JSON.stringify(dailyMoods));
                localStorage.setItem('dailyScores', JSON.stringify(dailyScores));
                localStorage.setItem('dailyTotals', JSON.stringify(dailyTotals));
            } catch (e) {
                console.log('Error saving data:', e);
            }
        }

        function getDateKey(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // AI analysis functions
        function getSadStreak(daysWindow = 10) {
            const today = new Date();
            let streak = 0;
            for (let i = 0; i < daysWindow; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const key = getDateKey(d);
                const mood = dailyMoods[key];
                if (mood === 'sad' || mood === 'sorrow') streak++;
                else break;
            }
            return streak;
        }
        
        function getMoodSummary(days = 14) {
            const today = new Date();
            const counts = { good: 0, neutral: 0, sad: 0 };
            let total = 0;
            
            for (let i = 0; i < days; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const key = getDateKey(d);
                const mood = dailyMoods[key];
                if (mood) {
                    counts[mood]++;
                    total++;
                }
            }
            return { daysConsidered: days, counts, total };
        }

        const SAD_STREAK_THRESHOLD = 3;
        const PROACTIVE_COOLDOWN_DAYS = 3;
        
        function maybeProactiveChat() {
            try {
                const streak = getSadStreak(10);
                const lastAt = localStorage.getItem('aiLastProactiveAt');
                const todayKey = getDateKey(new Date());
        
                if (streak >= SAD_STREAK_THRESHOLD) {
                    if (lastAt) {
                        const last = new Date(lastAt);
                        const diffDays = Math.floor((Date.now() - last.getTime()) / (1000 * 3600 * 24));
                        if (diffDays < PROACTIVE_COOLDOWN_DAYS) return;
                    }
                    localStorage.setItem('aiLastProactiveAt', todayKey);
                    
                    // Switch to chat page and add proactive message
                    switchPage('chat');
                    setTimeout(() => {
                        const intro = `–Ø –∑–∞–º–µ—Ç–∏–ª, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ ${streak} ${streak === 1 ? '–¥–µ–Ω—å' : '–¥–Ω—è'} –≤–∞–º –≥—Ä—É—Å—Ç–Ω–æ. –•–æ—Ç–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏–ª–∏ –ø–∞—Ä—É –ø—Ä–æ—Å—Ç—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫?`;
                        addMessage('ai', intro);
                    }, 500);
                }
            } catch (e) {
                console.log('Error in proactive chat:', e);
            }
        }
       
        // Calendar functions
       function navigateMonth(direction) {
            selectedDate.setMonth(selectedDate.getMonth() + direction);
            updateCalendar();
        }

        function bucketVarForTotal(total) {
          if (total >= 50) return '--bucket-pos50';
          if (total >= 40) return '--bucket-pos40';
          if (total >= 30) return '--bucket-pos30';
          if (total >= 20) return '--bucket-pos20';
          if (total >= 10) return '--bucket-pos10';
          if (total >= 1)  return '--bucket-zero';
          if (total === 0) return '--bucket-zero';
          if (total <= -50) return '--bucket-neg50';
          if (total <= -40) return '--bucket-neg40';
          if (total <= -30) return '--bucket-neg30';
          if (total <= -20) return '--bucket-neg20';
          if (total <= -10) return '--bucket-neg10';
          return '--bucket-zero';
        }

        function updateCalendar() {
          document.getElementById('monthTitle').textContent =
            `${monthNames[selectedDate.getMonth()]} ${selectedDate.getFullYear()}`;
        
          const year = selectedDate.getFullYear();
          const month = selectedDate.getMonth();
          const firstDay = new Date(year, month, 1);
          const startDate = new Date(firstDay);
          startDate.setDate(startDate.getDate() - firstDay.getDay());
        
          const calendarDays = document.getElementById('calendarDays');
          calendarDays.innerHTML = '';
        
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const todayKey = getDateKey(today);
        
          for (let week = 0; week < 6; week++) {
            const weekDiv = document.createElement('div');
            weekDiv.className = 'week';
        
            for (let day = 0; day < 7; day++) {
              const current = new Date(startDate);
              current.setDate(startDate.getDate() + (week * 7 + day));
              const dateKey = getDateKey(current);
              const isCurrentMonth = current.getMonth() === month;
              const isToday = dateKey === todayKey;
        
              const dayDiv = document.createElement('div');
              dayDiv.className = 'day';
              if (!isCurrentMonth) dayDiv.classList.add('other-month');
              if (isToday) dayDiv.classList.add('today');
        
              // –∑–∞–¥–∞—ë–º —Ñ–æ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ä–µ–¥–Ω–µ–≥–æ –±–∞–ª–ª–∞
              // –∑–∞–¥–∞—ë–º —Ñ–æ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–π —Å—É–º–º—ã
              const total = dailyTotals[dateKey];

              if (typeof total === 'number') {
                dayDiv.classList.add('has-mood');

                const varName = bucketVarForTotal(total);
                const bg = `var(${varName})`;

                dayDiv.style.backgroundColor = bg;
                dayDiv.style.backgroundImage = 'none';

                // –Ω–µ –∑–∞–¥–∞—ë–º –∏–Ω–ª–∞–π–Ω–æ–≤—ã–π —Ü–≤–µ—Ç ‚Äî –¥–∞—ë–º —Ç–µ–º–µ —Ä—É–ª–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞—Å—Ç–æ–º
                dayDiv.style.removeProperty('color');

                dayDiv.style.boxShadow =
                  'inset 0 1px 0 rgba(255,255,255,0.05), 0 0 0 1px rgba(0,0,0,0.40)';
                dayDiv.style.borderColor = 'transparent';
              } else if (isToday) {
                const bg = 'var(--bucket-zero)';
                dayDiv.style.backgroundColor = bg;
                dayDiv.style.backgroundImage = 'none';
                // –Ω–µ –∑–∞–¥–∞—ë–º –∏–Ω–ª–∞–π–Ω–æ–≤—ã–π —Ü–≤–µ—Ç ‚Äî –¥–∞—ë–º —Ç–µ–º–µ —Ä—É–ª–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞—Å—Ç–æ–º
                dayDiv.style.removeProperty('color');
                dayDiv.style.boxShadow =
                  'inset 0 1px 0 rgba(255,255,255,0.05), 0 0 0 1px rgba(0,0,0,0.40)';
              }

              dayDiv.textContent = current.getDate();
              weekDiv.appendChild(dayDiv);
            }
            calendarDays.appendChild(weekDiv);
          }

          renderTodayScore();
        }

        function renderTodayScore() {
          const el = document.getElementById('todayScoreBadge');
          if (!el) return;

          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const key = getDateKey(today);
          const total = dailyTotals?.[key] ?? 0;

          const varName = bucketVarForTotal(total);
          el.style.setProperty('--today-color', `var(${varName})`);

          const sign = total > 0 ? '+' : '';
          el.textContent = `–°–µ–≥–æ–¥–Ω—è: ${sign}${total} / 50`;
          el.classList.remove('hidden');
        }

        function pingTodayBadge() {
          const el = document.getElementById('todayScoreBadge');
          if (!el) return;
          el.animate([
            { transform: 'scale(1)' },
            { transform: 'scale(1.06)' },
            { transform: 'scale(1)' }
          ], { duration: 220, easing: 'ease-out' });
        }

        function showInfo(text) {
          alert(text);
        }

        function updateSliderGlow() {
          const el = document.getElementById('moodSlider');
          if (!el) return;
          const val = parseInt(el.value, 10) || 0;      // -5..+5
          const ratio = Math.min(Math.abs(val) / 5, 1); // 0..1
          const sizePx = 3 + Math.round(7 * ratio);     // 3..10

          // —Ç–µ–ø–µ—Ä—å: —Å–ª–µ–≤–∞ (val < 0) ‚Äî –°–ò–ù–ò–ô, —Å–ø—Ä–∞–≤–∞ (val > 0) ‚Äî –ó–ï–õ–Å–ù–´–ô
          let color = 'rgba(0,0,0,0)';
          if (val < 0) color = getComputedStyle(document.documentElement).getPropertyValue('--thumb-neg').trim() || 'rgba(29,78,216,.45)';
          if (val > 0) color = getComputedStyle(document.documentElement).getPropertyValue('--thumb-pos').trim() || 'rgba(22,163,74,.45)';

          el.style.setProperty('--thumb-glow', color);
          el.style.setProperty('--glow-size', sizePx + 'px');
        }

        function pingSliderThumbOnce() {
          const slider = document.getElementById('moodSlider');
          if (!slider) return;

          slider.animate([
            { transform: 'scale(1)' },
            { transform: 'scale(1.05)' },
            { transform: 'scale(1)' }
          ], { duration: 180, easing: 'ease-out' });
        }

        // –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ —Å–ª–∞–π–¥–µ—Ä–æ–º
        function openMoodSlider() {
          const slider = document.getElementById('moodSlider');
          if (slider) {
            slider.value = 0;
            slider.removeEventListener('input', updateSliderGlow);
            slider.addEventListener('input', updateSliderGlow);
            updateSliderGlow();
          }
          document.getElementById('moodSliderPopup').classList.remove('hidden');
          document.body.classList.add('modal-open');
        }

        // –∑–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ —Å–ª–∞–π–¥–µ—Ä–æ–º
        function closeMoodSlider() {
          document.getElementById('moodSliderPopup').classList.add('hidden');
          document.body.classList.remove('modal-open');
        }

        // —Å—á–∏—Ç–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ —Å–ª–∞–π–¥–µ—Ä–∞ –∏ –∑–∞–ø–∏—Å–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
        function confirmMoodScore() {
          const slider = document.getElementById('moodSlider');
          const raw = slider ? parseInt(slider.value, 10) : 0;
          const delta = raw;               // –ü–õ–Æ–° —Å–ø—Ä–∞–≤–∞, –ú–ò–ù–£–° —Å–ª–µ–≤–∞
          recordScore(delta);
          pingSliderThumbOnce && pingSliderThumbOnce();
          closeMoodSlider();
        }
        
        /**
         * –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–ø–∏—Å—å —Å–æ score, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –∑–∞ –¥–µ–Ω—å,
         */
       function recordScore(delta) {
          const now = new Date();
          const dateKey = getDateKey(now);
          const hour = now.getHours();
          const minute = now.getMinutes();
          const timestamp = now.getTime();

          const mood = delta >= 4 ? 'happy'
                     : delta >= 2 ? 'pleased'
                     : delta <= -4 ? 'sorrow'
                     : delta <= -2 ? 'sad'
                     : 'neutral';
          if (!moodData[dateKey]) moodData[dateKey] = [];
          moodData[dateKey].push({ hour, minute, mood, score: delta, timestamp });

          const current = typeof dailyTotals[dateKey] === 'number' ? dailyTotals[dateKey] : 0;
          const next = current + delta;

          if (next > DAILY_MAX) {
            showInfo('–ú–∞–∫—Å–∏–º—É–º –∑–∞ –¥–µ–Ω—å: +50. –ë–æ–ª—å—à–µ –æ—á–∫–æ–≤ –Ω–µ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è.');
            dailyTotals[dateKey] = DAILY_MAX;
          } else if (next < DAILY_MIN) {
            showInfo('–ú–∏–Ω–∏–º—É–º –∑–∞ –¥–µ–Ω—å: ‚àí50. –ú–µ–Ω—å—à–µ –æ—á–∫–æ–≤ –Ω–µ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è.');
            dailyTotals[dateKey] = DAILY_MIN;
          } else {
            dailyTotals[dateKey] = next;
          }

          dailyMoods[dateKey] =
              dailyTotals[dateKey] >= 10 ? 'happy' :
              dailyTotals[dateKey] >= 1  ? 'pleased' :
              dailyTotals[dateKey] <= -10 ? 'sorrow' :
              dailyTotals[dateKey] <= -1 ? 'sad' :
              'neutral';

          const entries = moodData[dateKey] || [];
          const totalForAverage = entries.reduce((sum, entry) => {
            if (typeof entry.score === 'number') return sum + entry.score;
            return sum;
          }, 0);
          dailyScores[dateKey] = entries.length ? totalForAverage / entries.length : 0;

          saveData();
          updateCalendar();
          renderTodayScore();
          pingTodayBadge();
          maybeProactiveChat();
        }
        


        // Add event listener for notifications button
        document.getElementById('enableNotifications').addEventListener('click', requestNotificationPermission);
    </script>
    <!-- Load core module which defines the global App object with store, bus and navigation helpers -->
    <script src="./app-core.js"></script>
</body>
</html>





















