<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="app-version" content="dev ‚Ä¢ 2025-10-07 15:21:38">
    <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è</title>
    
    
    <meta name="theme-color" content="#4F46E5">
    <meta name="description" content="–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å–≤–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è">
    
    
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi0JrQsNC70LXQvdC00LDRgNGMINCd0LDRgdGC0YDQvtC10L3QuNGPIiwic2hvcnRfbmFtZSI6ItCa0LDQu9C10L3QtNCw0YDRjCIsImRlc2NyaXB0aW9uIjoi0J7RgtGB0LvQtdC20LjQstCw0LnRgtC1INGB0LLQvtC1INC90LDRgdGC0YDQvtC10L3QuNC1INC60LDQttC00YvQuSDQtNC10L3RjCIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjNEY0NkU1IiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0Nzdmcgdmlld0JveD0nMCAwIDEwMCAxMDAnIGZpbGw9JyUyMzRGNDZFNScgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyUzRSUzQ3JlY3Qgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIHJ4PScxMCcvJTNFJTNDdGV4dCB4PSc1MCcgeT0nNTAnIGZvbnQtc2l6ZT0nNDAnIGZpbGw9J3doaXRlJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBkeT0nLjNlbSclM0Xwn5OBJTNFL3RleHQlM0UlM0Mvc3ZnJTNFIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    
    
    <link rel="stylesheet" href="styles/tokens.css?v=2025-10-17a">
    <link rel="stylesheet" href="styles/components.css?v=2025-10-17a">
    
    
</head>
<body data-theme="light">
  <main class="app-core" id="appRoot">
    <div class="pwa-hint hidden install-prompt" id="installPrompt" style="padding:12px 16px; max-width:420px; margin:0 auto;">
      <div style="font-size:14px; font-weight:600; display:flex; align-items:center; gap:6px;">
        <span>üì± –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω!</span>
      </div>
      <div style="font-size:12px; line-height:1.4; margin-top:4px;">
        –ù–∞–∂–º–∏—Ç–µ –º–µ–Ω—é –±—Ä–∞—É–∑–µ—Ä–∞ ‚Üí "–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω"
      </div>
      <div style="margin-top:8px; display:flex; align-items:center; gap:8px;">
        <button id="enableNotifications"
                style="font-size:12px; line-height:1.2; padding:4px 8px; border:1px solid #888; border-radius:4px; background:#fff; cursor:pointer;">
          üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        </button>
      </div>
    </div>

  <header class="app-header">
      <div class="pillbar">
        <div class="header-left">
          <div class="badge-today" id="todayScoreBadge" aria-live="polite">
            –°–µ–≥–æ–¥–Ω—è: <span id="todayScoreValue">0</span> / <span id="todayScoreLimit">50</span>
          </div>
        </div>
        <div class="header-right">
          <button class="theme-toggle theme-toggle__knob" id="themeToggle" type="button" aria-pressed="false" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
            <span class="theme-toggle__icon theme-toggle__icon--moon" aria-hidden="true">üåô</span>
            <span class="theme-toggle__label">–¢–µ–º–∞</span>
            <span class="theme-toggle__icon theme-toggle__icon--sun" aria-hidden="true">‚òÄÔ∏è</span>
          </button>
        </div>
      </div>
    </header>

    <section class="calendar-page" id="calendarPage">
      <section class="month-nav calendar-head">
        <button class="btn--icon nav-btn" id="prevMonthBtn" type="button" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü">‚Üê</button>
        <div class="month-nav__title-group">
          <div class="month-title" id="monthTitle"></div>
        </div>
        <button class="btn--icon nav-btn" id="nextMonthBtn" type="button" aria-label="–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü">‚Üí</button>
      </section>

      <section class="calendar">
        <div class="weekdays calendar-weekdays" id="weekdaysRow">
          <div class="weekday">–í—Å</div>
          <div class="weekday">–ü–Ω</div>
          <div class="weekday">–í—Ç</div>
          <div class="weekday">–°—Ä</div>
          <div class="weekday">–ß—Ç</div>
          <div class="weekday">–ü—Ç</div>
          <div class="weekday">–°–±</div>
        </div>
        <div class="month-grid calendar-grid" id="daysGrid"></div>
      </section>

      <section class="calendar-cta cta-wrap">
        <button id="openMoodModalBtn" type="button" class="btn btn--primary btn--xl" data-open-modal="#mood-modal">
          –ó–∞–ø–∏—Å–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
        </button>
        <button id="openStatsModalBtn" type="button" class="btn btn--primary btn--xl" data-open-modal="#stats-modal">
          <span style="display:flex;align-items:center;gap:6px;">
            <span style="font-size:16px;">üìä</span>
            <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
          </span>
        </button>
      </section>
    </section>

    <section class="chat-page" id="chatPage">
      <div class="chat-header">
        <h2>–ò–ò –ß–∞—Ç</h2>
        <p>–°–ø—Ä–æ—Å–∏—Ç–µ —Å–æ–≤–µ—Ç –∏–ª–∏ –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å, –∫–∞–∫ –≤—ã —Å–µ–π—á–∞—Å.</p>
      </div>

      <div id="chatMessages" class="chat-messages"></div>

      <div class="chat-input-container">
        <textarea id="chatInput" class="chat-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
        <button id="sendButton" class="send-button" onclick="sendMessage()" disabled>‚û§</button>
      </div>
      <div class="chat-disclaimer">–≠—Ç–æ –Ω–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –ø–æ–º–æ—â—å. –ü—Ä–∏ —Ä–∏—Å–∫–∞—Ö ‚Äî –∑–≤–æ–Ω–∏—Ç–µ –≤ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–ª—É–∂–±—ã.</div>
    </section>

    <section class="help-page" id="helpPage" style="display:none;">
      <div class="chat-header">
        <h2>–ü–æ–º–æ—â—å</h2>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:</p>
      </div>

      <div class="section-grid">
        <button class="card section-card" onclick="switchPage('therapy')">
          <div class="section-emoji">üßò‚Äç‚ôÄÔ∏è</div>
          <div class="section-title">–¢–µ—Ä–∞–ø–∏—è</div>
          <div class="section-sub">–î—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ –∏ —É—Å–ø–æ–∫–∞–∏–≤–∞—é—â–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏</div>
        </button>

        <button class="card section-card" onclick="switchPage('tests')">
          <div class="section-emoji">üß©</div>
          <div class="section-title">–¢–µ—Å—Ç—ã</div>
          <div class="section-sub">–û—Ü–µ–Ω–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è, –≤—ã–≥–æ—Ä–∞–Ω–∏—è, –ª–∏—á–Ω–æ—Å—Ç–∏</div>
        </button>
      </div>
    </section>

    <section class="therapy-page" id="therapyPage" style="display:none;">
      <div class="chat-header">
        <h2>–¢–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏</h2>
        <p>–ü—Ä–æ—Å—Ç—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å</p>
      </div>

      <div class="content-list">
        <div class="card">
          <h3 style="margin-bottom:8px;">–î—ã—Ö–∞–Ω–∏–µ 4‚Äì7‚Äì8</h3>
          <p>–í–¥–æ—Ö 4 —Å–µ–∫ ‚Üí –∑–∞–¥–µ—Ä–∂–∫–∞ 7 —Å–µ–∫ ‚Üí –≤—ã–¥–æ—Ö 8 —Å–µ–∫. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å 4‚Äì6 –∫—Ä—É–≥–æ–≤.</p>
          <button class="btn btn--primary" onclick="PracticeEngine.openById('478')">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
        </div>

        <div class="card">
          <h3 style="margin-bottom:8px;">–ó–∞–∑–µ–º–ª–µ–Ω–∏–µ 5-4-3-2-1</h3>
          <p>–ù–∞–∑–æ–≤–∏—Ç–µ: 5 —á—Ç–æ –≤–∏–¥–∏—Ç–µ, 4 —á—Ç–æ –æ—â—É—â–∞–µ—Ç–µ, 3 –∑–≤—É–∫–∞, 2 –∑–∞–ø–∞—Ö–∞, 1 –≤–∫—É—Å.</p>
          <button class="btn btn--primary" onclick="PracticeEngine.openById('54321')">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
        </div>
      </div>
    </section>

    <section class="tests-page" id="testsPage" style="display:none;">
      <div class="chat-header">
        <h2>–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã</h2>
        <p>–ë—ã—Å—Ç—Ä—ã–µ —Å–∫—Ä–∏–Ω–∏–Ω–≥–∏ –∏ –æ–ø—Ä–æ—Å–Ω–∏–∫–∏</p>
      </div>

      <div class="content-list">
        <div class="card">
          <h3 style="margin-bottom:8px;">PHQ-2 (—Å–∫—Ä–∏–Ω–∏–Ω–≥ –¥–µ–ø—Ä–µ—Å—Å–∏–∏)</h3>
          <p>2 –≤–æ–ø—Ä–æ—Å–∞, ~30 —Å–µ–∫—É–Ω–¥. –ù–µ –∑–∞–º–µ–Ω—è–µ—Ç –¥–∏–∞–≥–Ω–æ–∑.</p>
          <button class="btn btn--primary" style="margin-top:12px;" onclick="openTest('phq2')">–ü—Ä–æ–π—Ç–∏</button>
        </div>

        <div class="card">
          <h3 style="margin-bottom:8px;">GAD-2 (—Å–∫—Ä–∏–Ω–∏–Ω–≥ —Ç—Ä–µ–≤–æ–≥–∏)</h3>
          <p>2 –≤–æ–ø—Ä–æ—Å–∞, ~30 —Å–µ–∫—É–Ω–¥. –ù–µ –∑–∞–º–µ–Ω—è–µ—Ç –¥–∏–∞–≥–Ω–æ–∑.</p>
          <button class="btn btn--primary" style="margin-top:12px;" onclick="openTest('gad2')">–ü—Ä–æ–π—Ç–∏</button>
        </div>
      </div>
    </section>

    <nav class="bottom-nav">
      <button class="nav-item active" id="navCalendarBtn" type="button" onclick="switchPage('calendar')">
        <div class="nav-icon">üìÖ</div>
        <div class="nav-label">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
      </button>

      <button class="nav-item" id="navChatBtn" type="button" onclick="switchPage('chat')">
        <div class="nav-icon">ü§ñ</div>
        <div class="nav-label">–ò–ò –ß–∞—Ç</div>
      </button>

      <button class="nav-item" id="navHelpBtn" type="button" onclick="switchPage('help')">
        <div class="nav-icon">üÜò</div>
        <div class="nav-label">–ü–æ–º–æ—â—å</div>
      </button>
    </nav>

    <section class="modal modal--md" id="therapy-modal" hidden aria-hidden="true">
    <div class="modal__backdrop" data-close-modal></div>

    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="therapyTitle">
      <header class="modal__header">
        <h3 id="therapyTitle" class="modal__title">–¢–µ—Ä–∞–ø–∏—è</h3>
      </header>

      <div class="modal__body">
        <div class="modal__content">
          <p id="therapySubtitle" class="modal__subtitle">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏</p>

          <div class="thermo">
            <div class="ring" id="thermoRing">
              <div class="ring-inner">
                <div id="thermoPhase" class="phase">–ì–æ—Ç–æ–≤—ã?</div>
                <div id="thermoTime" class="time">00</div>
              </div>
            </div>
          </div>

          <div id="therapyHint" class="therapy-hint"></div>

          <div class="therapy-actions">
            <button class="btn btn--primary" id="therapyStartBtn">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
            <button class="btn" id="therapyStopBtn">‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
          </div>
        </div>
      </div>

      <footer class="modal__footer modal-actions">
        <button type="button" class="btn btn-primary" data-close-modal>–ó–∞–∫—Ä—ã—Ç—å</button>
      </footer>
    </div>
  </section>

  <section class="modal modal--md" id="test-modal" hidden aria-hidden="true">
    <div class="modal__backdrop" data-close-modal></div>

    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="testTitle">
      <header class="modal__header">
        <h3 id="testTitle" class="modal__title">–¢–µ—Å—Ç</h3>
      </header>

      <div class="modal__body">
        <div class="modal__content">
          <p id="testDesc" class="modal__subtitle">–ö–æ—Ä–æ—Ç–∫–∏–π —Å–∫—Ä–∏–Ω–∏–Ω–≥</p>

          <div id="testFormHost" class="test-form-host"></div>

          <div class="therapy-actions" style="margin-top:4px;">
            <button class="btn btn--primary" id="testSubmitBtn">–ì–æ—Ç–æ–≤–æ</button>
            <button class="btn" id="testCancelBtn">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
      </div>

      <footer class="modal__footer modal-actions">
        <button type="button" class="btn btn-primary" data-close-modal>–ó–∞–∫—Ä—ã—Ç—å</button>
      </footer>
    </div>
  </section>

  <section class="modal modal--sm" id="mood-modal" hidden aria-hidden="true">
    <div class="modal__backdrop" data-close-modal></div>

    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="mood-modal-title">
      <header class="modal__header">
        <h3 id="mood-modal-title" class="modal__title">–ö–∞–∫ –≤—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—Ç–µ?</h3>
      </header>

      <div class="modal__body">
        <div class="modal__content">
          <div class="mood-range-row">
            <span class="mood-emoji" aria-hidden="true" title="–ü–ª–æ—Ö–æ">üò¢</span>

            <input
              id="moodSlider"
              type="range"
              min="-5" max="5" step="1" value="0"
              class="mood-range"
              aria-label="–ü–æ–ª–∑—É–Ω–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –æ—Ç ‚àí5 –¥–æ +5">

            <span class="mood-emoji" aria-hidden="true" title="–•–æ—Ä–æ—à–æ">üòÑ</span>
          </div>

          <div class="mood-actions">
            <button class="btn btn--primary" onclick="confirmMoodScore()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
          </div>
        </div>
      </div>

      <footer class="modal__footer modal-actions">
        <button type="button" class="btn btn-primary" data-close-modal>–ó–∞–∫—Ä—ã—Ç—å</button>
      </footer>
    </div>
  </section>

  <section class="modal modal--md" id="stats-modal" hidden aria-hidden="true">
    <div class="modal__backdrop" data-close-modal></div>

    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="stats-title">
      <header class="modal__header">
        <h3 id="stats-title" class="modal__title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
      </header>

      <div class="modal__body">
        <div class="modal__content">
          <section class="card" id="today-hourly">
            <div class="card-title">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è –ø–æ —á–∞—Å–∞–º</div>
            <div class="chart-wrap">
              <canvas id="hourly-chart" height="200"></canvas>
            </div>

            <div class="aggregates">
              <div class="agg"><div class="label">–°—Ä–µ–¥–Ω–µ–µ –∑–∞ –¥–µ–Ω—å</div><div class="value" id="agg-avg">0.0</div></div>
              <div class="agg"><div class="label">–°—É–º–º–∞ –∑–∞ –¥–µ–Ω—å</div><div class="value" id="agg-sum">0</div></div>
              <div class="agg"><div class="label">–ü–∏–∫–æ–≤—ã–π —á–∞—Å</div><div class="value" id="agg-peak">‚Äî</div></div>
            </div>

            <p class="hint">–ù–∞–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –∫–æ—Å–Ω–∏—Ç–µ—Å—å —Å—Ç–æ–ª–±–∏–∫–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏</p>
          </section>

          <hr class="section-divider" />

          <div id="overall-range-tabs" class="range-tabs segmented" role="tablist" aria-label="–î–∏–∞–ø–∞–∑–æ–Ω –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏">
            <button type="button" class="tab seg active" data-range="3d" role="tab" aria-selected="true">3 –¥–Ω—è</button>
            <button type="button" class="tab seg" data-range="7d" role="tab" aria-selected="false">–ù–µ–¥–µ–ª—è</button>
            <button type="button" class="tab seg" data-range="1m" role="tab" aria-selected="false">–ú–µ—Å—è—Ü</button>
            <button type="button" class="tab seg" data-range="all" role="tab" aria-selected="false">–í—Å–µ –≤—Ä–µ–º—è</button>
          </div>

          <section class="card" id="overall-stats">
            <div class="card-title">
              –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (<span id="overall-range-label">3 –¥–Ω—è</span>)
            </div>
            <div id="overall-stats-body"></div>
          </section>
        </div>
      </div>

      <footer class="modal__footer modal-actions">
        <button type="button" class="btn btn-primary" data-close-modal>–ó–∞–∫—Ä—ã—Ç—å</button>
      </footer>
    </div>
  </section>

  </main>

<script>
(function setAppContentWidth(){
  const root = document.documentElement;
  const el = () => document.querySelector('.app-core') || document.body;

  function apply(){
    const w = Math.round(el().getBoundingClientRect().width || 520);
    root.style.setProperty('--app-content-w', w + 'px');
  }
  apply();
  window.addEventListener('resize', apply);
  window.visualViewport?.addEventListener('resize', apply);
})();
    </script>


       <script>
           
    window.PRACTICES = [
      {
        id: "478",
        title: "–î—ã—Ö–∞–Ω–∏–µ 4‚Äì7‚Äì8",
        subtitle: "–í–¥–æ—Ö 4 —Å–µ–∫ ‚Üí –∑–∞–¥–µ—Ä–∂–∫–∞ 7 ‚Üí –≤—ã–¥–æ—Ö 8. –ü–æ–≤—Ç–æ—Ä–∏–º 4 –∫—Ä—É–≥–∞.",
        type: "timer",
        cycles: 4,
        phases: [
          { name: "–í–¥–æ—Ö",     seconds: 4, hint: "–ú–µ–¥–ª–µ–Ω–Ω—ã–π –≤–¥–æ—Ö –Ω–æ—Å–æ–º" },
          { name: "–ó–∞–¥–µ—Ä–∂–∫–∞", seconds: 7, hint: "–ù–µ –¥—ã—à–∏–º, —Å–ø–æ–∫–æ–π–Ω–æ"   },
          { name: "–í—ã–¥–æ—Ö",    seconds: 8, hint: "–î–ª–∏–Ω–Ω—ã–π –≤—ã–¥–æ—Ö —Ä—Ç–æ–º"   }
        ]
      },
      {
        id: "54321",
        title: "–ó–∞–∑–µ–º–ª–µ–Ω–∏–µ 5-4-3-2-1",
        subtitle: "–ù–∞–∑–æ–≤–∏—Ç–µ: 5 –≤–∏–∂—É, 4 –æ—â—É—â–∞—é, 3 —Å–ª—ã—à—É, 2 –∑–∞–ø–∞—Ö–∞, 1 –≤–∫—É—Å.",
        type: "steps",
        steps: [
          "–ù–∞–∑–æ–≤–∏—Ç–µ 5 –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –≤–∏–¥–∏—Ç–µ.",
          "–ù–∞–∑–æ–≤–∏—Ç–µ 4 –≤–µ—â–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ—â—É—â–∞–µ—Ç–µ —Ç–µ–ª–æ–º.",
          "–ù–∞–∑–æ–≤–∏—Ç–µ 3 –∑–≤—É–∫–∞, –∫–æ—Ç–æ—Ä—ã–µ —Å–ª—ã—à–∏—Ç–µ.",
          "–ù–∞–∑–æ–≤–∏—Ç–µ 2 –∑–∞–ø–∞—Ö–∞.",
          "–ù–∞–∑–æ–≤–∏—Ç–µ 1 –≤–∫—É—Å (–∏–ª–∏ —Å–¥–µ–ª–∞–π—Ç–µ –≥–ª–æ—Ç–æ–∫ –≤–æ–¥—ã)."
        ]
      }
    ];
    </script>

        <script>
    (function () {
      // –ü—É–±–ª–∏—á–Ω–æ–µ API
      window.PracticeEngine = {
        openById(id) {
          const cfg = (window.PRACTICES || []).find(p => p.id === id);
          if (!cfg) return console.warn("[practice] not found", id);
          openTherapyModal(cfg);
        }
      };
    
      let timer = null;
      let state = null;
    
      function openTherapyModal(cfg) {
        state = {
          cfg,
          running: false,
          paused: false,   // ‚Üê —Ñ–ª–∞–≥ –ø–∞—É–∑—ã
          cycle: 0,
          phaseIndex: 0,   // ‚Üê –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–π —Ñ–∞–∑—ã (–≤–¥–æ—Ö/–∑–∞–¥–µ—Ä–∂–∫–∞/–≤—ã–¥–æ—Ö)
          left: 0,         // ‚Üê –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Å–µ–∫—É–Ω–¥—ã –≤ —Ñ–∞–∑–µ
          step: 0
        };
    
        // –ó–∞–≥–æ–ª–æ–≤–∫–∏
        setText('therapyTitle', cfg.title);
        setText('therapySubtitle', cfg.subtitle);
    
        // –í–∏–¥–∏–º–æ—Å—Ç—å —Ç–∞–π–º–µ—Ä–∞: —Ç–æ–ª—å–∫–æ –¥–ª—è type: "timer"
        setTimeVisible(cfg.type === "timer");
        setTime("");               // –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        setPhase("–ì–æ—Ç–æ–≤—ã?");
        setHint("");
        setRing(0);
    
        // –ö–Ω–æ–ø–∫–∏
        byId('therapyStartBtn').onclick = start;
        byId('therapyStopBtn').onclick  = stop;
        byId('therapyStartBtn').textContent = "–ó–∞–ø—É—Å—Ç–∏—Ç—å";

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É
        const modal = byId('therapy-modal');
        if (modal && typeof window.openModal === 'function') {
          window.openModal(modal);
        }
      }
    
    function start() {
      // –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º state, —Ç–æ–ª—å–∫–æ —Å–Ω–∏–º–∞–µ–º –ø–∞—É–∑—É
      state.running = true;
      state.paused  = false;
    
      const { cfg } = state;
    
      if (cfg.type === "timer") {
        setTimeVisible(true);
        // –µ—Å–ª–∏ –µ—Å—Ç—å, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å —Ç–µ–∫—É—â–µ–π —Ñ–∞–∑—ã –∏ –æ—Å—Ç–∞—Ç–∫–∞
        if (state.left > 0) {
          continueTimerPhase();
        } else {
          // –∑–∞–ø—É—Å–∫ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞
          state.cycle = 0;
          state.phaseIndex = 0;
          runTimerCycle();
        }
      } 
          else if (cfg.type === "steps") {
            setTimeVisible(false);
            // –µ—Å–ª–∏ —É–∂–µ –±—ã–ª–∏ –Ω–∞ —à–∞–≥–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∏–º –µ–≥–æ
            showStep();
      }
    }

        function stop() {
      if (timer) { clearInterval(timer); timer = null; }
      if (!state) return;
    
      state.running = false;
      state.paused  = true;
    
      setPhase("–ü–∞—É–∑–∞");
      setHint("");
      // –∫–æ–ª—å—Ü–æ/–≤—Ä–µ–º—è –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å ‚Äî –≤–∏–¥–Ω–æ, –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å
    
      const startBtn = byId('therapyStartBtn');
    
      if (state.cfg.type === "steps") {
        setTimeVisible(false);
        startBtn.textContent = "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å";
        startBtn.onclick = () => { state.running = true; state.paused = false; showStep(); };
      } else {
        // timer
        setTimeVisible(true);
        startBtn.textContent = "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å";
        startBtn.onclick = start; // –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç —Å —Ç–µ–∫—É—â–∏—Ö phaseIndex/left
      }
    }

      // ===== timer-–ø—Ä–∞–∫—Ç–∏–∫–∏ (—Ñ–∞–∑—ã √ó —Ü–∏–∫–ª—ã)
    // –ó–ê–ú–ï–ù–ê runTimerCycle —Ü–µ–ª–∏–∫–æ–º
    function runTimerCycle() {
      const { cfg } = state;
      if (!state.running) return;
    
      // –∑–∞–∫–æ–Ω—á–∏–ª–∏ –≤—Å–µ —Ü–∏–∫–ª—ã
      if (state.cycle >= (cfg.cycles || 1)) {
        setPhase("–ì–æ—Ç–æ–≤–æ!");
        setTime("");
        setHint("–û—Ç–ª–∏—á–Ω–æ ‚ú®");
        setRing(360);
        return;
      }
    
      // –µ—Å–ª–∏ —Ñ–∞–∑—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å ‚Äî —Å–ª–µ–¥—É—é—â–∏–π —Ü–∏–∫–ª
      if (state.phaseIndex >= cfg.phases.length) {
        state.cycle++;
        state.phaseIndex = 0;
      }
    
      continueTimerPhase(); // –ø–µ—Ä–µ–π—Ç–∏/–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ñ–∞–∑—É
    }
    
    // –ù–û–í–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è ‚Äî –≤—Å—Ç–∞–≤—å —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ runTimerCycle
    function continueTimerPhase() {
      const { cfg } = state;
      if (!state.running) return;
    
      const phase = cfg.phases[state.phaseIndex];
      if (!phase) { runTimerCycle(); return; }
    
      // –µ—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –≤–ø–µ—Ä–≤—ã–µ/–ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ ‚Äî –∑–∞–ø–æ–ª–Ω—è–µ–º left
      if (!state.left || state.left <= 0) {
        state.left = phase.seconds;
      }
    
      setPhase(`${phase.name} (—Ü–∏–∫–ª ${state.cycle + 1}/${cfg.cycles || 1})`);
      setHint(phase.hint || "");
      setRing(360 * (1 - state.left / phase.seconds));
      setTime(state.left);
    
      if (timer) clearInterval(timer);
      timer = setInterval(() => {
        if (!state.running) { clearInterval(timer); timer = null; return; }
    
        state.left--;
        setTime(Math.max(state.left, 0));
    
        const done = (phase.seconds - state.left) / phase.seconds;
        setRing(Math.min(360 * done, 360));
    
        if (state.left <= 0) {
          clearInterval(timer); timer = null;
          setRing(360);
          // –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π —Ñ–∞–∑–µ
          state.phaseIndex++;
          state.left = 0;
          setTimeout(runTimerCycle, 180);
        }
      }, 1000);
    }

    
      // ===== step-–ø—Ä–∞–∫—Ç–∏–∫–∏ (–ø–æ—à–∞–≥–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏, –±–µ–∑ —Ç–∞–π–º–µ—Ä–∞)
      function showStep() {
        const { cfg } = state;
        if (!state.running) return;
    
        if (state.step >= cfg.steps.length) {
          setPhase("–ì–æ—Ç–æ–≤–æ!");
          setTime("");             // –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–∏—Ñ—Ä—ã
          setHint("–í—ã –º–æ–ª–æ–¥–µ—Ü ‚ú®");
          setRing(360);
          return;
        }
    
        setPhase(`–®–∞–≥ ${state.step + 1}/${cfg.steps.length}`);
        setHint(cfg.steps[state.step]);
        setRing(0);
    
        // –ö–Ω–æ–ø–∫–∞ ¬´–î–∞–ª–µ–µ/–ó–∞–≤–µ—Ä—à–∏—Ç—å¬ª
        const startBtn = byId('therapyStartBtn');
        startBtn.textContent = (state.step < cfg.steps.length - 1) ? "–î–∞–ª–µ–µ" : "–ó–∞–≤–µ—Ä—à–∏—Ç—å";
        startBtn.onclick = () => { state.step++; showStep(); };
      }
    
      // ===== helpers (UI)
      function setPhase(t){ setText('thermoPhase', t); }
      function setTime(v){  setText('thermoTime', v === "" ? "" : String(v).padStart(2,"0")); }
      function setHint(t){  setText('therapyHint', t || ""); }
      function setRing(deg){
        const ring = byId('thermoRing'); if (!ring) return;
        const brand = getComputedStyle(document.documentElement).getPropertyValue("--brand").trim();
        ring.style.background = `conic-gradient(${brand} ${deg}deg, rgba(0,0,0,0.08) 0)`;
      }
      function setTimeVisible(show){
        const el = byId('thermoTime');
        if (el) el.style.display = show ? '' : 'none';
      }
      function setText(id, txt){ const el = byId(id); if (el) el.textContent = txt; }
      function byId(id){ return document.getElementById(id); }
    
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
      window.closeTherapy = function(){
        stop();
        state = null;
        if (typeof window.closeModal === 'function') {
          window.closeModal('#therapy-modal');
        }
      };

      const therapyModalEl = document.getElementById('therapy-modal');
      therapyModalEl?.addEventListener('modal:close', () => {
        stop();
        state = null;
      });
    })();
            
    </script>

    
    <script>
    window.TESTS = [
      {
        id: "phq2",
        title: "PHQ-2 (—Å–∫—Ä–∏–Ω–∏–Ω–≥ –¥–µ–ø—Ä–µ—Å—Å–∏–∏)",
        description: "2 –≤–æ–ø—Ä–æ—Å–∞, ~30 —Å–µ–∫. –ù–µ –∑–∞–º–µ–Ω—è–µ—Ç –¥–∏–∞–≥–Ω–æ–∑.",
        scale: [ "–ù–∏–∫–æ–≥–¥–∞", "–ù–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π", "–ë–æ–ª–µ–µ –ø–æ–ª–æ–≤–∏–Ω—ã –¥–Ω–µ–π", "–ü–æ—á—Ç–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å" ],
        questions: [
          "–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏ ‚Äî –º–∞–ª–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞ –∏–ª–∏ —Ä–∞–¥–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, —á—Ç–æ –≤—ã –¥–µ–ª–∞–µ—Ç–µ?",
          "–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏ ‚Äî –ø–æ–¥–∞–≤–ª–µ–Ω–Ω–æ–µ, —É–≥–Ω–µ—Ç—ë–Ω–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ?"
        ],
        scoring: { 0:0, 1:1, 2:2, 3:3 },
        resultText(score){ return score >= 3 ? "–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–Ω–∏–Ω–≥ (–æ–±—Å—É–¥–∏—Ç–µ —Å –≤—Ä–∞—á–æ–º)." : "–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–Ω–∏–Ω–≥."; }
      },
      {
        id: "gad2",
        title: "GAD-2 (—Å–∫—Ä–∏–Ω–∏–Ω–≥ —Ç—Ä–µ–≤–æ–≥–∏)",
        description: "2 –≤–æ–ø—Ä–æ—Å–∞, ~30 —Å–µ–∫. –ù–µ –∑–∞–º–µ–Ω—è–µ—Ç –¥–∏–∞–≥–Ω–æ–∑.",
        scale: [ "–ù–∏–∫–æ–≥–¥–∞", "–ù–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π", "–ë–æ–ª–µ–µ –ø–æ–ª–æ–≤–∏–Ω—ã –¥–Ω–µ–π", "–ü–æ—á—Ç–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å" ],
        questions: [
          "–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏ ‚Äî –æ—â—É—â–µ–Ω–∏–µ –Ω–µ—Ä–≤–æ–∑–Ω–æ—Å—Ç–∏, —Ç—Ä–µ–≤–æ–≥–∏ –∏–ª–∏ –Ω–∞–ø—Ä—è–∂—ë–Ω–Ω–æ—Å—Ç–∏?",
          "–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏ ‚Äî —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ –≤ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∏–ª–∏ –∫–æ–Ω—Ç—Ä–æ–ª–µ –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏–π?"
        ],
        scoring: { 0:0, 1:1, 2:2, 3:3 },
        resultText(score){ return score >= 3 ? "–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–Ω–∏–Ω–≥ (–æ–±—Å—É–¥–∏—Ç–µ —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º)." : "–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–Ω–∏–Ω–≥."; }
      }
    ];
    </script>

    <script>
    (function(){
      window.TestEngine = {
        openById(id){
          const cfg = (window.TESTS || []).find(t => t.id === id);
          if (!cfg) { console.warn('[test] not found', id); return; }
          render(cfg);
        }
      };
    
      function render(cfg){
        setText('testTitle', cfg.title || '–¢–µ—Å—Ç');
        setText('testDesc',  cfg.description || '');
        const host = byId('testFormHost'); host.innerHTML = '';
        cfg.questions.forEach((q, qi) => {
          const block = document.createElement('div');
          block.className = 'card test-card';
          block.innerHTML = `
            <div class="test-question">${q}</div>
            <div class="test-options">
              ${cfg.scale.map((opt, oi) => `
                <label style="display:flex; gap:8px; align-items:center;">
                  <input type="radio" name="q${qi}" value="${oi}">
                  <span>${opt}</span>
                </label>`).join('')}
            </div>`;
          host.appendChild(block);
        });
        byId('testSubmitBtn').onclick = () => submit(cfg);
        byId('testCancelBtn').onclick = closeTest;
        if (typeof window.openModal === 'function') {
          window.openModal('#test-modal');
        }
      }
    
      function submit(cfg){
        let sum = 0, answered = 0;
        cfg.questions.forEach((_, qi) => {
          const v = document.querySelector(`input[name="q${qi}"]:checked`)?.value;
          if (v != null) { answered++; sum += (cfg.scoring?.[v] ?? 0); }
        });
        if (answered < cfg.questions.length) { alert('–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã.'); return; }
        const result = (typeof cfg.resultText === 'function') ? cfg.resultText(sum) : `–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${sum}`;
        alert(`${cfg.title}\n–°—É–º–º–∞ –±–∞–ª–ª–æ–≤: ${sum}\n${result}`);
        closeTest();
      }
    
      function setText(id, txt){ const el = byId(id); if (el) el.textContent = txt; }
      function byId(id){ return document.getElementById(id); }
      window.closeTest = function(){
        if (typeof window.closeModal === 'function') {
          window.closeModal('#test-modal');
        }
      };

      document.getElementById('test-modal')?.addEventListener('modal:close', () => {
        const host = byId('testFormHost');
        if (host) host.innerHTML = '';
      });
    })();
    </script>

    <!-- –î–û–õ–ñ–ï–ù –∏–¥—Ç–∏ –ø–µ—Ä–≤—ã–º, –±–µ–∑ defer, —á—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ -->
    <script src="/scripts/safe-prelude.js"></script>

    <script src="/scripts/palette.global.js?v=__BUILD_ID__" defer></script>
    <script src="/scripts/utils.js?v=__BUILD_ID__" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js" defer></script>

    <script>

        // –ù–µ—Ä–∞–∑—Ä—É—à–∞—é—â–µ–µ –Ω–∞–≤–µ—à–∏–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤-—Ö—É–∫–æ–≤ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        (function wireCalendarClasses() {
          const root = document.getElementById('calendar') || document.querySelector('.calendar');
          if (!root) return;

          root.classList.add('calendar');

          const weekdays = root.querySelector('.weeknames, .weekdays, [data-weekdays]');
          if (weekdays) weekdays.classList.add('weekdays');

          const grid =
            root.querySelector('.days, .month-grid, .grid, [data-days]') ||
            root.querySelector('ul.days, table tbody');
          if (grid) grid.classList.add('month-grid');

          root.querySelectorAll('.day, .date, .cell, [data-day]').forEach((el) => el.classList.add('day'));
        })();

        // –µ–¥–∏–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –º–æ–¥–∞–ª–æ–∫
        (function modalController(){
          function openModal(sel) {
            const el = typeof sel === 'string' ? document.querySelector(sel) : sel;
            if (!el) return;
            const wasHidden = el.hidden !== false;
            el.hidden = false;
            el.setAttribute('aria-hidden', 'false');
            if (wasHidden) {
              el.dispatchEvent(new CustomEvent('modal:open'));
            }
          }
          function closeModal(sel) {
            const el = typeof sel === 'string' ? document.querySelector(sel) : sel;
            if (!el) return;
            const wasHidden = el.hidden === false;
            el.hidden = true;
            el.setAttribute('aria-hidden', 'true');
            if (wasHidden) {
              el.dispatchEvent(new CustomEvent('modal:close'));
            }
          }
          document.addEventListener('click', (e) => {
            const openBtn = e.target.closest('[data-open-modal]');
            if (openBtn) { e.preventDefault(); openModal(openBtn.getAttribute('data-open-modal')); return; }
            const closeBtn = e.target.closest('[data-close-modal]');
            if (closeBtn) { e.preventDefault(); closeModal(closeBtn.closest('.modal')); return; }
            const backdrop = e.target.closest('.modal__backdrop');
            if (backdrop) { closeModal(backdrop.parentElement); }
          });
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
              const top = document.querySelector('.modal:not([hidden])');
              if (top) closeModal(top);
            }
          });
          // —ç–∫—Å–ø–æ—Ä—Ç (–µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –≤—ã–∑—ã–≤–∞–µ—à—å –Ω–∞–ø—Ä—è–º—É—é)
          window.openModal = openModal;
          window.closeModal = closeModal;
        })();

        // Application state
        let currentDate = new Date();
        let selectedDate = new Date();
        let moodData = {};
        let dailyMoods = {};
        let currentPage = 'calendar';
        let dailyScores = {};
        let dailyTotals = {};
        const DAILY_MIN = -50;
        const DAILY_MAX = 50;
        
        function bucketFromTotal(total) {
          if (!Number.isFinite(total)) return null;
          if (total === 0) return 'zero';

          const steps = [10, 20, 30, 40, 50];
          const abs = Math.min(50, Math.abs(Math.round(total)));
          let step = 10;
          for (const candidate of steps) {
            if (abs >= candidate) {
              step = candidate;
            } else {
              break;
            }
          }
          return (total > 0 ? 'pos' : 'neg') + step;
        }

        function paintDayByTotal(cell, entriesForThisDay) {
          const entries = Array.isArray(entriesForThisDay) ? entriesForThisDay : [];

          cell.classList.remove('day--pos', 'day--neg', 'day--zero', 'is-neutral', 'has-mood');
          delete cell.dataset.total;
          delete cell.dataset.score;
          delete cell.dataset.mood;
          delete cell.dataset.bucket;

          cell.style.removeProperty('background');
          cell.style.removeProperty('background-color');
          cell.style.removeProperty('background-image');
          cell.style.removeProperty('color');

          if (!entries.length) {
            cell.removeAttribute('data-bucket');
            return null;
          }

          const total = entries.reduce((acc, entry) => acc + (Number(entry?.score) || 0), 0);

          cell.classList.add('has-mood');
          cell.dataset.total = String(total);
          cell.dataset.score = String(total);

          const bucket = bucketFromTotal(total);
          if (bucket) {
            cell.dataset.bucket = bucket;
          } else {
            cell.removeAttribute('data-bucket');
          }

          if (total > 0) {
            cell.classList.add('day--pos');
          } else if (total < 0) {
            cell.classList.add('day--neg');
          } else {
            cell.classList.add('day--zero', 'is-neutral');
          }

          return bucket;
        }

        // Mood types
        const moodTypes = {
            // –°—Ç–∞—Ä—ã–µ –∫–ª—é—á–∏ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏). good ‚Üí positive, neutral ‚Üí neutral, sad ‚Üí –ø–µ—á–∞–ª—å
            good:    { name: '–•–æ—Ä–æ—à–µ–µ' },
            neutral: { name: '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ' },
            sad:     { name: '–ü–µ—á–∞–ª—å–Ω–æ–µ' },
            // –ù–æ–≤–∞—è —à–∫–∞–ª–∞ –∏–∑ 5 –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π
            happy:   { name: '–û—á–µ–Ω—å —Ö–æ—Ä–æ—à–µ–µ' },
            pleased: { name: '–•–æ—Ä–æ—à–µ–µ' },
            sorrow:  { name: '–û—á–µ–Ω—å –≥—Ä—É—Å—Ç–Ω–æ–µ' }
        };

        const monthNames = [
            '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
            '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
        ];

        // Initialize app
         // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
         if (typeof runMigrationsIfNeeded === 'function') {
           await runMigrationsIfNeeded();   // ‚Üê –¥–æ–±–∞–≤–∏–ª–∏
         }
          setupThemeToggle();
          loadData();
          updateCalendar();
          renderTodayScore();
          checkNotificationPermission();
          scheduleNotifications();
          switchPage('calendar');
          (document.getElementById('openMoodModalBtn') || document.getElementById('recordMoodBtn'))?.addEventListener('click', openMoodSlider);
          const prevMonthBtn = document.getElementById('prevMonthBtn') || document.getElementById('prevMonth');
          if (prevMonthBtn) {
            prevMonthBtn.addEventListener('click', (event) => {
              event.preventDefault();
              navigateMonth(-1);
            });
          }
          const nextMonthBtn = document.getElementById('nextMonthBtn') || document.getElementById('nextMonth');
          if (nextMonthBtn) {
            nextMonthBtn.addEventListener('click', (event) => {
              event.preventDefault();
              navigateMonth(1);
            });
          }

          setupChatInput();
          maybeProactiveChat();
          if (typeof enableStatsSwipe === 'function') {
            enableStatsSwipe(document.getElementById('stats-modal'));
          }
        });

         // Theme management
         function applyTheme(theme) {
          const t = theme === 'dark' ? 'dark' : 'light';
          window.setTheme(t);
          const btn = document.getElementById('themeToggle');
          if (btn) {
            btn.setAttribute('aria-pressed', String(t === 'dark'));
          }
        }

        function toggleTheme() {
          const current = typeof window.getTheme === 'function'
            ? window.getTheme()
            : (document.documentElement.getAttribute('data-theme') || 'light');
          applyTheme(current === 'light' ? 'dark' : 'light');
        }

        function setupThemeToggle(){
          const btn = document.getElementById('themeToggle');
          if (!btn) return;
          btn.addEventListener('click', toggleTheme);
          const current = typeof window.getTheme === 'function'
            ? window.getTheme()
            : (document.documentElement.getAttribute('data-theme') || 'light');
          btn.setAttribute('aria-pressed', String(current === 'dark'));
        }

        (function bootTheme(){
          const legacy = localStorage.getItem('moodCalendarTheme');
          if (legacy === 'light' || legacy === 'dark') {
            localStorage.setItem('theme', legacy);
            localStorage.removeItem('moodCalendarTheme');
          }

          const saved = localStorage.getItem('theme');
          applyTheme(saved === 'dark' ? 'dark' : 'light');
        })();

        function switchPage(page) {
          currentPage = page;

          // —Å—Ç—Ä–∞–Ω–∏—Ü—ã
          const calendarPage = document.getElementById('calendarPage');
          const chatPage     = document.getElementById('chatPage');
          const helpPage     = document.getElementById('helpPage');
          const therapyPage  = document.getElementById('therapyPage');
          const testsPage    = document.getElementById('testsPage');
        
          // –Ω–∞–≤–∏–≥–∞—Ü–∏—è
          const navCalendar  = document.getElementById('navCalendar');
          const navChat      = document.getElementById('navChat');
          const navHelp      = document.getElementById('navHelp');
        
          // CTA
          const cta = document.querySelector('.calendar-cta');
        
          // 1) –°–∫—Ä—ã—Ç—å –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–∏ —Å–Ω—è—Ç—å —Å–ø–µ—Ü-–∫–ª–∞—Å—Å —É —á–∞—Ç–∞)
          [calendarPage, chatPage, helpPage, therapyPage, testsPage].forEach(el => {
            if (el) el.style.display = 'none';
          });
          chatPage?.classList.remove('active');
        
          // 2) –°–±—Ä–æ—Å–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É –≤—Å–µ—Ö —Ç–∞–±–æ–≤
          [navCalendar, navChat, navHelp].forEach(el => el?.classList.remove('active'));
        
          // 3) –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É + –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å CTA –∏ –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–±
          if (page === 'calendar') {
            calendarPage && (calendarPage.style.display = 'block');
            cta && (cta.style.display = 'flex');
            navCalendar?.classList.add('active');
          } else if (page === 'chat') {
            chatPage && (chatPage.style.display = 'flex');
            chatPage?.classList.add('active');                 // –≤–µ—Ä–Ω—É—Ç—å –∫–ª–∞—Å—Å –¥–ª—è —Ç–≤–æ–∏—Ö CSS
            cta && (cta.style.display = 'none');
            navChat?.classList.add('active');
            setTimeout(() => document.getElementById('chatInput')?.focus(), 100);
          } else if (page === 'help') {
            helpPage && (helpPage.style.display = 'block');
            cta && (cta.style.display = 'none');
            navHelp?.classList.add('active');
          } else if (page === 'therapy') {
            therapyPage && (therapyPage.style.display = 'block');
            cta && (cta.style.display = 'none');
            navHelp?.classList.add('active');
          } else if (page === 'tests') {
            testsPage && (testsPage.style.display = 'block');
            cta && (cta.style.display = 'none');
            navHelp?.classList.add('active');
          }
        
          // 4) –§–ª–∞–≥ –Ω–∞ body ‚Äî –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –≤ —Å—Ç–∏–ª—è—Ö
          document.body.classList.toggle('on-calendar', page === 'calendar');
        }



        function autoResize(ta, max = 160) {
          ta.style.height = 'auto';
          ta.style.height = Math.min(ta.scrollHeight, max) + 'px';
        }

        // Chat functionality
        function setupChatInput() {
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            if (!chatInput || !sendButton) return;
            autoResize(chatInput);
            chatInput.addEventListener('input', function () {
                autoResize(this);                      
                sendButton.disabled = !this.value.trim();
            });
            chatInput.addEventListener('focus', function () {
                autoResize(this);
            });
            chatInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                  e.preventDefault();
                  sendMessage();
                }
            });
        }
        
        const isLocal = ['localhost', '127.0.0.1'].includes(location.hostname) || location.hostname === '';
        const isVercel = location.hostname.endsWith('.vercel.app');
        
        const API_BASE = (isLocal || isVercel)
          ? '' // –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å => /api/chat
          : 'https://mood-calendar-omega.vercel.app'; // –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å GitHub Pages
        
        async function askAI(userText) {
          const summary = getMoodSummary(14);
          const payload = {
            messages: [
              { role: 'system', content:
                '–¢—ã –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫. –ì–æ–≤–æ—Ä–∏ –∫—Ä–∞—Ç–∫–æ, —ç–º–ø–∞—Ç–∏—á–Ω–æ, –±–µ–∑ –¥–∏–∞–≥–Ω–æ–∑–æ–≤. ' +
                '–ü—Ä–µ–¥–ª–∞–≥–∞–π –ø—Ä–æ—Å—Ç—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ (–¥—ã—Ö–∞–Ω–∏–µ 4-7-8, –ø—Ä–æ–≥—É–ª–∫–∞, –∑–∞–ø–∏—Å—å –º—ã—Å–ª–µ–π, –ø–µ—Ä–µ–æ—Ü–µ–Ω–∫–∞). ' +
                '–ï—Å–ª–∏ –µ—Å—Ç—å —Ä–∏—Å–∫ —Å–µ–±–µ/–¥—Ä—É–≥–∏–º ‚Äî –º—è–≥–∫–æ –¥–∞–π –∫–æ–Ω—Ç–∞–∫—Ç—ã —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π –ø–æ–º–æ—â–∏ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.'
              },
              { role: 'assistant', content:
                `–ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö ${summary.daysConsidered} –¥–Ω–µ–π: —Ö–æ—Ä–æ—à–∏–µ=${summary.counts.good}, –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ=${summary.counts.neutral}, –≥—Ä—É—Å—Ç–Ω—ã–µ=${summary.counts.sad}.`
              },
              { role: 'user', content: userText }
            ]
          };
        
          const res = await fetch(`${API_BASE}/api/chat`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
        
          if (!res.ok) throw new Error(await res.text());
          const data = await res.json();
          return (data.reply || '').trim();
        }

        function sendMessage() {
          const chatInput = document.getElementById('chatInput');
          const sendBtn   = document.getElementById('sendButton');
          const message   = chatInput.value.trim();
        
          // 1) –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–µ
          if (!message) return;
        
          // 2) –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          addMessage('user', message);
        
          // 3) —á–∏—Å—Ç–∏–º –ø–æ–ª–µ –∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
          chatInput.value = '';
          chatInput.style.height = 'auto';
          sendBtn.disabled = true;
        
          // 4) –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
          showTypingIndicator();
        
          // 5) –∑–∞–ø—Ä–æ—Å –∫ –ò–ò
          askAI(message)
            .then(reply => {
              addMessage('ai', reply || '–ò–∑–≤–∏–Ω–∏, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç.');
            })
            .catch(err => {
              console.error(err);
              addMessage('ai', '–ü–æ—Ö–æ–∂–µ, —Å–µ—Ä–≤–∏—Å –∑–∞–Ω—è—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ —á—É—Ç—å –ø–æ–∑–∂–µ üôè');
            })
            .finally(() => {
              // 6) –≤—Å–µ–≥–¥–∞ —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä, —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å
              hideTypingIndicator();
              sendBtn.disabled = false;
              chatInput.focus();
            });
        }
        
        function startPractice(code){
          if (code === '478') {
            alert('–î—ã—Ö–∞–Ω–∏–µ 4‚Äì7‚Äì8: –≤–¥–æ—Ö 4 —Å–µ–∫ ‚Üí –∑–∞–¥–µ—Ä–∂–∫–∞ 7 ‚Üí –≤—ã–¥–æ—Ö 8. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ 4‚Äì6 —Ä–∞–∑.');
          } else if (code === '54321') {
            alert('–ó–∞–∑–µ–º–ª–µ–Ω–∏–µ 5-4-3-2-1: 5 –≤–∏–∂—É, 4 –æ—â—É—â–∞—é, 3 —Å–ª—ã—à—É, 2 –Ω—é—Ö–∞—é, 1 –ø—Ä–æ–±—É—é.');
          }
        }
        
        function openTest(name){
          if (name === 'phq2') {
            // —Ç—É—Ç –ø–æ—Ç–æ–º –≤—Å—Ç–∞–≤–∏–º —Ñ–æ—Ä–º—É/–ø–æ–¥—Å—á—ë—Ç –±–∞–ª–ª–æ–≤
            alert('PHQ-2: –¥–∞–ª—å—à–µ –¥–æ–±–∞–≤–∏–º —Ñ–æ—Ä–º—É —Å 2 –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –ª–æ–≥–∏–∫–æ–π –ø–æ–¥—Å—á—ë—Ç–∞.');
          } else if (name === 'gad2') {
            alert('GAD-2: –¥–∞–ª—å—à–µ –¥–æ–±–∞–≤–∏–º —Ñ–æ—Ä–º—É —Å 2 –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –ª–æ–≥–∏–∫–æ–π –ø–æ–¥—Å—á—ë—Ç–∞.');
          }
        }


        function addMessage(sender, text) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = text;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.textContent = '–ò–ò –ø–µ—á–∞—Ç–∞–µ—Ç...';
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

       // Stats functionality
        function openStats(){
          if (typeof window.openModal === 'function') {
            window.openModal('#stats-modal');
          }
        }
        function closeStats(){
          if (typeof window.closeModal === 'function') {
            window.closeModal('#stats-modal');
          }
        }

        window.addEventListener('resize', () => {
          const modal = document.getElementById('stats-modal');
          if (modal && !modal.hasAttribute('hidden') && typeof window.renderTodayHourlyChart === 'function') {
            window.renderTodayHourlyChart();
          }
        });

        // Notification functions
        function checkNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                document.getElementById('installPrompt').classList.remove('hidden');
            }
        }

        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    document.getElementById('installPrompt').classList.add('hidden');
                    new Notification('–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è', {
                        body: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã! –ú—ã –±—É–¥–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ.',
                        tag: 'mood-setup'
                    });
                    scheduleNotifications();
                }
            }
        }

        function scheduleNotifications() {
            if ('Notification' in window && Notification.permission === 'granted') {
                setInterval(showNotification, 60 * 1000);
            }
        }

        function showNotification() {
            if ('Notification' in window && Notification.permission === 'granted') {
                const now = new Date();
                const hour = now.getHours();
                const minute = now.getMinutes();
                
                const notificationTimes = [9, 15, 21];
                
                if (notificationTimes.includes(hour) && minute === 0) {
                    const timeOfDay = hour === 9 ? '–£—Ç—Ä–æ' : hour === 15 ? '–î–µ–Ω—å' : '–í–µ—á–µ—Ä';
                    const notification = new Notification(`${timeOfDay}: –í—Ä–µ–º—è –∑–∞–ø–∏—Å–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ! üòä`, {
                        body: '–ö–∞–∫ –≤—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—Ç–µ —Å–µ–π—á–∞—Å?',
                        tag: 'mood-reminder'
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        openMoodSlider();
                        notification.close();
                    };
                }
            }
        }
      
        const SCHEMA_KEY = 'moodSchemaVersion';
        const CURRENT_SCHEMA_VERSION = 3;
        
        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ JSON-—Ö–µ–ª–ø–µ—Ä—ã
        function getJson(key, fallback = null) {
          try {
            const raw = localStorage.getItem(key);
            return raw ? JSON.parse(raw) : fallback;
          } catch (e) {
            console.warn('[storage] broken JSON in', key, e);
            return fallback;
          }
        }
        function setJson(key, value) {
          localStorage.setItem(key, JSON.stringify(value));
        }
        
      
        const MIGRATIONS = [
          {
            version: 1,
            name: 'Normalize moodData to array-of-entries',
            run() {
              const raw = getJson('moodData', {});
              const normalized = {};
        
              Object.keys(raw || {}).forEach(dateKey => {
                const day = raw[dateKey];
        
                if (Array.isArray(day)) {
                  normalized[dateKey] = day; 
                  return;
                }
        
             
                const arr = [];
                if (day && typeof day === 'object') {
                  Object.keys(day).forEach(h => {
                    const hour = parseInt(h, 10);
                    arr.push({
                      hour,
                      minute: 0,
                      mood: day[h],
                      timestamp: new Date(`${dateKey}T${String(hour).padStart(2,'0')}:00:00`).getTime()
                    });
                  });
                }
                normalized[dateKey] = arr.sort((a,b) => a.timestamp - b.timestamp);
              });
        
              setJson('moodData', normalized);
            }
          },
          {
            version: 2,
            name: 'Recompute dailyMoods from moodData',
            run() {
              const md = getJson('moodData', {});
              const dm = {};
        
              Object.keys(md || {}).forEach(k => {
                const entries = md[k] || [];
                if (!entries.length) return;
                const counts = entries.reduce((acc, e) => {
                  acc[e.mood] = (acc[e.mood] || 0) + 1;
                  return acc;
                }, {});
                const dominant = Object.keys(counts).reduce((a,b) => counts[a] >= counts[b] ? a : b);
                dm[k] = dominant;
              });
        
              setJson('dailyMoods', dm);
            }
          },
          {
            version: 3,
            name: 'Ensure chat history key and cap length',
            run() {
              // –ø–µ—Ä–µ–Ω–æ—Å–∏–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ç–∞—Ä—ã–µ –∫–ª—é—á–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –∏—Å—Ç–æ—Ä–∏–∏
              const legacy = getJson('chat') ?? getJson('chatMessages', []);
              const arr = Array.isArray(legacy) ? legacy : [];
              setJson('chatMessages', arr.slice(-100));
              localStorage.removeItem('chat'); // —á–∏—Å—Ç–∏–º —Å—Ç–∞—Ä–æ–µ –∏–º—è –∫–ª—é—á–∞, –µ—Å–ª–∏ –±—ã–ª–æ
            }
          }
        ];
        
        async function runMigrationsIfNeeded() {
          let current = parseInt(localStorage.getItem(SCHEMA_KEY) || '0', 10);
        
          for (const m of MIGRATIONS) {
            if (m.version > current) {
              try {
                console.info(`[migrate] -> v${m.version}: ${m.name}`);
                await Promise.resolve(m.run());
                localStorage.setItem(SCHEMA_KEY, String(m.version));
                current = m.version;
              } catch (e) {
                console.error('[migrate] failed', m.version, m.name, e);
                break; // –æ—Å—Ç–∞–Ω–æ–≤–∏–º —Ü–µ–ø–æ—á–∫—É, —á—Ç–æ–±—ã –Ω–µ —É—Å—É–≥—É–±–ª—è—Ç—å
              }
            }
          }
        }
       
       function loadData() {
          try {
            moodData   = getJson('moodData', {}) || {};
            dailyMoods = getJson('dailyMoods', {}) || {};
            dailyScores = getJson('dailyScores', {}) || {};
            dailyTotals = getJson('dailyTotals', {}) || {};

            if (!dailyTotals || typeof dailyTotals !== 'object') {
              dailyTotals = {};
            }

            const clampTotal = (value) => Math.max(DAILY_MIN, Math.min(DAILY_MAX, value));
            const ensureScore = (entry) => {
              if (typeof entry?.score === 'number') return entry.score;
              switch (entry?.mood) {
                case 'happy': return 3;
                case 'pleased': return 2;
                case 'neutral': return 0;
                case 'sad': return -2;
                case 'sorrow': return -3;
                default: return 0;
              }
            };

            Object.keys(moodData || {}).forEach((key) => {
              const entries = Array.isArray(moodData[key]) ? moodData[key] : [];
              if (!entries.length) return;

              const computedSum = entries.reduce((sum, entry) => sum + ensureScore(entry), 0);
              if (typeof dailyTotals[key] !== 'number') {
                dailyTotals[key] = clampTotal(computedSum);
              } else {
                dailyTotals[key] = clampTotal(dailyTotals[key]);
              }

              dailyScores[key] = entries.length ? computedSum / entries.length : 0;
            });
          }
          catch (e) {
            console.log('Error loading data:', e);
            moodData = {};
            dailyMoods = {};
            dailyTotals = {};
          }
        }

        function saveData() {
            try {
                localStorage.setItem('moodData', JSON.stringify(moodData));
                localStorage.setItem('dailyMoods', JSON.stringify(dailyMoods));
                localStorage.setItem('dailyScores', JSON.stringify(dailyScores));
                localStorage.setItem('dailyTotals', JSON.stringify(dailyTotals));
            } catch (e) {
                console.log('Error saving data:', e);
            }
        }

        function getDateKey(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getEntriesForDate(year, monthIndex, dayOfMonth) {
          const lookup = new Date(year, monthIndex, dayOfMonth);
          lookup.setHours(0, 0, 0, 0);
          const key = getDateKey(lookup);
          const entries = moodData[key];
          return Array.isArray(entries) ? entries : [];
        }

        // AI analysis functions
        function getSadStreak(daysWindow = 10) {
            const today = new Date();
            let streak = 0;
            for (let i = 0; i < daysWindow; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const key = getDateKey(d);
                const mood = dailyMoods[key];
                if (mood === 'sad' || mood === 'sorrow') streak++;
                else break;
            }
            return streak;
        }
        
        function getMoodSummary(days = 14) {
            const today = new Date();
            const counts = { good: 0, neutral: 0, sad: 0 };
            let total = 0;
            
            for (let i = 0; i < days; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const key = getDateKey(d);
                const mood = dailyMoods[key];
                if (mood) {
                    counts[mood]++;
                    total++;
                }
            }
            return { daysConsidered: days, counts, total };
        }

        const SAD_STREAK_THRESHOLD = 3;
        const PROACTIVE_COOLDOWN_DAYS = 3;
        
        function maybeProactiveChat() {
            try {
                const streak = getSadStreak(10);
                const lastAt = localStorage.getItem('aiLastProactiveAt');
                const todayKey = getDateKey(new Date());
        
                if (streak >= SAD_STREAK_THRESHOLD) {
                    if (lastAt) {
                        const last = new Date(lastAt);
                        const diffDays = Math.floor((Date.now() - last.getTime()) / (1000 * 3600 * 24));
                        if (diffDays < PROACTIVE_COOLDOWN_DAYS) return;
                    }
                    localStorage.setItem('aiLastProactiveAt', todayKey);
                    
                    // Switch to chat page and add proactive message
                    switchPage('chat');
                    setTimeout(() => {
                        const intro = `–Ø –∑–∞–º–µ—Ç–∏–ª, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ ${streak} ${streak === 1 ? '–¥–µ–Ω—å' : '–¥–Ω—è'} –≤–∞–º –≥—Ä—É—Å—Ç–Ω–æ. –•–æ—Ç–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏–ª–∏ –ø–∞—Ä—É –ø—Ä–æ—Å—Ç—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫?`;
                        addMessage('ai', intro);
                    }, 500);
                }
            } catch (e) {
                console.log('Error in proactive chat:', e);
            }
        }
       
        // Calendar functions
       function navigateMonth(direction) {
            selectedDate.setMonth(selectedDate.getMonth() + direction);
            updateCalendar();
        }

        function updateCalendar() {
          const monthTitleEl = document.getElementById('monthTitle');
          if (monthTitleEl) {
            monthTitleEl.textContent = `${monthNames[selectedDate.getMonth()]} ${selectedDate.getFullYear()}`;
          }

          const daysGrid = document.getElementById('daysGrid');
          if (!daysGrid) return;
          daysGrid.innerHTML = '';

          const year = selectedDate.getFullYear();
          const month = selectedDate.getMonth();
          const firstDay = new Date(year, month, 1);
          const startDate = new Date(firstDay);
          startDate.setDate(startDate.getDate() - firstDay.getDay());

          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const todayKey = getDateKey(today);

          const totalCells = 42; // 6 weeks * 7 days ensures full grid
          for (let cell = 0; cell < totalCells; cell++) {
            const current = new Date(startDate);
            current.setDate(startDate.getDate() + cell);
            const dateKey = getDateKey(current);
            const isCurrentMonth = current.getMonth() === month;
            const isToday = dateKey === todayKey;

            const dayButton = document.createElement('button');
            dayButton.type = 'button';
            dayButton.className = 'day';
            dayButton.dataset.year = String(current.getFullYear());
            dayButton.dataset.month = String(current.getMonth());
            dayButton.dataset.day = String(current.getDate());
            dayButton.setAttribute('data-day', String(current.getDate()));

            if (!isCurrentMonth) {
              dayButton.classList.add('is-outside', 'other-month');
            }

            const entriesForDay = getEntriesForDate(current.getFullYear(), current.getMonth(), current.getDate());
            const bucket = paintDayByTotal(dayButton, entriesForDay);

            if (isToday) {
              dayButton.classList.add('is-today', 'today');
            }

            const displayMonth = monthNames[current.getMonth()] || '';
            let ariaLabel = `${current.getDate()} ${displayMonth} ${current.getFullYear()}`;
            if (bucket === 'zero') {
              ariaLabel += ', –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ 0';
            } else if (bucket && bucket.startsWith('pos')) {
              ariaLabel += `, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ +${bucket.slice(3)}`;
            } else if (bucket && bucket.startsWith('neg')) {
              ariaLabel += `, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ -${bucket.slice(3)}`;
            } else {
              ariaLabel += ', –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π';
            }
            if (!isCurrentMonth) {
              ariaLabel += ', –¥—Ä—É–≥–æ–π –º–µ—Å—è—Ü';
            }

            dayButton.setAttribute('aria-label', ariaLabel);
            dayButton.textContent = String(current.getDate());

            daysGrid.appendChild(dayButton);
          }

          renderTodayScore();
        }

        function calcTodayStats(entriesToday) {
          const sum = entriesToday.reduce((acc, entry) => acc + (Number(entry?.score) || 0), 0);
          const avg = entriesToday.length ? sum / entriesToday.length : 0;
          return { sum, avg };
        }

        function renderTodayScore() {
          const el = document.getElementById('todayScoreBadge');
          if (!el) return;

          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const key = getDateKey(today);
          const entriesToday = Array.isArray(moodData[key]) ? moodData[key] : [];
          const { sum, avg } = calcTodayStats(entriesToday);

          let varName;
          if      (avg >  2.5) varName = '--score-pos3';
          else if (avg >  0.5) varName = '--score-pos2';
          else if (avg >  0.0) varName = '--score-pos1';
          else if (avg < -2.5) varName = '--score-neg3';
          else if (avg < -0.5) varName = '--score-neg2';
          else if (avg < -0.0) varName = '--score-neg1';
          else                  varName = '--yellow';

          el.style.setProperty('--today-color', `var(${varName})`);

          const darkText = (varName === '--yellow');
          el.style.color = darkText ? '#111' : '#fff';

          const DAILY_LIMIT = typeof DAILY_MAX === 'number' ? DAILY_MAX : 50;
          let sumRounded = Math.round(sum * 10) / 10;
          if (!Number.isFinite(sumRounded)) sumRounded = 0;
          const sumPretty = sumRounded > 0 ? `+${sumRounded}` : `${sumRounded === 0 ? 0 : sumRounded}`;

          const valueEl = document.getElementById('todayScoreValue');
          const limitEl = document.getElementById('todayScoreLimit');
          if (valueEl) {
            valueEl.textContent = sumPretty;
          }
          if (limitEl) {
            limitEl.textContent = String(DAILY_LIMIT);
          }
          if (!valueEl || !limitEl) {
            el.textContent = `–°–µ–≥–æ–¥–Ω—è: ${sumPretty} / ${DAILY_LIMIT}`;
          }
          el.classList.remove('hidden');
        }

        function pingTodayBadge() {
          const el = document.getElementById('todayScoreBadge');
          if (!el) return;
          el.animate([
            { transform: 'scale(1)' },
            { transform: 'scale(1.06)' },
            { transform: 'scale(1)' }
          ], { duration: 220, easing: 'ease-out' });
        }

        function showInfo(text) {
          alert(text);
        }

        function updateSliderGlow() {
          const el = document.getElementById('moodSlider');
          if (!el) return;
          const val = parseInt(el.value, 10) || 0;      // -5..+5
          const ratio = Math.min(Math.abs(val) / 5, 1); // 0..1
          const sizePx = 3 + Math.round(7 * ratio);     // 3..10

          // —Ç–µ–ø–µ—Ä—å: —Å–ª–µ–≤–∞ (val < 0) ‚Äî –°–ò–ù–ò–ô, —Å–ø—Ä–∞–≤–∞ (val > 0) ‚Äî –ó–ï–õ–Å–ù–´–ô
          let color = 'rgba(0,0,0,0)';
          if (val < 0) color = getComputedStyle(document.documentElement).getPropertyValue('--thumb-neg').trim() || 'rgba(29,78,216,.45)';
          if (val > 0) color = getComputedStyle(document.documentElement).getPropertyValue('--thumb-pos').trim() || 'rgba(22,163,74,.45)';

          el.style.setProperty('--thumb-glow', color);
          el.style.setProperty('--glow-size', sizePx + 'px');
        }

        function pingSliderThumbOnce() {
          const slider = document.getElementById('moodSlider');
          if (!slider) return;

          slider.animate([
            { transform: 'scale(1)' },
            { transform: 'scale(1.05)' },
            { transform: 'scale(1)' }
          ], { duration: 180, easing: 'ease-out' });
        }

        // –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ —Å–ª–∞–π–¥–µ—Ä–æ–º
        function openMoodSlider() {
          const slider = document.getElementById('moodSlider');
          if (slider) {
            slider.value = 0;
            slider.removeEventListener('input', updateSliderGlow);
            slider.addEventListener('input', updateSliderGlow);
            updateSliderGlow();
          }
          if (typeof window.openModal === 'function') {
            window.openModal('#mood-modal');
          }
        }

        // –∑–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ —Å–ª–∞–π–¥–µ—Ä–æ–º
        function closeMoodSlider() {
          if (typeof window.closeModal === 'function') {
            window.closeModal('#mood-modal');
          }
        }

        // —Å—á–∏—Ç–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ —Å–ª–∞–π–¥–µ—Ä–∞ –∏ –∑–∞–ø–∏—Å–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
        function confirmMoodScore() {
          const slider = document.getElementById('moodSlider');
          const raw = slider ? parseInt(slider.value, 10) : 0;
          const delta = raw;               // –ü–õ–Æ–° —Å–ø—Ä–∞–≤–∞, –ú–ò–ù–£–° —Å–ª–µ–≤–∞
          recordScore(delta);
          pingSliderThumbOnce && pingSliderThumbOnce();
          closeMoodSlider();
        }
        
        /**
         * –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–ø–∏—Å—å —Å–æ score, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –∑–∞ –¥–µ–Ω—å,
         */
       function recordScore(delta) {
          const now = new Date();
          const dateKey = getDateKey(now);
          const hour = now.getHours();
          const minute = now.getMinutes();
          const timestamp = now.getTime();

          const mood = delta >= 4 ? 'happy'
                     : delta >= 2 ? 'pleased'
                     : delta <= -4 ? 'sorrow'
                     : delta <= -2 ? 'sad'
                     : 'neutral';
          if (!moodData[dateKey]) moodData[dateKey] = [];
          moodData[dateKey].push({ hour, minute, mood, score: delta, timestamp });

          const current = typeof dailyTotals[dateKey] === 'number' ? dailyTotals[dateKey] : 0;
          const next = current + delta;

          if (next > DAILY_MAX) {
            showInfo('–ú–∞–∫—Å–∏–º—É–º –∑–∞ –¥–µ–Ω—å: +50. –ë–æ–ª—å—à–µ –æ—á–∫–æ–≤ –Ω–µ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è.');
            dailyTotals[dateKey] = DAILY_MAX;
          } else if (next < DAILY_MIN) {
            showInfo('–ú–∏–Ω–∏–º—É–º –∑–∞ –¥–µ–Ω—å: ‚àí50. –ú–µ–Ω—å—à–µ –æ—á–∫–æ–≤ –Ω–µ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è.');
            dailyTotals[dateKey] = DAILY_MIN;
          } else {
            dailyTotals[dateKey] = next;
          }

          dailyMoods[dateKey] =
              dailyTotals[dateKey] >= 10 ? 'happy' :
              dailyTotals[dateKey] >= 1  ? 'pleased' :
              dailyTotals[dateKey] <= -10 ? 'sorrow' :
              dailyTotals[dateKey] <= -1 ? 'sad' :
              'neutral';

          const entries = moodData[dateKey] || [];
          const totalForAverage = entries.reduce((sum, entry) => {
            if (typeof entry.score === 'number') return sum + entry.score;
            return sum;
          }, 0);
          dailyScores[dateKey] = entries.length ? totalForAverage / entries.length : 0;

          saveData();
          // —Å–æ–æ–±—â–∞–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
          document.dispatchEvent(new CustomEvent('stats:data-changed'));
          updateCalendar();
          renderTodayScore();
          pingTodayBadge();
          maybeProactiveChat();
        }
        


        // Add event listener for notifications button
        document.getElementById('enableNotifications').addEventListener('click', requestNotificationPermission);

        Object.assign(window, {
          navigateMonth,
          openMoodSlider,
          closeMoodSlider,
          confirmMoodScore,
          openStats,
          closeStats,
          switchPage,
          sendMessage,
          openTest
        });
    </script>
    <!-- Load core module which defines the global App object with store, bus and navigation helpers -->
    <script src="/app-core.js" defer></script>
</body>
</html>






